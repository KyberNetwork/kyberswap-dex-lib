package l2feecalculator

import (
	"math/big"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/assert"

	"github.com/KyberNetwork/kyberswap-aggregator/internal/pkg/entity"
)

func TestArbitrumL2FeeCalculator_CreateRawTxFromInputData(t *testing.T) {
	testCases := []struct {
		name            string
		encodedSwapData string
		expectedResult  string
		expectErr       error
	}{
		{
			name:            "it should return correct raw transaction",
			encodedSwapData: "0xe21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000c6000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000003cdbb20ea0000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000000000063e0bb42000000000000000000000000000000000000000000000000000000000000096000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000075f610f70ed200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000040cbf622d3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b90b9b1f91a01ea22a182cd84c1e22222e39b415000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd0000000000000000000000005fc53f707c7aacd460a1cd564c06e0f07610fcb70000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000c8cf311c70e030e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000095d9d28606ee55de7667f0f176ebfc3215cfd9c00000000000000000000000004200000000000000000000000000000000000006000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da100000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000427464d9434f99a3d942c60210ee2376166975ce000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000002c4ecdb290026862e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000003cdbb20ea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ef7b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2231363239352e31222c22416d6f756e744f7574555344223a2231363334332e393630323533343837383138222c22526566657272616c223a22222c22466c616773223a332c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2241765936693656494d7951477776767671476d6f41524c5773522f2b45337756737278394650694a6b4a6772705a3376376a32494c584269454a5439746b79443045724b75456a4e446471434375736c6f6b5a594c6a316739686c31374a3432624f334249594b49776754364f484159366c674644725864743653334254462f4d637651566a79486c6c454b5770687432495950665477587454487052392b63576d637461624a6d6c4c425848313450726c2b51736a6f74475855493550347139652f52626c6e4674315a5036545074554d6f376b6c4e36535a4c747052596677664e55365432544143734c5056326870626479727471742f5059692b7750526b3566616847674d43476e5935497a33314f6b71373778496465764d547267335268574c2f2b564562325539754135316374696b74626162756a766d733468783959454e70484c34514d4c6e33484c774d6544396f773d3d227d7d0000000000000000000000000000000000",
			expectedResult:  "f90f15808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90ea4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000c6000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000003cdbb20ea0000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000000000063e0bb42000000000000000000000000000000000000000000000000000000000000096000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000075f610f70ed200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000040cbf622d3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b90b9b1f91a01ea22a182cd84c1e22222e39b415000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd0000000000000000000000005fc53f707c7aacd460a1cd564c06e0f07610fcb70000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000c8cf311c70e030e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000095d9d28606ee55de7667f0f176ebfc3215cfd9c00000000000000000000000004200000000000000000000000000000000000006000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da100000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000427464d9434f99a3d942c60210ee2376166975ce000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000002c4ecdb290026862e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000003cdbb20ea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ef7b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2231363239352e31222c22416d6f756e744f7574555344223a2231363334332e393630323533343837383138222c22526566657272616c223a22222c22466c616773223a332c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2241765936693656494d7951477776767671476d6f41524c5773522f2b45337756737278394650694a6b4a6772705a3376376a32494c584269454a5439746b79443045724b75456a4e446471434375736c6f6b5a594c6a316739686c31374a3432624f334249594b49776754364f484159366c674644725864743653334254462f4d637651566a79486c6c454b5770687432495950665477587454487052392b63576d637461624a6d6c4c425848313450726c2b51736a6f74475855493550347139652f52626c6e4674315a5036545074554d6f376b6c4e36535a4c747052596677664e55365432544143734c5056326870626479727471742f5059692b7750526b3566616847674d43476e5935497a33314f6b71373778496465764d547267335268574c2f2b564562325539754135316374696b74626162756a766d733468783959454e70484c34514d4c6e33484c774d6544396f773d3d227d7d000000000000000000000000000000000083014986a0394c270d6b3494d2023c1e26bddbd67d62863f12ebc0c881c857b3f939245e87a02464dc68a65813d015aa9d6cd9a481c00f60857e6197b4d02d576717c5eddb37",
			expectErr:       nil,
		},
		{
			name:            "it should return correct raw transaction (2)",
			encodedSwapData: "0xabcffc26000000000000000000000000be13e651ff246ac63fa36cad6cd8610b090a6a25000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000604c787c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000000604c787c0000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000000000063e1209400000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001367b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2230222c22416d6f756e744f7574555344223a22313632332e373032343338222c22526566657272616c223a22222c22466c616773223a322c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22655832484c526869687a5739452f5a4a4a6b7179653059664a5965414e6f68784d7477305a327a76377a7147566a36705a4a7a5a45363972425a55704c5a477a627262434452575031514b49783149425a765a69727655543257556959457a334c6b742f506273474439637571594762455270585653714763764533564b42433145416e76496b3748725156504359464762734f536d433968396242773736576743336b2f3531303539413d227d7d00000000000000000000",
			expectedResult:  "f906f5808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90684abcffc26000000000000000000000000be13e651ff246ac63fa36cad6cd8610b090a6a25000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000604c787c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000000604c787c0000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000000000063e1209400000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001367b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2230222c22416d6f756e744f7574555344223a22313632332e373032343338222c22526566657272616c223a22222c22466c616773223a322c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22655832484c526869687a5739452f5a4a4a6b7179653059664a5965414e6f68784d7477305a327a76377a7147566a36705a4a7a5a45363972425a55704c5a477a627262434452575031514b49783149425a765a69727655543257556959457a334c6b742f506273474439637571594762455270585653714763764533564b42433145416e76496b3748725156504359464762734f536d433968396242773736576743336b2f3531303539413d227d7d0000000000000000000083014986a0f9ff4edc0dbe54b8353eceba53dbf6aefd2081bd864537ec2a0e3ce084cfb8e3a041630c5504a3c385c05859554aa495a74931f8095a9e64e58a676768a7fd8e73",
			expectErr:       nil,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			l2FeeArbitrum := NewArbitrumFeeCalculator()
			l2FeeArbitrum.SetParams(&entity.L2Fee{
				L1BaseFee: big.NewInt(16113999481),
			})

			result, err := l2FeeArbitrum.CreateRawTxFromInputData(tc.encodedSwapData)

			assert.ErrorIs(t, tc.expectErr, err)

			assert.Equal(t, tc.expectedResult, common.Bytes2Hex(result))
		})
	}
}

func TestArbitrumL2FeeCalculator_GetL1GasUsed(t *testing.T) {
	testCases := []struct {
		name           string
		rawTx          string
		expectedResult *big.Int
	}{
		{
			name:           "it should return correct value",
			rawTx:          "f90f15808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90ea4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000c6000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000003cdbb20ea0000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000000000063e0bb42000000000000000000000000000000000000000000000000000000000000096000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000075f610f70ed200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000040cbf622d3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b90b9b1f91a01ea22a182cd84c1e22222e39b415000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd0000000000000000000000005fc53f707c7aacd460a1cd564c06e0f07610fcb70000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000c8cf311c70e030e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000095d9d28606ee55de7667f0f176ebfc3215cfd9c00000000000000000000000004200000000000000000000000000000000000006000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da100000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000427464d9434f99a3d942c60210ee2376166975ce000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000002c4ecdb290026862e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000003cdbb20ea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ef7b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2231363239352e31222c22416d6f756e744f7574555344223a2231363334332e393630323533343837383138222c22526566657272616c223a22222c22466c616773223a332c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2241765936693656494d7951477776767671476d6f41524c5773522f2b45337756737278394650694a6b4a6772705a3376376a32494c584269454a5439746b79443045724b75456a4e446471434375736c6f6b5a594c6a316739686c31374a3432624f334249594b49776754364f484159366c674644725864743653334254462f4d637651566a79486c6c454b5770687432495950665477587454487052392b63576d637461624a6d6c4c425848313450726c2b51736a6f74475855493550347139652f52626c6e4674315a5036545074554d6f376b6c4e36535a4c747052596677664e55365432544143734c5056326870626479727471742f5059692b7750526b3566616847674d43476e5935497a33314f6b71373778496465764d547267335268574c2f2b564562325539754135316374696b74626162756a766d733468783959454e70484c34514d4c6e33484c774d6544396f773d3d227d7d000000000000000000000000000000000083014986a0394c270d6b3494d2023c1e26bddbd67d62863f12ebc0c881c857b3f939245e87a02464dc68a65813d015aa9d6cd9a481c00f60857e6197b4d02d576717c5eddb37",
			expectedResult: big.NewInt(61824),
		},
		{
			name:           "it should return correct value (2)",
			rawTx:          "f906f5808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90684abcffc26000000000000000000000000be13e651ff246ac63fa36cad6cd8610b090a6a25000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000604c787c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000000604c787c0000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000000000063e1209400000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001367b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2230222c22416d6f756e744f7574555344223a22313632332e373032343338222c22526566657272616c223a22222c22466c616773223a322c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22655832484c526869687a5739452f5a4a4a6b7179653059664a5965414e6f68784d7477305a327a76377a7147566a36705a4a7a5a45363972425a55704c5a477a627262434452575031514b49783149425a765a69727655543257556959457a334c6b742f506273474439637571594762455270585653714763764533564b42433145416e76496b3748725156504359464762734f536d433968396242773736576743336b2f3531303539413d227d7d0000000000000000000083014986a0f9ff4edc0dbe54b8353eceba53dbf6aefd2081bd864537ec2a0e3ce084cfb8e3a041630c5504a3c385c05859554aa495a74931f8095a9e64e58a676768a7fd8e73",
			expectedResult: big.NewInt(28544),
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			l2FeeArbitrum := NewArbitrumFeeCalculator()
			l2FeeArbitrum.SetParams(&entity.L2Fee{
				L1BaseFee: big.NewInt(16113999481),
			})

			inputData := common.FromHex(tc.rawTx)

			result := l2FeeArbitrum.getL1GasUsed(inputData)

			assert.Equal(t, tc.expectedResult, result)
		})
	}
}

func TestArbitrumL2FeeCalculator_GetL1Fee(t *testing.T) {
	testCases := []struct {
		name           string
		rawTx          string
		expectedResult *big.Int
	}{
		{
			name:           "it should return correct value",
			rawTx:          "f90f15808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90ea4e21fd0e900000000000000000000000000000000000000000000000000000000000000200000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000a600000000000000000000000000000000000000000000000000000000000000c6000000000000000000000000000000000000000000000000000000000000009a0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000003cdbb20ea0000000000000000000000006131b5fae19ea4f9d964eac0408e4408b66337b50000000000000000000000000000000000000000000000000000000063e0bb42000000000000000000000000000000000000000000000000000000000000096000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000005400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000075f610f70ed200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000040cbf622d3000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000b90b9b1f91a01ea22a182cd84c1e22222e39b415000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd0000000000000000000000005fc53f707c7aacd460a1cd564c06e0f07610fcb70000000000000000000000001f32b1c2345538c0c6f582fcb022739c4a194ebb0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000c8cf311c70e030e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd00000000000000000000000095d9d28606ee55de7667f0f176ebfc3215cfd9c00000000000000000000000004200000000000000000000000000000000000006000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da100000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000409e8aa9350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000001d5702c6d7eb30e42a8c94b8db7ea2e8444a37fd000000000000000000000000427464d9434f99a3d942c60210ee2376166975ce000000000000000000000000da10009cbd5d07dd0cecc66161fc93d7c9000da10000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000002c4ecdb290026862e20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000001a000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000008ac7230489e8000000000000000000000000000000000000000000000000000000000003cdbb20ea000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001ef7b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2231363239352e31222c22416d6f756e744f7574555344223a2231363334332e393630323533343837383138222c22526566657272616c223a22222c22466c616773223a332c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a2241765936693656494d7951477776767671476d6f41524c5773522f2b45337756737278394650694a6b4a6772705a3376376a32494c584269454a5439746b79443045724b75456a4e446471434375736c6f6b5a594c6a316739686c31374a3432624f334249594b49776754364f484159366c674644725864743653334254462f4d637651566a79486c6c454b5770687432495950665477587454487052392b63576d637461624a6d6c4c425848313450726c2b51736a6f74475855493550347139652f52626c6e4674315a5036545074554d6f376b6c4e36535a4c747052596677664e55365432544143734c5056326870626479727471742f5059692b7750526b3566616847674d43476e5935497a33314f6b71373778496465764d547267335268574c2f2b564562325539754135316374696b74626162756a766d733468783959454e70484c34514d4c6e33484c774d6544396f773d3d227d7d000000000000000000000000000000000083014986a0394c270d6b3494d2023c1e26bddbd67d62863f12ebc0c881c857b3f939245e87a02464dc68a65813d015aa9d6cd9a481c00f60857e6197b4d02d576717c5eddb37",
			expectedResult: big.NewInt(996231903913344),
		},
		{
			name:           "it should return correct value (2)",
			rawTx:          "f906f5808503c0781e79825208944592d8f8d7b001e72cb26a73e4fa1806a51ac79d880de0b6b3a7640000b90684abcffc26000000000000000000000000be13e651ff246ac63fa36cad6cd8610b090a6a25000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000520000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001400000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000de0b6b3a764000000000000000000000000000000000000000000000000000000000000604c787c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c3160700000000000000000000000000000000000000000000000000000000604c787c0000000000000000000000006bb030922f22fed1038951bcaf6ea40983b49ab20000000000000000000000000000000000000000000000000000000063e1209400000000000000000000000000000000000000000000000000000000000002c00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000005010000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000085149247691df622eaf1a8bd0cafd40bc45154a900000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001367b22536f75726365223a226b7962657273776170222c22416d6f756e74496e555344223a2230222c22416d6f756e744f7574555344223a22313632332e373032343338222c22526566657272616c223a22222c22466c616773223a322c22496e74656772697479496e666f223a7b224b65794944223a2231222c225369676e6174757265223a22655832484c526869687a5739452f5a4a4a6b7179653059664a5965414e6f68784d7477305a327a76377a7147566a36705a4a7a5a45363972425a55704c5a477a627262434452575031514b49783149425a765a69727655543257556959457a334c6b742f506273474439637571594762455270585653714763764533564b42433145416e76496b3748725156504359464762734f536d433968396242773736576743336b2f3531303539413d227d7d0000000000000000000083014986a0f9ff4edc0dbe54b8353eceba53dbf6aefd2081bd864537ec2a0e3ce084cfb8e3a041630c5504a3c385c05859554aa495a74931f8095a9e64e58a676768a7fd8e73",
			expectedResult: big.NewInt(459958001185664),
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			l2FeeArbitrum := NewArbitrumFeeCalculator()
			l2FeeArbitrum.SetParams(&entity.L2Fee{
				Decimals:  big.NewInt(6),
				L1BaseFee: big.NewInt(16113999481),
				Overhead:  big.NewInt(2100),
				Scalar:    big.NewInt(1000000),
			})

			inputData := common.FromHex(tc.rawTx)

			result := l2FeeArbitrum.GetL1Fee(inputData)

			assert.Equal(t, tc.expectedResult, result)
		})
	}
}
