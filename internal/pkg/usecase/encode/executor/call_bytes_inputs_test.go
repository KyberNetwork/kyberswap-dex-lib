package executor

import (
	"fmt"
	"math/big"
	"testing"

	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/assert"

	"github.com/KyberNetwork/router-service/internal/pkg/constant"
	"github.com/KyberNetwork/router-service/internal/pkg/usecase/types"
	"github.com/KyberNetwork/router-service/internal/pkg/valueobject"
)

var packCallBytesInputsPairs = []struct {
	data       CallBytesInputs
	packedData string
}{
	{
		data: CallBytesInputs{
			Data: SwapExecutorDescription{
				SwapSequences: [][]Swap{
					{
						{
							Data:             []byte("data 1.1"),
							FunctionSelector: [4]byte{1, 2, 3, 4},
						},
						{
							Data:             []byte("data 1.2"),
							FunctionSelector: [4]byte{2, 2, 3, 4},
						},
					},
					{
						{
							Data:             []byte("data 2.1"),
							FunctionSelector: [4]byte{3, 2, 3, 4},
						},
					},
				},
				TokenIn:           common.HexToAddress("0x168a97c1403232b0b48ebaea43ae019e5d4afcd3"),
				TokenOut:          common.HexToAddress("0x2b9eca3dfc45ab2980ae044b675e742dab8a6f72"),
				MinTotalAmountOut: big.NewInt(1),
				To:                common.HexToAddress("0x49871350b60a0dd8769fcbdbc2f9f892b35886e5"),
				Deadline:          big.NewInt(10000),
				DestTokenFeeData:  []byte("destTokenFeeData"),
			},
		},
		packedData: "000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000168a97c1403232b0b48ebaea43ae019e5d4afcd30000000000000000000000002b9eca3dfc45ab2980ae044b675e742dab8a6f72000000000000000000000000000000000000000000000000000000000000000100000000000000000000000049871350b60a0dd8769fcbdbc2f9f892b35886e5000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000001a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000040010203040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000086461746120312e310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040020203040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000086461746120312e32000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040030203040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000086461746120322e31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001064657374546f6b656e4665654461746100000000000000000000000000000000",
	},
}

func TestPackCallBytesInputs(t *testing.T) {
	t.Parallel()

	for idx, pair := range packCallBytesInputsPairs {
		t.Run(fmt.Sprintf("it should encode correctly %d", idx), func(t *testing.T) {
			result, err := PackCallBytesInputs(pair.data)

			assert.ErrorIs(t, err, nil)
			assert.Equal(t, pair.packedData, common.Bytes2Hex(result))
		})
	}
}

func TestUnpackCallBytesInputs(t *testing.T) {
	t.Parallel()

	for idx, pair := range packCallBytesInputsPairs {
		t.Run(fmt.Sprintf("it should decode correctly %d", idx), func(t *testing.T) {
			result, err := UnpackCallBytesInputs(common.Hex2Bytes(pair.packedData))

			assert.ErrorIs(t, err, nil)
			assert.Equal(t, pair.data, result)
		})
	}
}

func TestBuildAndPackCallBytesInputs(t *testing.T) {
	t.Parallel()

	testCases := []struct {
		name           string
		chainID        valueobject.ChainID
		routerAddress  string
		data           types.EncodingData
		expectedResult string
		expectedError  error
	}{
		{
			name:          "it should build and pack callBytes inputs correctly",
			chainID:       valueobject.ChainIDPolygon,
			routerAddress: "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
			data: types.EncodingData{
				TokenIn:           "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
				TokenOut:          "0x2771a9fdbaf7d37679116191007c4829cf7616d2",
				Deadline:          big.NewInt(10000),
				SlippageTolerance: big.NewInt(2000),
				InputAmount:       big.NewInt(1000),
				OutputAmount:      big.NewInt(1000),
				TotalAmountOut:    big.NewInt(1000),
				Recipient:         "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
				Route: [][]types.EncodingSwap{
					{
						{
							Pool:              "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
							TokenIn:           "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
							TokenOut:          "0x2771a9fdbaf7d37679116191007c4829cf7616d2",
							SwapAmount:        big.NewInt(100000),
							AmountOut:         big.NewInt(100000),
							LimitReturnAmount: big.NewInt(1),
							PoolLength:        1,
							PoolType:          constant.PoolTypes.Uni,
							Exchange:          valueobject.ExchangeUniSwap,
							CollectAmount:     types.ZeroCollectAmount,
							Recipient:         "0xa66cc4b4c17361532f0baba708941b7b8cdf7aa0",
						},
					},
				},
			},
			expectedResult: "000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000a66cc4b4c17361532f0baba708941b7b8cdf7aa00000000000000000000000002771a9fdbaf7d37679116191007c4829cf7616d20000000000000000000000000000000000000000000000000000000000000320000000000000000000000000a66cc4b4c17361532f0baba708941b7b8cdf7aa0000000000000000000000000000000000000000000000000000000000000271000000000000000000000000000000000000000000000000000000000000002e000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000040d0796174000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120000000000000000000000000a66cc4b4c17361532f0baba708941b7b8cdf7aa0000000000000000000000000a66cc4b4c17361532f0baba708941b7b8cdf7aa00000000000000000000000002771a9fdbaf7d37679116191007c4829cf7616d2000000000000000000000000a66cc4b4c17361532f0baba708941b7b8cdf7aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000001e00000000000000000000000000000000000000000000000000000000000027100000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000003e8",
			expectedError:  nil,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			result, err := BuildAndPackCallBytesInputs(tc.chainID, tc.routerAddress, true, tc.data)

			assert.Equal(t, tc.expectedResult, common.Bytes2Hex(result))
			assert.ErrorIs(t, err, tc.expectedError)
		})
	}
}
