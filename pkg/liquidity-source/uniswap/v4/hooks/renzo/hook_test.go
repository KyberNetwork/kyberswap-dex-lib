package renzo

import (
	_ "embed"
	"testing"

	"github.com/goccy/go-json"
	"github.com/samber/lo"

	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	uniswapv4 "github.com/KyberNetwork/kyberswap-dex-lib/pkg/liquidity-source/uniswap/v4"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/util/testutil"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/valueobject"
)

var (
	entityPool entity.Pool
	_          = json.Unmarshal([]byte("{\"address\":\"0x7dbe9918ba991e7c2b078ec8ce882a060024a6126927cf66553a359e427f2f6a\",\"swapFee\":8388608,\"exchange\":\"uniswap-v4-renzo\",\"type\":\"uniswap-v4\",\"timestamp\":1754014808,\"reserves\":[\"21442917641950788914197868\",\"20355658121984467045904628\"],\"tokens\":[{\"address\":\"0x4200000000000000000000000000000000000006\",\"symbol\":\"WETH\",\"decimals\":18,\"swappable\":true},{\"address\":\"0x2416092f143378750bb29b79ed961ab195cceea5\",\"symbol\":\"ezETH\",\"decimals\":18,\"swappable\":true}],\"extra\":\"{\\\"liquidity\\\":20892216269640221978471476,\\\"sqrtPriceX96\\\":77193408729784446599902189231,\\\"tickSpacing\\\":1,\\\"tick\\\":-521,\\\"ticks\\\":[{\\\"index\\\":-887272,\\\"liquidityGross\\\":958998943917699714724,\\\"liquidityNet\\\":958998943917699714724},{\\\"index\\\":-17919,\\\"liquidityGross\\\":5023945945502452702601,\\\"liquidityNet\\\":5023945945502452702601},{\\\"index\\\":-6932,\\\"liquidityGross\\\":330009763904755388533,\\\"liquidityNet\\\":330009763904755388533},{\\\"index\\\":-2071,\\\"liquidityGross\\\":1016605231878446657085,\\\"liquidityNet\\\":1016605231878446657085},{\\\"index\\\":-1824,\\\"liquidityGross\\\":205315358714773801699,\\\"liquidityNet\\\":205315358714773801699},{\\\"index\\\":-1640,\\\"liquidityGross\\\":3081463838133342537,\\\"liquidityNet\\\":3081463838133342537},{\\\"index\\\":-1626,\\\"liquidityGross\\\":9844572325584464883,\\\"liquidityNet\\\":9844572325584464883},{\\\"index\\\":-1054,\\\"liquidityGross\\\":19404538105968991412091,\\\"liquidityNet\\\":19404538105968991412091},{\\\"index\\\":-978,\\\"liquidityGross\\\":6852257790278325154664,\\\"liquidityNet\\\":6852257790278325154664},{\\\"index\\\":-954,\\\"liquidityGross\\\":42341902015758708237,\\\"liquidityNet\\\":42341902015758708237},{\\\"index\\\":-944,\\\"liquidityGross\\\":987677767250540495,\\\"liquidityNet\\\":987677767250540495},{\\\"index\\\":-726,\\\"liquidityGross\\\":147485368706070386615,\\\"liquidityNet\\\":147485368706070386615},{\\\"index\\\":-673,\\\"liquidityGross\\\":25819979339062416905261,\\\"liquidityNet\\\":25819979339062416905261},{\\\"index\\\":-619,\\\"liquidityGross\\\":50226772622861713923,\\\"liquidityNet\\\":50226772622861713923},{\\\"index\\\":-617,\\\"liquidityGross\\\":171446476423535735821,\\\"liquidityNet\\\":171446476423535735821},{\\\"index\\\":-586,\\\"liquidityGross\\\":2487109563337583337,\\\"liquidityNet\\\":2487109563337583337},{\\\"index\\\":-583,\\\"liquidityGross\\\":233828611943300418906,\\\"liquidityNet\\\":233828611943300418906},{\\\"index\\\":-577,\\\"liquidityGross\\\":1790643117471297692738,\\\"liquidityNet\\\":1790643117471297692738},{\\\"index\\\":-555,\\\"liquidityGross\\\":12897652196495618205,\\\"liquidityNet\\\":12897652196495618205},{\\\"index\\\":-545,\\\"liquidityGross\\\":7237299192624623575,\\\"liquidityNet\\\":7237299192624623575},{\\\"index\\\":-537,\\\"liquidityGross\\\":25623569771516564315084,\\\"liquidityNet\\\":25623569771516564315084},{\\\"index\\\":-534,\\\"liquidityGross\\\":924986895994577784379295,\\\"liquidityNet\\\":924986895994577784379295},{\\\"index\\\":-530,\\\"liquidityGross\\\":269321700304588936710985,\\\"liquidityNet\\\":269321700304588936710985},{\\\"index\\\":-527,\\\"liquidityGross\\\":9482201577240749263600,\\\"liquidityNet\\\":9482201577240749263600},{\\\"index\\\":-526,\\\"liquidityGross\\\":141007178345036457428693,\\\"liquidityNet\\\":141007178345036457428693},{\\\"index\\\":-522,\\\"liquidityGross\\\":174133527636927387618373,\\\"liquidityNet\\\":174133527636927387618373},{\\\"index\\\":-521,\\\"liquidityGross\\\":19285577037507039986189516,\\\"liquidityNet\\\":19285577037507039986189516},{\\\"index\\\":-520,\\\"liquidityGross\\\":19285555171932535882740591,\\\"liquidityNet\\\":-19285555171932535882740591},{\\\"index\\\":-519,\\\"liquidityGross\\\":174418074716891691809368,\\\"liquidityNet\\\":-173848116286525748539094},{\\\"index\\\":-513,\\\"liquidityGross\\\":987677767250540495,\\\"liquidityNet\\\":-987677767250540495},{\\\"index\\\":-512,\\\"liquidityGross\\\":141017497108067215394805,\\\"liquidityNet\\\":-141017497108067215394805},{\\\"index\\\":-511,\\\"liquidityGross\\\":285891624049354938233516,\\\"liquidityNet\\\":-285873210036373847833162},{\\\"index\\\":-509,\\\"liquidityGross\\\":9062853033241107992730,\\\"liquidityNet\\\":-9062853033241107992730},{\\\"index\\\":-508,\\\"liquidityGross\\\":5023945945502452702601,\\\"liquidityNet\\\":-5023945945502452702601},{\\\"index\\\":-507,\\\"liquidityGross\\\":9812211341145504652133,\\\"liquidityNet\\\":-9812211341145504652133},{\\\"index\\\":-502,\\\"liquidityGross\\\":42341902015758708237,\\\"liquidityNet\\\":-42341902015758708237},{\\\"index\\\":-501,\\\"liquidityGross\\\":75979445168477234934,\\\"liquidityNet\\\":-75979445168477234934},{\\\"index\\\":-500,\\\"liquidityGross\\\":3350085494791476668,\\\"liquidityNet\\\":-3350085494791476668},{\\\"index\\\":-499,\\\"liquidityGross\\\":1790643117471297692738,\\\"liquidityNet\\\":-1790643117471297692738},{\\\"index\\\":-497,\\\"liquidityGross\\\":9207006490545200177,\\\"liquidityNet\\\":-9207006490545200177},{\\\"index\\\":-495,\\\"liquidityGross\\\":171446476423535735821,\\\"liquidityNet\\\":-171446476423535735821},{\\\"index\\\":-493,\\\"liquidityGross\\\":6862102362603909619547,\\\"liquidityNet\\\":-6862102362603909619547},{\\\"index\\\":-492,\\\"liquidityGross\\\":925037122767200646093218,\\\"liquidityNet\\\":-925037122767200646093218},{\\\"index\\\":-479,\\\"liquidityGross\\\":1322587045634067847816,\\\"liquidityNet\\\":-1322587045634067847816},{\\\"index\\\":-475,\\\"liquidityGross\\\":12897652196495618205,\\\"liquidityNet\\\":-12897652196495618205},{\\\"index\\\":-466,\\\"liquidityGross\\\":432135218667444142,\\\"liquidityNet\\\":-432135218667444142},{\\\"index\\\":-461,\\\"liquidityGross\\\":71505923537593151681,\\\"liquidityNet\\\":-71505923537593151681},{\\\"index\\\":-422,\\\"liquidityGross\\\":233828611943300418906,\\\"liquidityNet\\\":-233828611943300418906},{\\\"index\\\":-416,\\\"liquidityGross\\\":205315358714773801699,\\\"liquidityNet\\\":-205315358714773801699},{\\\"index\\\":-356,\\\"liquidityGross\\\":19400971938019965518544,\\\"liquidityNet\\\":-19400971938019965518544},{\\\"index\\\":0,\\\"liquidityGross\\\":3566167949025893547,\\\"liquidityNet\\\":-3566167949025893547},{\\\"index\\\":276,\\\"liquidityGross\\\":25819979339062416905261,\\\"liquidityNet\\\":-25819979339062416905261},{\\\"index\\\":887272,\\\"liquidityGross\\\":958998943917699714724,\\\"liquidityNet\\\":-958998943917699714724}],\\\"hX\\\":\\\"{\\\\\\\"rP\\\\\\\":\\\\\\\"0xdb6df3559d2d96985062f0824442550ca7715960\\\\\\\",\\\\\\\"r\\\\\\\":1055878891161306807,\\\\\\\"minF\\\\\\\":100,\\\\\\\"maxF\\\\\\\":10000}\\\"}\",\"staticExtra\":\"{\\\"0x0\\\":[true,false],\\\"fee\\\":8388608,\\\"tS\\\":1,\\\"hooks\\\":\\\"0x09dea99d714a3a19378e3d80d1ad22ca46085080\\\",\\\"uR\\\":\\\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\\\",\\\"pm2\\\":\\\"0x000000000022d473030f116ddee9f6b43ac78ba3\\\",\\\"mc3\\\":\\\"0xca11bde05977b3631167028862be2a173976ca11\\\"}\",\"blockNumber\":23266442}"),
		&entityPool)
	poolSim = lo.Must(uniswapv4.NewPoolSimulator(entityPool, valueobject.ChainID(130)))
)

func TestPoolSimulator_CalcAmountOut(t *testing.T) {
	t.Parallel()
	testutil.TestCalcAmountOut(t, poolSim, map[int]map[int]map[string]string{
		0: {
			1: {
				"100000000000000000": "94920023483381004", // https://www.tdly.co/shared/simulation/823e01b9-6b2d-4ef2-8851-1ab2afb5ca86
			},
		},
		1: {0: {
			"100000000000000000": "105094814334276899", // https://www.tdly.co/shared/simulation/047d5b2e-91e3-45c7-868b-759d81fc8d62
		}},
	})
}

func TestPoolSimulator_CalcAmountIn(t *testing.T) {
	t.Parallel()
	testutil.TestCalcAmountIn(t, poolSim)
}
