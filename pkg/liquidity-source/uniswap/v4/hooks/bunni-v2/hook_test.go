package bunniv2

import (
	"context"
	"encoding/json"
	"fmt"
	"math/big"
	"os"
	"testing"

	"github.com/KyberNetwork/ethrpc"
	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"

	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	uniswapv4 "github.com/KyberNetwork/kyberswap-dex-lib/pkg/liquidity-source/uniswap/v4"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/valueobject"
)

var (
	minPriceLimit, _ = new(big.Int).SetString("4295128740", 10)
	maxPriceLimit, _ = new(big.Int).SetString("1461446703485210103287273052203988822378723970340", 10)
)

func TestHookV121_OracleUniGeo_Track(t *testing.T) {

	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://ethereum.kyberengineering.io").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0x54ff1fd1d62f3bc6224082ecfdb3190a34e8428611b058ade19ce6c083cb608b",
		Tokens: []*entity.PoolToken{
			{
				Address: "0x35d8949372d46b7a3d5a56006ae77b215fc69bc0",
			},
			{
				Address: "0x73a15fed60bf67631dc6cd7bc5b6e8da8190acf5",
			},
		},
		StaticExtra: "{\"tickSpacing\":5}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 1,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x000052423c1db6b7ff8641b85a7eefc7b2791888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func TestHookV121_Track(t *testing.T) {

	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://ethereum.kyberengineering.io").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0xd9f673912e1da331c9e56c5f0dbc7273c0eb684617939a375ec5e227c62d6707",
		Tokens: []*entity.PoolToken{
			{
				Address: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
			},
			{
				Address: "0xdac17f958d2ee523a2206206994597c13d831ec7",
			},
		},
		StaticExtra: "{\"tickSpacing\":1}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 1,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x000052423c1db6b7ff8641b85a7eefc7b2791888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)

	_, err = h.GetReserves(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func TestHookV120_Track(t *testing.T) {
	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://unichain.drpc.org").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433",
		Tokens: []*entity.PoolToken{
			{
				Address: "0x078d782b760474a361dda0af3839290b0ef57ad6",
			},
			{
				Address: "0x9151434b16b9763660705744891fa906f660ecc5",
			},
		},
		StaticExtra: "{\"tickSpacing\":1}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 130,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x005af73a245d8171a0550ffae2631f12cc211888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)

	_, err = h.GetReserves(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func Test_Pool_OracleUniGeo(t *testing.T) {
	// LDF: OracleUniGeoDistribution

	var p entity.Pool
	poolData := `{"address":"0x54ff1fd1d62f3bc6224082ecfdb3190a34e8428611b058ade19ce6c083cb608b","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755522881,"reserves":["4765811330936679837190504","1418492956628879905908488"],"tokens":[{"address":"0x35d8949372d46b7a3d5a56006ae77b215fc69bc0","symbol":"USD0++","decimals":18,"swappable":true},{"address":"0x73a15fed60bf67631dc6cd7bc5b6e8da8190acf5","symbol":"USD0","decimals":18,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":76190265766238121671454010019,\"tickSpacing\":5,\"tick\":-783,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"{\\\\\\\"OverrideZeroToOne\\\\\\\":false,\\\\\\\"FeeZeroToOne\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"OverrideOneToZero\\\\\\\":false,\\\\\\\"FeeOneToZero\\\\\\\":\\\\\\\"0\\\\\\\"}\\\",\\\"ha\\\":\\\"0x0000e819b8a536cf8e5d70b9c49256911033000c\\\",\\\"la\\\":\\\"0x00000000b5cd5d1e09a5c1fb166d26d1cef0c33c\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"4828638527591651254311369\\\",\\\"1466493084648341862790220\\\"],\\\"ls\\\":[1,255,252,189,3,1,1,0,0,0,0,0,5,219,240,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"d\\\":0,\\\"rr\\\":\\\"0\\\",\\\"dr\\\":\\\"0\\\",\\\"md\\\":\\\"0\\\",\\\"wr\\\":\\\"0\\\",\\\"mw\\\":\\\"0\\\"},{\\\"a\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"d\\\":0,\\\"rr\\\":\\\"0\\\",\\\"dr\\\":\\\"0\\\",\\\"md\\\":\\\"0\\\",\\\"wr\\\":\\\"0\\\",\\\"mw\\\":\\\"0\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":1,\\\"c\\\":2,\\\"cn\\\":2,\\\"io\\\":{\\\"bt\\\":1755511415,\\\"pt\\\":-767,\\\"tc\\\":-3177859800,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1755509495,\\\"pt\\\":-754,\\\"tc\\\":-3176393412,\\\"i\\\":true},{\\\"bt\\\":1755511415,\\\"pt\\\":-767,\\\"tc\\\":-3177859800,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"400\\\",\\\"fmax\\\":\\\"400\\\",\\\"fqm\\\":\\\"0\\\",\\\"ftsa\\\":0,\\\"sfhl\\\":\\\"1\\\",\\\"sfat\\\":0,\\\"vst0\\\":\\\"1\\\",\\\"vst1\\\":\\\"1\\\",\\\"rt\\\":1000,\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"76274500331769221081611528942\\\",\\\"t\\\":-760,\\\"lst\\\":1755511415,\\\"lsgt\\\":0},\\\"bs\\\":{\\\"tsa\\\":0,\\\"lp\\\":[3,1,1,0,0,0,0,0,5,219,240,96,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"hp\\\":\\\"AAGQAAGQAAAAAAAAAAAAAAEAAAABAAED6APoBwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"0\\\",\\\"trtr0\\\":\\\"0\\\",\\\"xrtr0\\\":\\\"0\\\",\\\"mrtr1\\\":\\\"0\\\",\\\"trtr1\\\":\\\"0\\\",\\\"xrtr1\\\":\\\"0\\\",\\\"c0d\\\":18,\\\"c1d\\\":18,\\\"rb0\\\":\\\"4765811330936679837190504\\\",\\\"rb1\\\":\\\"1418492956628879905908488\\\",\\\"r0\\\":\\\"0\\\",\\\"r1\\\":\\\"0\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},\\\"vsp\\\":{\\\"i\\\":false,\\\"sp0\\\":\\\"0\\\",\\\"sp1\\\":\\\"0\\\"},\\\"rod\\\":0,\\\"bt\\\":0,\\\"oug\\\":{\\\"BondLtStablecoin\\\":true,\\\"FloorPrice\\\":\\\"920000000000000000\\\",\\\"LdfParamOverride\\\":{\\\"Overridden\\\":false,\\\"LdfParams\\\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}},\\\"po\\\":\\\"0x35d8949372d46b7a3d5a56006ae77b215fc69bc0\\\"}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":5,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0x66a9893cc07d91d95644aedd05d03f95e1dba8af\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":23168171}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDEthereum)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x35d8949372d46b7a3d5a56006ae77b215fc69bc0",
			Amount: big.NewInt(1e18),
		},
		TokenOut: "0x73a15fed60bf67631dc6cd7bc5b6e8da8190acf5",
	})
	assert.NoError(t, err)
	assert.Equal(t, "926458182427270530", got.TokenAmountOut.Amount.String())

	got, err = pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x73a15fed60bf67631dc6cd7bc5b6e8da8190acf5",
			Amount: big.NewInt(1e18),
		},
		TokenOut: "0x35d8949372d46b7a3d5a56006ae77b215fc69bc0",
	})
	assert.NoError(t, err)
	assert.Equal(t, "1078516195426919954", got.TokenAmountOut.Amount.String())
}

func Test_Pool_V120(t *testing.T) {
	// LDF: CarpetedDoubleGeometricDistribution

	var p entity.Pool
	poolData := `{"address":"0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755411864,"reserves":["25184454954043","3910622714544"],"tokens":[{"address":"0x078d782b760474a361dda0af3839290b0ef57ad6","symbol":"USDC","decimals":6,"swappable":true},{"address":"0x9151434b16b9763660705744891fa906f660ecc5","symbol":"USDâ‚®0","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":79208352997136529422885942753,\"tickSpacing\":1,\"tick\":-6,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"\\\",\\\"ha\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"la\\\":\\\"0x000000e22477c615223e430266ad8d5285636e30\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"107084360610452\\\",\\\"57601892660770\\\"],\\\"ls\\\":[1,255,255,246,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x6eae95ee783e4d862867c4e0e4c3f4b95aa682ba\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1014236088107160720\\\",\\\"dr\\\":\\\"985963733420559785\\\",\\\"md\\\":\\\"75930115675018\\\",\\\"wr\\\":\\\"985963733420559786\\\",\\\"mw\\\":\\\"7236365143630\\\"},{\\\"a\\\":\\\"0xd49181c522ecdb265f0d9c175cf26fface64ead3\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1011244505994821454\\\",\\\"dr\\\":\\\"988880526986142126\\\",\\\"md\\\":\\\"89947907004834\\\",\\\"wr\\\":\\\"988880526986142127\\\",\\\"mw\\\":\\\"363008708316\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":24,\\\"c\\\":97,\\\"cn\\\":97,\\\"io\\\":{\\\"bt\\\":1755410130,\\\"pt\\\":-7,\\\"tc\\\":-23461363,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1755343611,\\\"pt\\\":-7,\\\"tc\\\":-22995250,\\\"i\\\":true},{\\\"bt\\\":1755345724,\\\"pt\\\":-7,\\\"tc\\\":-23010041,\\\"i\\\":true},{\\\"bt\\\":1755347748,\\\"pt\\\":-7,\\\"tc\\\":-23024209,\\\"i\\\":true},{\\\"bt\\\":1755350392,\\\"pt\\\":-7,\\\"tc\\\":-23042717,\\\"i\\\":true},{\\\"bt\\\":1755353616,\\\"pt\\\":-7,\\\"tc\\\":-23065285,\\\"i\\\":true},{\\\"bt\\\":1755355628,\\\"pt\\\":-7,\\\"tc\\\":-23079369,\\\"i\\\":true},{\\\"bt\\\":1755357768,\\\"pt\\\":-7,\\\"tc\\\":-23094349,\\\"i\\\":true},{\\\"bt\\\":1755359961,\\\"pt\\\":-7,\\\"tc\\\":-23109700,\\\"i\\\":true},{\\\"bt\\\":1755361856,\\\"pt\\\":-8,\\\"tc\\\":-23123369,\\\"i\\\":true},{\\\"bt\\\":1755364415,\\\"pt\\\":-7,\\\"tc\\\":-23141358,\\\"i\\\":true},{\\\"bt\\\":1755370452,\\\"pt\\\":-7,\\\"tc\\\":-23183617,\\\"i\\\":true},{\\\"bt\\\":1755372489,\\\"pt\\\":-7,\\\"tc\\\":-23197876,\\\"i\\\":true},{\\\"bt\\\":1755375576,\\\"pt\\\":-7,\\\"tc\\\":-23219485,\\\"i\\\":true},{\\\"bt\\\":1755378071,\\\"pt\\\":-7,\\\"tc\\\":-23236950,\\\"i\\\":true},{\\\"bt\\\":1755380058,\\\"pt\\\":-7,\\\"tc\\\":-23250859,\\\"i\\\":true},{\\\"bt\\\":1755382094,\\\"pt\\\":-7,\\\"tc\\\":-23265111,\\\"i\\\":true},{\\\"bt\\\":1755386119,\\\"pt\\\":-7,\\\"tc\\\":-23293286,\\\"i\\\":true},{\\\"bt\\\":1755387934,\\\"pt\\\":-7,\\\"tc\\\":-23305991,\\\"i\\\":true},{\\\"bt\\\":1755391294,\\\"pt\\\":-7,\\\"tc\\\":-23329511,\\\"i\\\":true},{\\\"bt\\\":1755393213,\\\"pt\\\":-7,\\\"tc\\\":-23342944,\\\"i\\\":true},{\\\"bt\\\":1755398406,\\\"pt\\\":-7,\\\"tc\\\":-23379295,\\\"i\\\":true},{\\\"bt\\\":1755400669,\\\"pt\\\":-7,\\\"tc\\\":-23395136,\\\"i\\\":true},{\\\"bt\\\":1755405116,\\\"pt\\\":-7,\\\"tc\\\":-23426265,\\\"i\\\":true},{\\\"bt\\\":1755407418,\\\"pt\\\":-7,\\\"tc\\\":-23442379,\\\"i\\\":true},{\\\"bt\\\":1755410130,\\\"pt\\\":-7,\\\"tc\\\":-23461363,\\\"i\\\":true},{\\\"bt\\\":1755144588,\\\"pt\\\":-5,\\\"tc\\\":-21721444,\\\"i\\\":true},{\\\"bt\\\":1755149801,\\\"pt\\\":-5,\\\"tc\\\":-21747509,\\\"i\\\":true},{\\\"bt\\\":1755152061,\\\"pt\\\":-5,\\\"tc\\\":-21758809,\\\"i\\\":true},{\\\"bt\\\":1755154157,\\\"pt\\\":-5,\\\"tc\\\":-21769289,\\\"i\\\":true},{\\\"bt\\\":1755156177,\\\"pt\\\":-6,\\\"tc\\\":-21781357,\\\"i\\\":true},{\\\"bt\\\":1755157990,\\\"pt\\\":-6,\\\"tc\\\":-21790738,\\\"i\\\":true},{\\\"bt\\\":1755161498,\\\"pt\\\":-5,\\\"tc\\\":-21808879,\\\"i\\\":true},{\\\"bt\\\":1755164052,\\\"pt\\\":-6,\\\"tc\\\":-21824203,\\\"i\\\":true},{\\\"bt\\\":1755165905,\\\"pt\\\":-6,\\\"tc\\\":-21834880,\\\"i\\\":true},{\\\"bt\\\":1755167831,\\\"pt\\\":-6,\\\"tc\\\":-21846436,\\\"i\\\":true},{\\\"bt\\\":1755170134,\\\"pt\\\":-6,\\\"tc\\\":-21860254,\\\"i\\\":true},{\\\"bt\\\":1755171976,\\\"pt\\\":-6,\\\"tc\\\":-21871306,\\\"i\\\":true},{\\\"bt\\\":1755173824,\\\"pt\\\":-6,\\\"tc\\\":-21882394,\\\"i\\\":true},{\\\"bt\\\":1755175764,\\\"pt\\\":-6,\\\"tc\\\":-21894034,\\\"i\\\":true},{\\\"bt\\\":1755181503,\\\"pt\\\":-6,\\\"tc\\\":-21928468,\\\"i\\\":true},{\\\"bt\\\":1755184619,\\\"pt\\\":-6,\\\"tc\\\":-21947164,\\\"i\\\":true},{\\\"bt\\\":1755186504,\\\"pt\\\":-6,\\\"tc\\\":-21957403,\\\"i\\\":true},{\\\"bt\\\":1755189923,\\\"pt\\\":-6,\\\"tc\\\":-21977917,\\\"i\\\":true},{\\\"bt\\\":1755191734,\\\"pt\\\":-6,\\\"tc\\\":-21988783,\\\"i\\\":true},{\\\"bt\\\":1755195176,\\\"pt\\\":-6,\\\"tc\\\":-22009435,\\\"i\\\":true},{\\\"bt\\\":1755197842,\\\"pt\\\":-6,\\\"tc\\\":-22025431,\\\"i\\\":true},{\\\"bt\\\":1755200455,\\\"pt\\\":-6,\\\"tc\\\":-22041109,\\\"i\\\":true},{\\\"bt\\\":1755202290,\\\"pt\\\":-6,\\\"tc\\\":-22052119,\\\"i\\\":true},{\\\"bt\\\":1755204282,\\\"pt\\\":-6,\\\"tc\\\":-22064071,\\\"i\\\":true},{\\\"bt\\\":1755206673,\\\"pt\\\":-6,\\\"tc\\\":-22078417,\\\"i\\\":true},{\\\"bt\\\":1755210507,\\\"pt\\\":-6,\\\"tc\\\":-22101421,\\\"i\\\":true},{\\\"bt\\\":1755214844,\\\"pt\\\":-6,\\\"tc\\\":-22127443,\\\"i\\\":true},{\\\"bt\\\":1755217514,\\\"pt\\\":-6,\\\"tc\\\":-22143463,\\\"i\\\":true},{\\\"bt\\\":1755219531,\\\"pt\\\":-7,\\\"tc\\\":-22156335,\\\"i\\\":true},{\\\"bt\\\":1755223732,\\\"pt\\\":-7,\\\"tc\\\":-22185742,\\\"i\\\":true},{\\\"bt\\\":1755225581,\\\"pt\\\":-8,\\\"tc\\\":-22198861,\\\"i\\\":true},{\\\"bt\\\":1755228407,\\\"pt\\\":-8,\\\"tc\\\":-22221469,\\\"i\\\":true},{\\\"bt\\\":1755231152,\\\"pt\\\":-8,\\\"tc\\\":-22243429,\\\"i\\\":true},{\\\"bt\\\":1755233054,\\\"pt\\\":-8,\\\"tc\\\":-22258645,\\\"i\\\":true},{\\\"bt\\\":1755235373,\\\"pt\\\":-8,\\\"tc\\\":-22277197,\\\"i\\\":true},{\\\"bt\\\":1755239282,\\\"pt\\\":-8,\\\"tc\\\":-22308469,\\\"i\\\":true},{\\\"bt\\\":1755241359,\\\"pt\\\":-8,\\\"tc\\\":-22325085,\\\"i\\\":true},{\\\"bt\\\":1755243307,\\\"pt\\\":-8,\\\"tc\\\":-22340669,\\\"i\\\":true},{\\\"bt\\\":1755245128,\\\"pt\\\":-8,\\\"tc\\\":-22355237,\\\"i\\\":true},{\\\"bt\\\":1755247368,\\\"pt\\\":-7,\\\"tc\\\":-22371222,\\\"i\\\":true},{\\\"bt\\\":1755249375,\\\"pt\\\":-7,\\\"tc\\\":-22385271,\\\"i\\\":true},{\\\"bt\\\":1755252899,\\\"pt\\\":-7,\\\"tc\\\":-22409939,\\\"i\\\":true},{\\\"bt\\\":1755255511,\\\"pt\\\":-7,\\\"tc\\\":-22428223,\\\"i\\\":true},{\\\"bt\\\":1755258932,\\\"pt\\\":-7,\\\"tc\\\":-22452170,\\\"i\\\":true},{\\\"bt\\\":1755260736,\\\"pt\\\":-7,\\\"tc\\\":-22464798,\\\"i\\\":true},{\\\"bt\\\":1755262713,\\\"pt\\\":-7,\\\"tc\\\":-22478637,\\\"i\\\":true},{\\\"bt\\\":1755265095,\\\"pt\\\":-7,\\\"tc\\\":-22495311,\\\"i\\\":true},{\\\"bt\\\":1755266933,\\\"pt\\\":-7,\\\"tc\\\":-22508177,\\\"i\\\":true},{\\\"bt\\\":1755269231,\\\"pt\\\":-6,\\\"tc\\\":-22523021,\\\"i\\\":true},{\\\"bt\\\":1755271055,\\\"pt\\\":-6,\\\"tc\\\":-22533965,\\\"i\\\":true},{\\\"bt\\\":1755272957,\\\"pt\\\":-6,\\\"tc\\\":-22545377,\\\"i\\\":true},{\\\"bt\\\":1755275265,\\\"pt\\\":-6,\\\"tc\\\":-22559225,\\\"i\\\":true},{\\\"bt\\\":1755277077,\\\"pt\\\":-6,\\\"tc\\\":-22570097,\\\"i\\\":true},{\\\"bt\\\":1755279204,\\\"pt\\\":-6,\\\"tc\\\":-22582859,\\\"i\\\":true},{\\\"bt\\\":1755281096,\\\"pt\\\":-6,\\\"tc\\\":-22594211,\\\"i\\\":true},{\\\"bt\\\":1755283521,\\\"pt\\\":-6,\\\"tc\\\":-22608761,\\\"i\\\":true},{\\\"bt\\\":1755285337,\\\"pt\\\":-6,\\\"tc\\\":-22619657,\\\"i\\\":true},{\\\"bt\\\":1755288452,\\\"pt\\\":-6,\\\"tc\\\":-22638347,\\\"i\\\":true},{\\\"bt\\\":1755291658,\\\"pt\\\":-6,\\\"tc\\\":-22657583,\\\"i\\\":true},{\\\"bt\\\":1755295019,\\\"pt\\\":-6,\\\"tc\\\":-22677749,\\\"i\\\":true},{\\\"bt\\\":1755297333,\\\"pt\\\":-6,\\\"tc\\\":-22691633,\\\"i\\\":true},{\\\"bt\\\":1755302617,\\\"pt\\\":-6,\\\"tc\\\":-22723337,\\\"i\\\":true},{\\\"bt\\\":1755304509,\\\"pt\\\":-6,\\\"tc\\\":-22734689,\\\"i\\\":true},{\\\"bt\\\":1755307626,\\\"pt\\\":-6,\\\"tc\\\":-22753391,\\\"i\\\":true},{\\\"bt\\\":1755314445,\\\"pt\\\":-6,\\\"tc\\\":-22794305,\\\"i\\\":true},{\\\"bt\\\":1755324768,\\\"pt\\\":-6,\\\"tc\\\":-22856243,\\\"i\\\":true},{\\\"bt\\\":1755327151,\\\"pt\\\":-7,\\\"tc\\\":-22872921,\\\"i\\\":true},{\\\"bt\\\":1755331953,\\\"pt\\\":-7,\\\"tc\\\":-22906535,\\\"i\\\":true},{\\\"bt\\\":1755333906,\\\"pt\\\":-7,\\\"tc\\\":-22920206,\\\"i\\\":true},{\\\"bt\\\":1755336263,\\\"pt\\\":-7,\\\"tc\\\":-22936705,\\\"i\\\":true},{\\\"bt\\\":1755339507,\\\"pt\\\":-8,\\\"tc\\\":-22962502,\\\"i\\\":true},{\\\"bt\\\":1755341810,\\\"pt\\\":-8,\\\"tc\\\":-22980926,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"3\\\",\\\"fmax\\\":\\\"500\\\",\\\"fqm\\\":\\\"30000\\\",\\\"ftsa\\\":43200,\\\"sfhl\\\":\\\"30\\\",\\\"sfat\\\":60,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"rt\\\":10,\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"79201952850877671122872287789\\\",\\\"t\\\":-7,\\\"lst\\\":1755410130,\\\"lsgt\\\":1755339511},\\\"bs\\\":{\\\"tsa\\\":172800,\\\"lp\\\":[0,255,255,252,0,4,1,252,147,80,29,205,101,0,0,4,17,225,163,0,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AAADAAH0AHUwAKjAAAAAAB4APABkAGQACgAyBwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"50000\\\",\\\"trtr0\\\":\\\"100000\\\",\\\"xrtr0\\\":\\\"150000\\\",\\\"mrtr1\\\":\\\"50000\\\",\\\"trtr1\\\":\\\"100000\\\",\\\"xrtr1\\\":\\\"150000\\\",\\\"c0d\\\":6,\\\"c1d\\\":6,\\\"rb0\\\":\\\"1914981193951\\\",\\\"rb1\\\":\\\"354362224415\\\",\\\"r0\\\":\\\"23269473760092\\\",\\\"r1\\\":\\\"3556260490129\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,14,120,19,141,94,183]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1014232683911690470\\\",\\\"sp1\\\":\\\"1011232523413673572\\\"},\\\"rod\\\":0,\\\"bt\\\":0}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x005af73a245d8171a0550ffae2631f12cc211888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24663505}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x9151434b16b9763660705744891fa906f660ecc5",
			Amount: big.NewInt(6439251628),
		},
		TokenOut: "0x078d782b760474a361dda0af3839290b0ef57ad6",
	})
	assert.NoError(t, err)
	assert.Equal(t, "6443486358", got.TokenAmountOut.Amount.String())
}

func Test_Pool_ETH_weETH(t *testing.T) {
	// LDF: CarpetedDoubleGeometricDistribution

	var p entity.Pool
	poolData := `{"address":"0x6923777072439713c7b8ab34903e0ea96078d7148449bf54f420320d59ede857","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755011346,"reserves":["510310446574865978291","2242415103319037855778"],"tokens":[{"address":"0x4200000000000000000000000000000000000006","symbol":"WETH","decimals":18,"swappable":true},{"address":"0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7","symbol":"weETH","decimals":18,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":76540554206939071665077752050,\"tickSpacing\":1,\"tick\":-691,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"{\\\\\\\"OverrideZeroToOne\\\\\\\":false,\\\\\\\"FeeZeroToOne\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"OverrideOneToZero\\\\\\\":false,\\\\\\\"FeeOneToZero\\\\\\\":\\\\\\\"0\\\\\\\"}\\\",\\\"ha\\\":\\\"0x00ece5a72612258f20eb24573c544f9dd8c5000c\\\",\\\"la\\\":\\\"0x000000000b757686c9596cada54fa28f8c429e0d\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"7512203649770257870\\\",\\\"5067072175697026613941\\\"],\\\"ls\\\":[1,255,253,45,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x1f3134c3f3f8add904b9635acbefc0ea0d0e1ffc\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1006377284619589049\\\",\\\"md\\\":\\\"8485582981085092884070\\\"},{\\\"a\\\":\\\"0xe36da4ea4d07e54b1029ef26a896a656a3729f86\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1000523276644768340\\\",\\\"md\\\":\\\"16597303290790431274960\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":23,\\\"c\\\":49,\\\"cn\\\":49,\\\"io\\\":{\\\"bt\\\":1754965697,\\\"pt\\\":-701,\\\"tc\\\":-1561614878,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1754870161,\\\"pt\\\":-701,\\\"tc\\\":-1494644142,\\\"i\\\":true},{\\\"bt\\\":1754872173,\\\"pt\\\":-701,\\\"tc\\\":-1496054554,\\\"i\\\":true},{\\\"bt\\\":1754875456,\\\"pt\\\":-701,\\\"tc\\\":-1498355937,\\\"i\\\":true},{\\\"bt\\\":1754880944,\\\"pt\\\":-701,\\\"tc\\\":-1502203025,\\\"i\\\":true},{\\\"bt\\\":1754891448,\\\"pt\\\":-701,\\\"tc\\\":-1509566329,\\\"i\\\":true},{\\\"bt\\\":1754893965,\\\"pt\\\":-701,\\\"tc\\\":-1511330746,\\\"i\\\":true},{\\\"bt\\\":1754897031,\\\"pt\\\":-701,\\\"tc\\\":-1513480012,\\\"i\\\":true},{\\\"bt\\\":1754908532,\\\"pt\\\":-701,\\\"tc\\\":-1521542213,\\\"i\\\":true},{\\\"bt\\\":1754917902,\\\"pt\\\":-701,\\\"tc\\\":-1528110583,\\\"i\\\":true},{\\\"bt\\\":1754922040,\\\"pt\\\":-701,\\\"tc\\\":-1531011321,\\\"i\\\":true},{\\\"bt\\\":1754924055,\\\"pt\\\":-701,\\\"tc\\\":-1532423836,\\\"i\\\":true},{\\\"bt\\\":1754926436,\\\"pt\\\":-701,\\\"tc\\\":-1534092917,\\\"i\\\":true},{\\\"bt\\\":1754928293,\\\"pt\\\":-701,\\\"tc\\\":-1535394674,\\\"i\\\":true},{\\\"bt\\\":1754933891,\\\"pt\\\":-701,\\\"tc\\\":-1539318872,\\\"i\\\":true},{\\\"bt\\\":1754935970,\\\"pt\\\":-701,\\\"tc\\\":-1540776251,\\\"i\\\":true},{\\\"bt\\\":1754937970,\\\"pt\\\":-701,\\\"tc\\\":-1542178251,\\\"i\\\":true},{\\\"bt\\\":1754939952,\\\"pt\\\":-701,\\\"tc\\\":-1543567633,\\\"i\\\":true},{\\\"bt\\\":1754941856,\\\"pt\\\":-701,\\\"tc\\\":-1544902337,\\\"i\\\":true},{\\\"bt\\\":1754944028,\\\"pt\\\":-701,\\\"tc\\\":-1546424909,\\\"i\\\":true},{\\\"bt\\\":1754947872,\\\"pt\\\":-701,\\\"tc\\\":-1549119553,\\\"i\\\":true},{\\\"bt\\\":1754950358,\\\"pt\\\":-701,\\\"tc\\\":-1550862239,\\\"i\\\":true},{\\\"bt\\\":1754958769,\\\"pt\\\":-701,\\\"tc\\\":-1556758350,\\\"i\\\":true},{\\\"bt\\\":1754961672,\\\"pt\\\":-701,\\\"tc\\\":-1558793353,\\\"i\\\":true},{\\\"bt\\\":1754965697,\\\"pt\\\":-701,\\\"tc\\\":-1561614878,\\\"i\\\":true},{\\\"bt\\\":1754754661,\\\"pt\\\":-703,\\\"tc\\\":-1413817668,\\\"i\\\":true},{\\\"bt\\\":1754756514,\\\"pt\\\":-701,\\\"tc\\\":-1415116950,\\\"i\\\":true},{\\\"bt\\\":1754758587,\\\"pt\\\":-700,\\\"tc\\\":-1416568497,\\\"i\\\":true},{\\\"bt\\\":1754760519,\\\"pt\\\":-700,\\\"tc\\\":-1417920897,\\\"i\\\":true},{\\\"bt\\\":1754769542,\\\"pt\\\":-700,\\\"tc\\\":-1424236997,\\\"i\\\":true},{\\\"bt\\\":1754772300,\\\"pt\\\":-700,\\\"tc\\\":-1426167597,\\\"i\\\":true},{\\\"bt\\\":1754774133,\\\"pt\\\":-699,\\\"tc\\\":-1427450641,\\\"i\\\":true},{\\\"bt\\\":1754779489,\\\"pt\\\":-699,\\\"tc\\\":-1431194485,\\\"i\\\":true},{\\\"bt\\\":1754785142,\\\"pt\\\":-699,\\\"tc\\\":-1435145932,\\\"i\\\":true},{\\\"bt\\\":1754788789,\\\"pt\\\":-699,\\\"tc\\\":-1437695185,\\\"i\\\":true},{\\\"bt\\\":1754792542,\\\"pt\\\":-699,\\\"tc\\\":-1440318532,\\\"i\\\":true},{\\\"bt\\\":1754795167,\\\"pt\\\":-699,\\\"tc\\\":-1442153407,\\\"i\\\":true},{\\\"bt\\\":1754797380,\\\"pt\\\":-699,\\\"tc\\\":-1443700294,\\\"i\\\":true},{\\\"bt\\\":1754802899,\\\"pt\\\":-699,\\\"tc\\\":-1447558075,\\\"i\\\":true},{\\\"bt\\\":1754816958,\\\"pt\\\":-699,\\\"tc\\\":-1457385316,\\\"i\\\":true},{\\\"bt\\\":1754819525,\\\"pt\\\":-699,\\\"tc\\\":-1459179649,\\\"i\\\":true},{\\\"bt\\\":1754824018,\\\"pt\\\":-699,\\\"tc\\\":-1462320256,\\\"i\\\":true},{\\\"bt\\\":1754828592,\\\"pt\\\":-699,\\\"tc\\\":-1465517482,\\\"i\\\":true},{\\\"bt\\\":1754831875,\\\"pt\\\":-699,\\\"tc\\\":-1467812299,\\\"i\\\":true},{\\\"bt\\\":1754834529,\\\"pt\\\":-699,\\\"tc\\\":-1469667445,\\\"i\\\":true},{\\\"bt\\\":1754842014,\\\"pt\\\":-701,\\\"tc\\\":-1474913095,\\\"i\\\":true},{\\\"bt\\\":1754844450,\\\"pt\\\":-701,\\\"tc\\\":-1476620731,\\\"i\\\":true},{\\\"bt\\\":1754850130,\\\"pt\\\":-701,\\\"tc\\\":-1480602411,\\\"i\\\":true},{\\\"bt\\\":1754862160,\\\"pt\\\":-701,\\\"tc\\\":-1489035441,\\\"i\\\":true},{\\\"bt\\\":1754866077,\\\"pt\\\":-701,\\\"tc\\\":-1491781258,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"90\\\",\\\"fmax\\\":\\\"90\\\",\\\"fqm\\\":\\\"0\\\",\\\"ftsa\\\":0,\\\"sfhl\\\":\\\"60\\\",\\\"sfat\\\":120,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"76502185164610086033724320536\\\",\\\"t\\\":-701,\\\"lst\\\":1754965697,\\\"lsgt\\\":1754730019},\\\"bs\\\":{\\\"tsa\\\":86400,\\\"lp\\\":[1,255,255,236,0,10,4,67,196,48,23,215,132,0,0,20,6,222,186,96,35,195,70,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AABaAABaAAAAAAAAAAAAADwAeABkAGQAZAH0BwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"150000\\\",\\\"trtr0\\\":\\\"200000\\\",\\\"xrtr0\\\":\\\"250000\\\",\\\"mrtr1\\\":\\\"150000\\\",\\\"trtr1\\\":\\\"200000\\\",\\\"xrtr1\\\":\\\"250000\\\",\\\"c0d\\\":18,\\\"c1d\\\":18,\\\"rb0\\\":\\\"76620612965091961282\\\",\\\"rb1\\\":\\\"440302840903099373971\\\",\\\"r0\\\":\\\"389903218547825043299\\\",\\\"r1\\\":\\\"1852348007645925944033\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,12,1,6,63,54,252,103,19]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1006375959211843841\\\",\\\"sp1\\\":\\\"1000523272567918807\\\"},\\\"bt\\\":1754968829}\"}","staticExtra":"{\"0x0\":[true,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24262989}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7",
			Amount: big.NewInt(20951525654502637),
		},
		TokenOut: "0x4200000000000000000000000000000000000006",
	})
	assert.NoError(t, err)
	assert.Equal(t, "22469222712678168", got.TokenAmountOut.Amount.String())

	got, err = pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x4200000000000000000000000000000000000006",
			Amount: big.NewInt(1e12),
		},
		TokenOut: "0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7",
	})
	assert.NoError(t, err)
	assert.Equal(t, "932286562048", got.TokenAmountOut.Amount.String())
}

func Test_Pool_ETH_USDC(t *testing.T) {
	// LDF: UniformDistribution

	var p entity.Pool
	poolData := `{"address":"0x5e5bc151fdb581faf0c28ae30ceba9193da793ccd7c22a70d3feaf3408c07666","swapFee":3,"exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755411869,"reserves":["104824557597531763593","466537384305"],"tokens":[{"address":"0x4200000000000000000000000000000000000006","symbol":"WETH","decimals":18,"swappable":true},{"address":"0x078d782b760474a361dda0af3839290b0ef57ad6","symbol":"USDC","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":4871082525260561434141723,\"tickSpacing\":10,\"tick\":-193946,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"\\\",\\\"ha\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"la\\\":\\\"0x00000000d5248262c18c5a8c706b2a3e740b8760\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"6565682962688514534\\\",\\\"107084360610452\\\"],\\\"ls\\\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x5adade21c703912547bfc8952fe1b52f09437e2a\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1000096663252095790\\\",\\\"dr\\\":\\\"999903346090785401\\\",\\\"md\\\":\\\"5192296858534465013534310461932540\\\",\\\"wr\\\":\\\"999903346090785402\\\",\\\"mw\\\":\\\"99431766983438218009\\\"},{\\\"a\\\":\\\"0x6eae95ee783e4d862867c4e0e4c3f4b95aa682ba\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1014236095339416986\\\",\\\"dr\\\":\\\"985963726389906447\\\",\\\"md\\\":\\\"75930115088159\\\",\\\"wr\\\":\\\"985963726389906448\\\",\\\"mw\\\":\\\"448148607390\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":147,\\\"c\\\":169,\\\"cn\\\":169,\\\"io\\\":{\\\"bt\\\":1755411612,\\\"pt\\\":-192248,\\\"tc\\\":-412240890637,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1754838941,\\\"pt\\\":-192843,\\\"tc\\\":-302139585884,\\\"i\\\":true},{\\\"bt\\\":1754842770,\\\"pt\\\":-192843,\\\"tc\\\":-302877974858,\\\"i\\\":true},{\\\"bt\\\":1754846956,\\\"pt\\\":-192808,\\\"tc\\\":-303685110468,\\\"i\\\":true},{\\\"bt\\\":1754852438,\\\"pt\\\":-192832,\\\"tc\\\":-304742183620,\\\"i\\\":true},{\\\"bt\\\":1754856274,\\\"pt\\\":-192773,\\\"tc\\\":-305481734255,\\\"i\\\":true},{\\\"bt\\\":1754859928,\\\"pt\\\":-192876,\\\"tc\\\":-306186324028,\\\"i\\\":true},{\\\"bt\\\":1754864257,\\\"pt\\\":-192860,\\\"tc\\\":-307021285131,\\\"i\\\":true},{\\\"bt\\\":1754868020,\\\"pt\\\":-192789,\\\"tc\\\":-307746845787,\\\"i\\\":true},{\\\"bt\\\":1754871914,\\\"pt\\\":-192758,\\\"tc\\\":-308497540157,\\\"i\\\":true},{\\\"bt\\\":1754875570,\\\"pt\\\":-192704,\\\"tc\\\":-309202129394,\\\"i\\\":true},{\\\"bt\\\":1754879171,\\\"pt\\\":-192630,\\\"tc\\\":-309895779211,\\\"i\\\":true},{\\\"bt\\\":1754884383,\\\"pt\\\":-192669,\\\"tc\\\":-310899877665,\\\"i\\\":true},{\\\"bt\\\":1754889184,\\\"pt\\\":-192591,\\\"tc\\\":-311824534012,\\\"i\\\":true},{\\\"bt\\\":1754893130,\\\"pt\\\":-192647,\\\"tc\\\":-312584655481,\\\"i\\\":true},{\\\"bt\\\":1754896735,\\\"pt\\\":-192652,\\\"tc\\\":-313279158405,\\\"i\\\":true},{\\\"bt\\\":1754901355,\\\"pt\\\":-192727,\\\"tc\\\":-314169481523,\\\"i\\\":true},{\\\"bt\\\":1754905029,\\\"pt\\\":-192712,\\\"tc\\\":-314877504648,\\\"i\\\":true},{\\\"bt\\\":1754908987,\\\"pt\\\":-192763,\\\"tc\\\":-315640380528,\\\"i\\\":true},{\\\"bt\\\":1754912850,\\\"pt\\\":-192878,\\\"tc\\\":-316385289865,\\\"i\\\":true},{\\\"bt\\\":1754918269,\\\"pt\\\":-192948,\\\"tc\\\":-317430809410,\\\"i\\\":true},{\\\"bt\\\":1754921902,\\\"pt\\\":-192729,\\\"tc\\\":-318131225146,\\\"i\\\":true},{\\\"bt\\\":1754925644,\\\"pt\\\":-192710,\\\"tc\\\":-318852295045,\\\"i\\\":true},{\\\"bt\\\":1754929280,\\\"pt\\\":-192534,\\\"tc\\\":-319552643788,\\\"i\\\":true},{\\\"bt\\\":1754932923,\\\"pt\\\":-192686,\\\"tc\\\":-320254279926,\\\"i\\\":true},{\\\"bt\\\":1754937533,\\\"pt\\\":-192668,\\\"tc\\\":-321142483233,\\\"i\\\":true},{\\\"bt\\\":1754941206,\\\"pt\\\":-192666,\\\"tc\\\":-321850154583,\\\"i\\\":true},{\\\"bt\\\":1754945497,\\\"pt\\\":-192783,\\\"tc\\\":-322677333633,\\\"i\\\":true},{\\\"bt\\\":1754949177,\\\"pt\\\":-192875,\\\"tc\\\":-323386847023,\\\"i\\\":true},{\\\"bt\\\":1754953439,\\\"pt\\\":-192852,\\\"tc\\\":-324208862351,\\\"i\\\":true},{\\\"bt\\\":1754957126,\\\"pt\\\":-192830,\\\"tc\\\":-324919826905,\\\"i\\\":true},{\\\"bt\\\":1754960750,\\\"pt\\\":-192729,\\\"tc\\\":-325618487194,\\\"i\\\":true},{\\\"bt\\\":1754964556,\\\"pt\\\":-192733,\\\"tc\\\":-326351954513,\\\"i\\\":true},{\\\"bt\\\":1754968783,\\\"pt\\\":-192685,\\\"tc\\\":-327166408597,\\\"i\\\":true},{\\\"bt\\\":1754972489,\\\"pt\\\":-192673,\\\"tc\\\":-327880481650,\\\"i\\\":true},{\\\"bt\\\":1754976138,\\\"pt\\\":-192656,\\\"tc\\\":-328583437183,\\\"i\\\":true},{\\\"bt\\\":1754979937,\\\"pt\\\":-192695,\\\"tc\\\":-329315462268,\\\"i\\\":true},{\\\"bt\\\":1754983607,\\\"pt\\\":-192647,\\\"tc\\\":-330022527583,\\\"i\\\":true},{\\\"bt\\\":1754987259,\\\"pt\\\":-192644,\\\"tc\\\":-330726022985,\\\"i\\\":true},{\\\"bt\\\":1754991492,\\\"pt\\\":-192657,\\\"tc\\\":-331541455617,\\\"i\\\":true},{\\\"bt\\\":1754995331,\\\"pt\\\":-192675,\\\"tc\\\":-332281152400,\\\"i\\\":true},{\\\"bt\\\":1754998995,\\\"pt\\\":-192709,\\\"tc\\\":-332987235462,\\\"i\\\":true},{\\\"bt\\\":1755002881,\\\"pt\\\":-192421,\\\"tc\\\":-333735836184,\\\"i\\\":true},{\\\"bt\\\":1755006533,\\\"pt\\\":-192444,\\\"tc\\\":-334438551214,\\\"i\\\":true},{\\\"bt\\\":1755010148,\\\"pt\\\":-192434,\\\"tc\\\":-335134231934,\\\"i\\\":true},{\\\"bt\\\":1755014075,\\\"pt\\\":-192327,\\\"tc\\\":-335889641582,\\\"i\\\":true},{\\\"bt\\\":1755018098,\\\"pt\\\":-192300,\\\"tc\\\":-336663204831,\\\"i\\\":true},{\\\"bt\\\":1755021764,\\\"pt\\\":-192205,\\\"tc\\\":-337367939360,\\\"i\\\":true},{\\\"bt\\\":1755026194,\\\"pt\\\":-192236,\\\"tc\\\":-338219453080,\\\"i\\\":true},{\\\"bt\\\":1755029810,\\\"pt\\\":-192102,\\\"tc\\\":-338914402234,\\\"i\\\":true},{\\\"bt\\\":1755033742,\\\"pt\\\":-191967,\\\"tc\\\":-339669240187,\\\"i\\\":true},{\\\"bt\\\":1755037575,\\\"pt\\\":-192047,\\\"tc\\\":-340405210354,\\\"i\\\":true},{\\\"bt\\\":1755041270,\\\"pt\\\":-192001,\\\"tc\\\":-341114732939,\\\"i\\\":true},{\\\"bt\\\":1755045055,\\\"pt\\\":-191966,\\\"tc\\\":-341841391149,\\\"i\\\":true},{\\\"bt\\\":1755049147,\\\"pt\\\":-192027,\\\"tc\\\":-342626951200,\\\"i\\\":true},{\\\"bt\\\":1755052838,\\\"pt\\\":-191978,\\\"tc\\\":-343335690746,\\\"i\\\":true},{\\\"bt\\\":1755056546,\\\"pt\\\":-191899,\\\"tc\\\":-344047389790,\\\"i\\\":true},{\\\"bt\\\":1755060880,\\\"pt\\\":-191835,\\\"tc\\\":-344878878597,\\\"i\\\":true},{\\\"bt\\\":1755064883,\\\"pt\\\":-191918,\\\"tc\\\":-345646908647,\\\"i\\\":true},{\\\"bt\\\":1755068706,\\\"pt\\\":-191933,\\\"tc\\\":-346380625642,\\\"i\\\":true},{\\\"bt\\\":1755073511,\\\"pt\\\":-191917,\\\"tc\\\":-347302849740,\\\"i\\\":true},{\\\"bt\\\":1755077859,\\\"pt\\\":-191900,\\\"tc\\\":-348137334876,\\\"i\\\":true},{\\\"bt\\\":1755081760,\\\"pt\\\":-191778,\\\"tc\\\":-348885523743,\\\"i\\\":true},{\\\"bt\\\":1755085663,\\\"pt\\\":-191815,\\\"tc\\\":-349634065919,\\\"i\\\":true},{\\\"bt\\\":1755089296,\\\"pt\\\":-191740,\\\"tc\\\":-350330796561,\\\"i\\\":true},{\\\"bt\\\":1755092933,\\\"pt\\\":-191787,\\\"tc\\\":-351028251800,\\\"i\\\":true},{\\\"bt\\\":1755096677,\\\"pt\\\":-191803,\\\"tc\\\":-351746430541,\\\"i\\\":true},{\\\"bt\\\":1755100436,\\\"pt\\\":-191845,\\\"tc\\\":-352467679356,\\\"i\\\":true},{\\\"bt\\\":1755104206,\\\"pt\\\":-191779,\\\"tc\\\":-353190685368,\\\"i\\\":true},{\\\"bt\\\":1755107806,\\\"pt\\\":-191722,\\\"tc\\\":-353880921209,\\\"i\\\":true},{\\\"bt\\\":1755111681,\\\"pt\\\":-191739,\\\"tc\\\":-354623838733,\\\"i\\\":true},{\\\"bt\\\":1755115461,\\\"pt\\\":-191687,\\\"tc\\\":-355348485744,\\\"i\\\":true},{\\\"bt\\\":1755119135,\\\"pt\\\":-191716,\\\"tc\\\":-356052876283,\\\"i\\\":true},{\\\"bt\\\":1755122781,\\\"pt\\\":-191724,\\\"tc\\\":-356751695576,\\\"i\\\":true},{\\\"bt\\\":1755126418,\\\"pt\\\":-191663,\\\"tc\\\":-357448798170,\\\"i\\\":true},{\\\"bt\\\":1755130678,\\\"pt\\\":-191679,\\\"tc\\\":-358265229295,\\\"i\\\":true},{\\\"bt\\\":1755134282,\\\"pt\\\":-191716,\\\"tc\\\":-358956121295,\\\"i\\\":true},{\\\"bt\\\":1755138313,\\\"pt\\\":-191708,\\\"tc\\\":-359728859057,\\\"i\\\":true},{\\\"bt\\\":1755142371,\\\"pt\\\":-191637,\\\"tc\\\":-360506581631,\\\"i\\\":true},{\\\"bt\\\":1755146007,\\\"pt\\\":-191603,\\\"tc\\\":-361203288460,\\\"i\\\":true},{\\\"bt\\\":1755150159,\\\"pt\\\":-191681,\\\"tc\\\":-361999022163,\\\"i\\\":true},{\\\"bt\\\":1755153802,\\\"pt\\\":-191597,\\\"tc\\\":-362697330236,\\\"i\\\":true},{\\\"bt\\\":1755157461,\\\"pt\\\":-191659,\\\"tc\\\":-363398566125,\\\"i\\\":true},{\\\"bt\\\":1755161070,\\\"pt\\\":-191700,\\\"tc\\\":-364090335339,\\\"i\\\":true},{\\\"bt\\\":1755165069,\\\"pt\\\":-191662,\\\"tc\\\":-364856885013,\\\"i\\\":true},{\\\"bt\\\":1755168795,\\\"pt\\\":-191777,\\\"tc\\\":-365571050503,\\\"i\\\":true},{\\\"bt\\\":1755172820,\\\"pt\\\":-191740,\\\"tc\\\":-366342849479,\\\"i\\\":true},{\\\"bt\\\":1755176444,\\\"pt\\\":-192042,\\\"tc\\\":-367038085915,\\\"i\\\":true},{\\\"bt\\\":1755180164,\\\"pt\\\":-191948,\\\"tc\\\":-367752566730,\\\"i\\\":true},{\\\"bt\\\":1755183897,\\\"pt\\\":-191835,\\\"tc\\\":-368468831124,\\\"i\\\":true},{\\\"bt\\\":1755187504,\\\"pt\\\":-191930,\\\"tc\\\":-369161076621,\\\"i\\\":true},{\\\"bt\\\":1755191174,\\\"pt\\\":-192114,\\\"tc\\\":-369866049154,\\\"i\\\":true},{\\\"bt\\\":1755194819,\\\"pt\\\":-192102,\\\"tc\\\":-370566289989,\\\"i\\\":true},{\\\"bt\\\":1755198553,\\\"pt\\\":-192103,\\\"tc\\\":-371283665594,\\\"i\\\":true},{\\\"bt\\\":1755202158,\\\"pt\\\":-192151,\\\"tc\\\":-371976122705,\\\"i\\\":true},{\\\"bt\\\":1755205828,\\\"pt\\\":-192135,\\\"tc\\\":-372681252197,\\\"i\\\":true},{\\\"bt\\\":1755209428,\\\"pt\\\":-192258,\\\"tc\\\":-373373234140,\\\"i\\\":true},{\\\"bt\\\":1755213173,\\\"pt\\\":-192123,\\\"tc\\\":-374092867398,\\\"i\\\":true},{\\\"bt\\\":1755216940,\\\"pt\\\":-192065,\\\"tc\\\":-374816405987,\\\"i\\\":true},{\\\"bt\\\":1755220740,\\\"pt\\\":-192044,\\\"tc\\\":-375546206626,\\\"i\\\":true},{\\\"bt\\\":1755224619,\\\"pt\\\":-191940,\\\"tc\\\":-376290886988,\\\"i\\\":true},{\\\"bt\\\":1755228399,\\\"pt\\\":-191909,\\\"tc\\\":-377016327672,\\\"i\\\":true},{\\\"bt\\\":1755232378,\\\"pt\\\":-191907,\\\"tc\\\":-377779880074,\\\"i\\\":true},{\\\"bt\\\":1755237624,\\\"pt\\\":-191945,\\\"tc\\\":-378786739978,\\\"i\\\":true},{\\\"bt\\\":1755241257,\\\"pt\\\":-191860,\\\"tc\\\":-379483849144,\\\"i\\\":true},{\\\"bt\\\":1755246110,\\\"pt\\\":-191893,\\\"tc\\\":-380415076015,\\\"i\\\":true},{\\\"bt\\\":1755249888,\\\"pt\\\":-191883,\\\"tc\\\":-381139969593,\\\"i\\\":true},{\\\"bt\\\":1755253701,\\\"pt\\\":-191897,\\\"tc\\\":-381871725769,\\\"i\\\":true},{\\\"bt\\\":1755257362,\\\"pt\\\":-191899,\\\"tc\\\":-382574220606,\\\"i\\\":true},{\\\"bt\\\":1755261014,\\\"pt\\\":-191935,\\\"tc\\\":-383275056330,\\\"i\\\":true},{\\\"bt\\\":1755264658,\\\"pt\\\":-191946,\\\"tc\\\":-383974399906,\\\"i\\\":true},{\\\"bt\\\":1755268321,\\\"pt\\\":-192090,\\\"tc\\\":-384677891796,\\\"i\\\":true},{\\\"bt\\\":1755271932,\\\"pt\\\":-192312,\\\"tc\\\":-385371948709,\\\"i\\\":true},{\\\"bt\\\":1755275679,\\\"pt\\\":-192399,\\\"tc\\\":-386092812834,\\\"i\\\":true},{\\\"bt\\\":1755279627,\\\"pt\\\":-192361,\\\"tc\\\":-386852387895,\\\"i\\\":true},{\\\"bt\\\":1755283274,\\\"pt\\\":-192379,\\\"tc\\\":-387553879514,\\\"i\\\":true},{\\\"bt\\\":1755286969,\\\"pt\\\":-192416,\\\"tc\\\":-388264864180,\\\"i\\\":true},{\\\"bt\\\":1755290592,\\\"pt\\\":-192381,\\\"tc\\\":-388961994375,\\\"i\\\":true},{\\\"bt\\\":1755295067,\\\"pt\\\":-192379,\\\"tc\\\":-389822943715,\\\"i\\\":true},{\\\"bt\\\":1755298722,\\\"pt\\\":-192262,\\\"tc\\\":-390525977643,\\\"i\\\":true},{\\\"bt\\\":1755302359,\\\"pt\\\":-192352,\\\"tc\\\":-391225529488,\\\"i\\\":true},{\\\"bt\\\":1755306287,\\\"pt\\\":-192248,\\\"tc\\\":-391980820827,\\\"i\\\":true},{\\\"bt\\\":1755309912,\\\"pt\\\":-192240,\\\"tc\\\":-392677727848,\\\"i\\\":true},{\\\"bt\\\":1755313549,\\\"pt\\\":-192319,\\\"tc\\\":-393377040260,\\\"i\\\":true},{\\\"bt\\\":1755317972,\\\"pt\\\":-192343,\\\"tc\\\":-394227677291,\\\"i\\\":true},{\\\"bt\\\":1755321591,\\\"pt\\\":-192307,\\\"tc\\\":-394923656408,\\\"i\\\":true},{\\\"bt\\\":1755325221,\\\"pt\\\":-192372,\\\"tc\\\":-395621891090,\\\"i\\\":true},{\\\"bt\\\":1755329244,\\\"pt\\\":-192340,\\\"tc\\\":-396395768628,\\\"i\\\":true},{\\\"bt\\\":1755334166,\\\"pt\\\":-192314,\\\"tc\\\":-397342316659,\\\"i\\\":true},{\\\"bt\\\":1755337783,\\\"pt\\\":-192315,\\\"tc\\\":-398037904263,\\\"i\\\":true},{\\\"bt\\\":1755341487,\\\"pt\\\":-192420,\\\"tc\\\":-398750597223,\\\"i\\\":true},{\\\"bt\\\":1755345180,\\\"pt\\\":-192408,\\\"tc\\\":-399461131050,\\\"i\\\":true},{\\\"bt\\\":1755348947,\\\"pt\\\":-192430,\\\"tc\\\":-400186043857,\\\"i\\\":true},{\\\"bt\\\":1755353519,\\\"pt\\\":-192434,\\\"tc\\\":-401065715300,\\\"i\\\":true},{\\\"bt\\\":1755357302,\\\"pt\\\":-192409,\\\"tc\\\":-401793607079,\\\"i\\\":true},{\\\"bt\\\":1755361044,\\\"pt\\\":-192409,\\\"tc\\\":-402513628352,\\\"i\\\":true},{\\\"bt\\\":1755364747,\\\"pt\\\":-192422,\\\"tc\\\":-403226122432,\\\"i\\\":true},{\\\"bt\\\":1755368514,\\\"pt\\\":-192388,\\\"tc\\\":-403950960254,\\\"i\\\":true},{\\\"bt\\\":1755372133,\\\"pt\\\":-192389,\\\"tc\\\":-404647233513,\\\"i\\\":true},{\\\"bt\\\":1755375742,\\\"pt\\\":-192362,\\\"tc\\\":-405341477736,\\\"i\\\":true},{\\\"bt\\\":1755379975,\\\"pt\\\":-192360,\\\"tc\\\":-406155711709,\\\"i\\\":true},{\\\"bt\\\":1755383608,\\\"pt\\\":-192377,\\\"tc\\\":-406854627713,\\\"i\\\":true},{\\\"bt\\\":1755387650,\\\"pt\\\":-192378,\\\"tc\\\":-407632173127,\\\"i\\\":true},{\\\"bt\\\":1755391752,\\\"pt\\\":-192376,\\\"tc\\\":-408421311630,\\\"i\\\":true},{\\\"bt\\\":1755395372,\\\"pt\\\":-192418,\\\"tc\\\":-409117790983,\\\"i\\\":true},{\\\"bt\\\":1755399025,\\\"pt\\\":-192385,\\\"tc\\\":-409820645849,\\\"i\\\":true},{\\\"bt\\\":1755403326,\\\"pt\\\":-192309,\\\"tc\\\":-410647876319,\\\"i\\\":true},{\\\"bt\\\":1755407595,\\\"pt\\\":-192237,\\\"tc\\\":-411468645918,\\\"i\\\":true},{\\\"bt\\\":1755411256,\\\"pt\\\":-192252,\\\"tc\\\":-412172450349,\\\"i\\\":true},{\\\"bt\\\":1754756776,\\\"pt\\\":-192859,\\\"tc\\\":-286297585730,\\\"i\\\":true},{\\\"bt\\\":1754760912,\\\"pt\\\":-192851,\\\"tc\\\":-287095267591,\\\"i\\\":true},{\\\"bt\\\":1754764666,\\\"pt\\\":-192815,\\\"tc\\\":-287819111426,\\\"i\\\":true},{\\\"bt\\\":1754768534,\\\"pt\\\":-192783,\\\"tc\\\":-288564827537,\\\"i\\\":true},{\\\"bt\\\":1754772344,\\\"pt\\\":-192720,\\\"tc\\\":-289299140325,\\\"i\\\":true},{\\\"bt\\\":1754776106,\\\"pt\\\":-192712,\\\"tc\\\":-290024095739,\\\"i\\\":true},{\\\"bt\\\":1754779721,\\\"pt\\\":-192716,\\\"tc\\\":-290720641961,\\\"i\\\":true},{\\\"bt\\\":1754784174,\\\"pt\\\":-192747,\\\"tc\\\":-291578945356,\\\"i\\\":true},{\\\"bt\\\":1754788012,\\\"pt\\\":-192626,\\\"tc\\\":-292318544012,\\\"i\\\":true},{\\\"bt\\\":1754791875,\\\"pt\\\":-192660,\\\"tc\\\":-293062735455,\\\"i\\\":true},{\\\"bt\\\":1754795498,\\\"pt\\\":-192795,\\\"tc\\\":-293761025350,\\\"i\\\":true},{\\\"bt\\\":1754800003,\\\"pt\\\":-192807,\\\"tc\\\":-294629629468,\\\"i\\\":true},{\\\"bt\\\":1754803804,\\\"pt\\\":-192801,\\\"tc\\\":-295362383706,\\\"i\\\":true},{\\\"bt\\\":1754807955,\\\"pt\\\":-192861,\\\"tc\\\":-296162851342,\\\"i\\\":true},{\\\"bt\\\":1754811759,\\\"pt\\\":-192909,\\\"tc\\\":-296896417249,\\\"i\\\":true},{\\\"bt\\\":1754815836,\\\"pt\\\":-192874,\\\"tc\\\":-297682929891,\\\"i\\\":true},{\\\"bt\\\":1754819519,\\\"pt\\\":-192846,\\\"tc\\\":-298393236489,\\\"i\\\":true},{\\\"bt\\\":1754823187,\\\"pt\\\":-192870,\\\"tc\\\":-299100621492,\\\"i\\\":true},{\\\"bt\\\":1754826916,\\\"pt\\\":-192878,\\\"tc\\\":-299819905375,\\\"i\\\":true},{\\\"bt\\\":1754830663,\\\"pt\\\":-192908,\\\"tc\\\":-300542794243,\\\"i\\\":true},{\\\"bt\\\":1754834346,\\\"pt\\\":-192929,\\\"tc\\\":-301253296557,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"1000\\\",\\\"fmax\\\":\\\"7500\\\",\\\"fqm\\\":\\\"500000\\\",\\\"ftsa\\\":3600,\\\"sfhl\\\":\\\"1\\\",\\\"sfat\\\":1,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"rt\\\":0,\\\"aae\\\":false,\\\"omi\\\":3600},\\\"s0\\\":{\\\"spx96\\\":\\\"5302548610178960886039144\\\",\\\"t\\\":-192248,\\\"lst\\\":1755411612,\\\"lsgt\\\":0},\\\"bs\\\":{\\\"tsa\\\":604800,\\\"lp\\\":[3,252,241,138,253,48,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"hp\\\":\\\"AAPoAB1MB6EgAA4QAAAAAAEAAQBkAGQAAAAAAAAAAAAAAA4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":0,\\\"mrtr0\\\":\\\"50000\\\",\\\"trtr0\\\":\\\"52200\\\",\\\"xrtr0\\\":\\\"52200\\\",\\\"mrtr1\\\":\\\"50000\\\",\\\"trtr1\\\":\\\"52200\\\",\\\"xrtr1\\\":\\\"52200\\\",\\\"c0d\\\":18,\\\"c1d\\\":6,\\\"rb0\\\":\\\"5402401083072609910\\\",\\\"rb1\\\":\\\"24679113386\\\",\\\"r0\\\":\\\"99422156514459153683\\\",\\\"r1\\\":\\\"441858270919\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1000096583443453874\\\",\\\"sp1\\\":\\\"1014235630667085750\\\"},\\\"rod\\\":0,\\\"bt\\\":1755411612}\"}","staticExtra":"{\"0x0\":[true,false],\"fee\":3,\"tS\":10,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24663510}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x078d782b760474a361dda0af3839290b0ef57ad6",
			Amount: big.NewInt(4500_000_000),
		},
		TokenOut: "0x4200000000000000000000000000000000000006",
	})
	assert.NoError(t, err)
	assert.Equal(t, "1000426474295335539", got.TokenAmountOut.Amount.String())

	got, err = pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x4200000000000000000000000000000000000006",
			Amount: big.NewInt(1e18),
		},
		TokenOut: "0x078d782b760474a361dda0af3839290b0ef57ad6",
	})
	assert.NoError(t, err)
	assert.Equal(t, "4460649934", got.TokenAmountOut.Amount.String())
}

func Test_Pool_USDC_USDT(t *testing.T) {
	// LDF: CarpetedDoubleGeometric

	var p entity.Pool
	poolData := `{"address":"0xd9f673912e1da331c9e56c5f0dbc7273c0eb684617939a375ec5e227c62d6707","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755504091,"reserves":["5482789212546","15765380488591"],"tokens":[{"address":"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","symbol":"USDC","decimals":6,"swappable":true},{"address":"0xdac17f958d2ee523a2206206994597c13d831ec7","symbol":"USDT","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":79222893666315702689978882880,\"tickSpacing\":1,\"tick\":-2,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"{\\\\\\\"OverrideZeroToOne\\\\\\\":false,\\\\\\\"FeeZeroToOne\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"OverrideOneToZero\\\\\\\":false,\\\\\\\"FeeOneToZero\\\\\\\":\\\\\\\"0\\\\\\\"}\\\",\\\"ha\\\":\\\"0x00ece5a72612258f20eb24573c544f9dd8c5000c\\\",\\\"la\\\":\\\"0x000000000b757686c9596cada54fa28f8c429e0d\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"92841916942359\\\",\\\"71019497118941\\\"],\\\"ls\\\":[1,255,255,246,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0xe0a80d35bb6618cba260120b279d357978c42bce\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1047514345698780679\\\",\\\"dr\\\":\\\"954640863971094742\\\",\\\"md\\\":\\\"110806078842304\\\",\\\"wr\\\":\\\"954640863971094743\\\",\\\"mw\\\":\\\"4553406902240\\\"},{\\\"a\\\":\\\"0x7c280dbdef569e96c7919251bd2b0edf0734c5a8\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1041844468229355827\\\",\\\"dr\\\":\\\"959836166044561635\\\",\\\"md\\\":\\\"3653094287998\\\",\\\"wr\\\":\\\"959836166044561636\\\",\\\"mw\\\":\\\"2417062853137\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":7,\\\"c\\\":25,\\\"cn\\\":25,\\\"io\\\":{\\\"bt\\\":1755502847,\\\"pt\\\":-7,\\\"tc\\\":-6573732,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1755484463,\\\"pt\\\":-7,\\\"tc\\\":-6443880,\\\"i\\\":true},{\\\"bt\\\":1755486443,\\\"pt\\\":-7,\\\"tc\\\":-6457740,\\\"i\\\":true},{\\\"bt\\\":1755488399,\\\"pt\\\":-7,\\\"tc\\\":-6471432,\\\"i\\\":true},{\\\"bt\\\":1755491291,\\\"pt\\\":-7,\\\"tc\\\":-6491676,\\\"i\\\":true},{\\\"bt\\\":1755493283,\\\"pt\\\":-7,\\\"tc\\\":-6504672,\\\"i\\\":true},{\\\"bt\\\":1755497123,\\\"pt\\\":-8,\\\"tc\\\":-6533664,\\\"i\\\":true},{\\\"bt\\\":1755500087,\\\"pt\\\":-7,\\\"tc\\\":-6554412,\\\"i\\\":true},{\\\"bt\\\":1755502835,\\\"pt\\\":-7,\\\"tc\\\":-6573648,\\\"i\\\":true},{\\\"bt\\\":1755442523,\\\"pt\\\":-6,\\\"tc\\\":-6167496,\\\"i\\\":true},{\\\"bt\\\":1755444851,\\\"pt\\\":-6,\\\"tc\\\":-6181464,\\\"i\\\":true},{\\\"bt\\\":1755446663,\\\"pt\\\":-6,\\\"tc\\\":-6192336,\\\"i\\\":true},{\\\"bt\\\":1755448979,\\\"pt\\\":-6,\\\"tc\\\":-6206232,\\\"i\\\":true},{\\\"bt\\\":1755452039,\\\"pt\\\":-6,\\\"tc\\\":-6224592,\\\"i\\\":true},{\\\"bt\\\":1755453863,\\\"pt\\\":-6,\\\"tc\\\":-6235536,\\\"i\\\":true},{\\\"bt\\\":1755459719,\\\"pt\\\":-6,\\\"tc\\\":-6270672,\\\"i\\\":true},{\\\"bt\\\":1755461519,\\\"pt\\\":-7,\\\"tc\\\":-6283272,\\\"i\\\":true},{\\\"bt\\\":1755463319,\\\"pt\\\":-7,\\\"tc\\\":-6295872,\\\"i\\\":true},{\\\"bt\\\":1755467195,\\\"pt\\\":-7,\\\"tc\\\":-6323004,\\\"i\\\":true},{\\\"bt\\\":1755468995,\\\"pt\\\":-7,\\\"tc\\\":-6335604,\\\"i\\\":true},{\\\"bt\\\":1755471251,\\\"pt\\\":-7,\\\"tc\\\":-6351396,\\\"i\\\":true},{\\\"bt\\\":1755473171,\\\"pt\\\":-7,\\\"tc\\\":-6364836,\\\"i\\\":true},{\\\"bt\\\":1755474971,\\\"pt\\\":-7,\\\"tc\\\":-6377436,\\\"i\\\":true},{\\\"bt\\\":1755477275,\\\"pt\\\":-7,\\\"tc\\\":-6393564,\\\"i\\\":true},{\\\"bt\\\":1755479495,\\\"pt\\\":-7,\\\"tc\\\":-6409104,\\\"i\\\":true},{\\\"bt\\\":1755481835,\\\"pt\\\":-7,\\\"tc\\\":-6425484,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"5\\\",\\\"fmax\\\":\\\"5\\\",\\\"fqm\\\":\\\"0\\\",\\\"ftsa\\\":0,\\\"sfhl\\\":\\\"60\\\",\\\"sfat\\\":120,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"rt\\\":100,\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"79203287901213834391885852055\\\",\\\"t\\\":-7,\\\"lst\\\":1755502847,\\\"lsgt\\\":1755501863},\\\"bs\\\":{\\\"tsa\\\":43200,\\\"lp\\\":[0,255,255,253,0,4,2,250,240,128,29,205,101,0,0,4,11,235,194,0,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AAAFAAAFAAAAAAAAAAAAADwAeABkAGQAZABkBwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"100000\\\",\\\"trtr0\\\":\\\"200000\\\",\\\"xrtr0\\\":\\\"300000\\\",\\\"mrtr1\\\":\\\"100000\\\",\\\"trtr1\\\":\\\"200000\\\",\\\"xrtr1\\\":\\\"300000\\\",\\\"c0d\\\":6,\\\"c1d\\\":6,\\\"rb0\\\":\\\"1137844034040\\\",\\\"rb1\\\":\\\"3900685510550\\\",\\\"r0\\\":\\\"4344945178506\\\",\\\"r1\\\":\\\"11864694978041\\\",\\\"ib\\\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,247,4,178,47,234]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1047510601209677321\\\",\\\"sp1\\\":\\\"1041839960908456872\\\"},\\\"rod\\\":0,\\\"bt\\\":1755504083}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0x66a9893cc07d91d95644aedd05d03f95e1dba8af\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":23166618}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
			Amount: big.NewInt(1000000000),
		},
		TokenOut: "0xdac17f958d2ee523a2206206994597c13d831ec7",
	})
	assert.NoError(t, err)
	assert.Equal(t, "999366159", got.TokenAmountOut.Amount.String())

	got, err = pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0xdac17f958d2ee523a2206206994597c13d831ec7",
			Amount: big.NewInt(1000000000),
		},
		TokenOut: "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48",
	})
	assert.NoError(t, err)
	assert.Equal(t, "1000622195", got.TokenAmountOut.Amount.String())
}

func Test_Quoter(t *testing.T) {
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://ethereum.kyberengineering.io").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	sender := common.HexToAddress("0x7b42Ed932f26509465F7cE3FAF76FfCe1275312f")

	poolKey := uniswapv4.PoolKey{
		Currency0:   common.HexToAddress("0x35d8949372d46b7a3d5a56006ae77b215fc69bc0"),
		Currency1:   common.HexToAddress("0x73a15fed60bf67631dc6cd7bc5b6e8da8190acf5"),
		Fee:         big.NewInt(0),
		TickSpacing: big.NewInt(5),
		Hooks:       common.HexToAddress("0x000052423c1db6b7ff8641b85a7eefc7b2791888"),
	}

	swapParams := SwapParams{
		ZeroForOne:        true,
		AmountSpecified:   big.NewInt(-1e18),
		SqrtPriceLimitX96: minPriceLimit,
	}

	blockNumber := big.NewInt(23168171)

	var swapResult SwapResult
	_, err := rpcClient.R().SetBlockNumber(blockNumber).AddCall(&ethrpc.Call{
		ABI:    bunniQuoterABI,
		Target: "0x00000000E15009D51C6d57f7164f4Ed4996ae55C",
		Method: "quoteSwap",
		Params: []interface{}{sender, poolKey, swapParams},
	}, []interface{}{&swapResult}).Call()

	assert.NoError(t, err)
	assert.Equal(t, int64(926458182427270530), swapResult.OutputAmount.Int64())

	swapParams = SwapParams{
		ZeroForOne:        false,
		AmountSpecified:   big.NewInt(-1e18),
		SqrtPriceLimitX96: maxPriceLimit,
	}

	_, err = rpcClient.R().SetBlockNumber(blockNumber).AddCall(&ethrpc.Call{
		ABI:    bunniQuoterABI,
		Target: "0x00000000E15009D51C6d57f7164f4Ed4996ae55C",
		Method: "quoteSwap",
		Params: []interface{}{sender, poolKey, swapParams},
	}, []interface{}{&swapResult}).Call()

	assert.NoError(t, err)
	assert.Equal(t, swapResult.OutputAmount.Int64(), int64(1078516195426919954))
}

func Test_MergeSwap(t *testing.T) {
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	var p entity.Pool
	poolData := `{"address":"0x5195b3bf1daf25337b0db638c9c7dee112c9e4ddad39e9d7a1e706ba36183e73","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755504080,"reserves":["5440135239","4605837337484565637431"],"tokens":[{"address":"0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48","symbol":"USDC","decimals":6,"swappable":true},{"address":"0xda67b4284609d2d48e5d10cfac411572727dc1ed","symbol":"USN","decimals":18,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":79236286233979254986885093612738470,\"tickSpacing\":10,\"tick\":276326,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"{\\\\\\\"OverrideZeroToOne\\\\\\\":false,\\\\\\\"FeeZeroToOne\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"OverrideOneToZero\\\\\\\":false,\\\\\\\"FeeOneToZero\\\\\\\":\\\\\\\"0\\\\\\\"}\\\",\\\"ha\\\":\\\"0x0000e819b8a536cf8e5d70b9c49256911033000c\\\",\\\"la\\\":\\\"0x000000000b757686c9596cada54fa28f8c429e0d\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"92812743784206\\\",\\\"390403931228919742674\\\"],\\\"ls\\\":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x53208e965eb66841598fb8f983a41936eee6d774\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1005111681482316998\\\",\\\"dr\\\":\\\"994914314919931682\\\",\\\"md\\\":\\\"39743180774909\\\",\\\"wr\\\":\\\"994914314919931683\\\",\\\"mw\\\":\\\"4918980492\\\"},{\\\"a\\\":\\\"0xc1ff5490651b9b8d0400b0146e7fb174b90e315b\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1010141451089962771\\\",\\\"dr\\\":\\\"989960365373562342\\\",\\\"md\\\":\\\"39944594157461593993178575\\\",\\\"wr\\\":\\\"989960365373562343\\\",\\\"mw\\\":\\\"4262080591439303551251\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":0,\\\"c\\\":1,\\\"cn\\\":1,\\\"io\\\":{\\\"bt\\\":1755232499,\\\"pt\\\":276337,\\\"tc\\\":1326864794004,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1755232499,\\\"pt\\\":276337,\\\"tc\\\":1326864794004,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"100\\\",\\\"fmax\\\":\\\"100\\\",\\\"fqm\\\":\\\"0\\\",\\\"ftsa\\\":0,\\\"sfhl\\\":\\\"1\\\",\\\"sfat\\\":0,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"rt\\\":0,\\\"aae\\\":false,\\\"omi\\\":1},\\\"s0\\\":{\\\"spx96\\\":\\\"79183477722402344765056200310884806\\\",\\\"t\\\":276312,\\\"lst\\\":1755232499,\\\"lsgt\\\":0},\\\"bs\\\":{\\\"tsa\\\":0,\\\"lp\\\":[3,4,54,152,0,20,5,93,74,128,29,205,101,0,0,20,6,159,107,199,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AABkAABkAAAAAAAAAAAAAAEAAABkAGQAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":0,\\\"mrtr0\\\":\\\"50000\\\",\\\"trtr0\\\":\\\"100000\\\",\\\"xrtr0\\\":\\\"150000\\\",\\\"mrtr1\\\":\\\"50000\\\",\\\"trtr1\\\":\\\"100000\\\",\\\"xrtr1\\\":\\\"150000\\\",\\\"c0d\\\":6,\\\"c1d\\\":18,\\\"rb0\\\":\\\"546171132\\\",\\\"rb1\\\":\\\"386546477931744009316\\\",\\\"r0\\\":\\\"4893964107\\\",\\\"r1\\\":\\\"4219290859552821628115\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1004408714168430365\\\",\\\"sp1\\\":\\\"1009424790522866351\\\"},\\\"rod\\\":0,\\\"bt\\\":0}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":10,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0x66a9893cc07d91d95644aedd05d03f95e1dba8af\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":23166617}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	totalAmountIn := big.NewInt(1000000000000)
	tokenIn := "0xa0b86991c6218b36c1d19d4a2e9eb0ce3606eb48"
	tokenOut := "0xda67b4284609d2d48e5d10cfac411572727dc1ed"
	n := 20

	pSim1, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	pSim2 := pSim1.CloneState()

	amountPerSwap := new(big.Int).Div(totalAmountIn, big.NewInt(int64(n)))
	var consecutiveTotalAmountOut *big.Int

	// n consecutive swaps
	for i := range n {
		result, err := pSim1.CalcAmountOut(pool.CalcAmountOutParams{
			TokenAmountIn: pool.TokenAmount{
				Token:  tokenIn,
				Amount: amountPerSwap,
			},
			TokenOut: tokenOut,
		})

		if err != nil {
			t.Logf("Consecutive swap %d failed: %v", i+1, err)
			consecutiveTotalAmountOut = nil
			break
		}

		pSim1.UpdateBalance(pool.UpdateBalanceParams{
			TokenAmountIn:  pool.TokenAmount{Token: tokenIn, Amount: amountPerSwap},
			TokenAmountOut: *result.TokenAmountOut,
			SwapInfo:       result.SwapInfo,
		})

		if consecutiveTotalAmountOut == nil {
			consecutiveTotalAmountOut = new(big.Int).Set(result.TokenAmountOut.Amount)
		} else {
			consecutiveTotalAmountOut.Add(consecutiveTotalAmountOut, result.TokenAmountOut.Amount)
		}
	}

	// single swap
	singleResult, err := pSim2.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  tokenIn,
			Amount: totalAmountIn,
		},
		TokenOut: tokenOut,
	})

	// Compare results
	if err != nil {
		t.Logf("Single swap failed: %v", err)
		assert.Nil(t, consecutiveTotalAmountOut, "Single swap failed but consecutive swaps succeeded")
		return
	}

	singleAmountOut := singleResult.TokenAmountOut.Amount

	diff := new(big.Int).Sub(singleAmountOut, consecutiveTotalAmountOut)
	diff.Abs(diff)

	percentageBps := new(big.Int).Mul(diff, big.NewInt(10000))
	percentageBps.Div(percentageBps, singleAmountOut)

	// Assert that the diff is smaller than 1BPS
	assert.LessOrEqual(t, percentageBps.Int64(), int64(1),
		fmt.Sprintf("Difference too large for n=%d: %s basis points", n, percentageBps.String()))
}
