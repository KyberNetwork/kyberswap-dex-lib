package bunniv2

import (
	"context"
	"encoding/json"
	"math/big"
	"os"
	"testing"

	"github.com/KyberNetwork/ethrpc"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	uniswapv4 "github.com/KyberNetwork/kyberswap-dex-lib/pkg/liquidity-source/uniswap-v4"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/valueobject"
	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestHook_Track(t *testing.T) {
	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://unichain.drpc.org").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433",
		Tokens: []*entity.PoolToken{
			{
				Address: "0x078d782b760474a361dda0af3839290b0ef57ad6",
			},
			{
				Address: "0x9151434b16b9763660705744891fa906f660ecc5",
			},
		},
		StaticExtra: "{\"tickSpacing\":1}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 130,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x005af73a245d8171a0550ffae2631f12cc211888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)

	_, err = h.GetReserves(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func Test_Pool_USDC_USDT0(t *testing.T) {
	var p entity.Pool
	poolData := `{"address":"0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1754893459,"reserves":["15331823011256","13483320942298"],"tokens":[{"address":"0x078d782b760474a361dda0af3839290b0ef57ad6","symbol":"USDC","decimals":6,"swappable":true},{"address":"0x9151434b16b9763660705744891fa906f660ecc5","symbol":"USDâ‚®0","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":79208352997136529422885942753,\"tickSpacing\":1,\"tick\":-6,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"\\\",\\\"ha\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"la\\\":\\\"0x000000e22477c615223e430266ad8d5285636e30\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"114403256785713\\\",\\\"82834562127496\\\"],\\\"ls\\\":[1,255,255,250,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x6eae95ee783e4d862867c4e0e4c3f4b95aa682ba\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1013120211498743328\\\",\\\"md\\\":\\\"88199123657967\\\"},{\\\"a\\\":\\\"0xd49181c522ecdb265f0d9c175cf26fface64ead3\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1009132915726411002\\\",\\\"md\\\":\\\"70550859956556\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":13,\\\"c\\\":97,\\\"cn\\\":97,\\\"io\\\":{\\\"bt\\\":1754893358,\\\"pt\\\":-1,\\\"tc\\\":-21321589,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":3953048515,\\\"pt\\\":-974589,\\\"tc\\\":-9923440841788703,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":86400,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":4080116892,\\\"pt\\\":-6542852,\\\"tc\\\":16647030664248144,\\\"i\\\":false},{\\\"bt\\\":1749155135,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false}],\\\"hp\\\":{\\\"fmin\\\":\\\"3\\\",\\\"fmax\\\":\\\"500\\\",\\\"fqm\\\":\\\"30000\\\",\\\"ftsa\\\":43200,\\\"sfhl\\\":\\\"30\\\",\\\"sfat\\\":60,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"79225435298497883010853654402\\\",\\\"t\\\":-1,\\\"lst\\\":1754893358,\\\"lsgt\\\":1754726314},\\\"bs\\\":{\\\"h\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"tsa\\\":172800,\\\"lp\\\":[0,255,255,252,0,4,1,252,147,80,29,205,101,0,0,4,17,225,163,0,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AAADAAH0AHUwAKjAAAAAAB4APABkAGQACgAyBwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"50000\\\",\\\"trtr0\\\":\\\"100000\\\",\\\"xrtr0\\\":\\\"150000\\\",\\\"mrtr1\\\":\\\"50000\\\",\\\"trtr1\\\":\\\"100000\\\",\\\"xrtr1\\\":\\\"150000\\\",\\\"c0d\\\":6,\\\"c1d\\\":6,\\\"rb0\\\":\\\"1639038214799\\\",\\\"rb1\\\":\\\"1574967434740\\\",\\\"r0\\\":\\\"13692784796457\\\",\\\"r1\\\":\\\"11908353507558\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,75,181,251,60,160]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1013119954104477272\\\",\\\"sp1\\\":\\\"1009132861441002221\\\"},\\\"bt\\\":1754726315}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x005af73a245d8171a0550ffae2631f12cc211888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24145096}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x078d782b760474a361dda0af3839290b0ef57ad6",
			Amount: big.NewInt(153000000),
		},
		TokenOut: "0x9151434b16b9763660705744891fa906f660ecc5",
	})
	assert.NoError(t, err)
	assert.Equal(t, "152912892", got.TokenAmountOut.Amount.String())
}

func Test_Pool_WETH_USDC(t *testing.T) {
	var p entity.Pool
	poolData := `{"address":"0x291d7697ea4347985e30aea48455a2f969c4ab99f45873716a89ee7027dead9f","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1754893459,"reserves":["119576933511","53"],"tokens":[{"address":"0x4200000000000000000000000000000000000006","symbol":"WETH","decimals":18,"swappable":true},{"address":"0x078d782b760474a361dda0af3839290b0ef57ad6","symbol":"USDC","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":4130658805216823088423166,\"tickSpacing\":60,\"tick\":-197243,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"\\\",\\\"ha\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"la\\\":\\\"0x000000e22477c615223e430266ad8d5285636e30\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"7089602534882424571\\\",\\\"114403256785713\\\"],\\\"ls\\\":[1,252,245,224,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"d\\\":0,\\\"rr\\\":\\\"0\\\",\\\"md\\\":\\\"0\\\"},{\\\"a\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"d\\\":0,\\\"rr\\\":\\\"0\\\",\\\"md\\\":\\\"0\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":7,\\\"c\\\":8,\\\"cn\\\":8,\\\"io\\\":{\\\"bt\\\":1750599488,\\\"pt\\\":-197940,\\\"tc\\\":-321316004545,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false},{\\\"bt\\\":0,\\\"pt\\\":0,\\\"tc\\\":0,\\\"i\\\":false}],\\\"hp\\\":{\\\"fmin\\\":\\\"2940\\\",\\\"fmax\\\":\\\"100000\\\",\\\"fqm\\\":\\\"5000000\\\",\\\"ftsa\\\":86400,\\\"sfhl\\\":\\\"60\\\",\\\"sfat\\\":120,\\\"vst0\\\":\\\"1\\\",\\\"vst1\\\":\\\"1\\\",\\\"aae\\\":true,\\\"omi\\\":86400},\\\"s0\\\":{\\\"spx96\\\":\\\"3900313990015240686201928\\\",\\\"t\\\":-198391,\\\"lst\\\":1750599488,\\\"lsgt\\\":1750028739},\\\"bs\\\":{\\\"h\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"tsa\\\":604800,\\\"lp\\\":[0,255,251,80,0,20,5,215,92,128,29,205,101,0,0,20,6,20,101,128,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AAt8AYagTEtAAVGAAYagADwAeAABAAEAAAAAAAAAAAEAAVGAAAHYg0G7AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"0\\\",\\\"trtr0\\\":\\\"0\\\",\\\"xrtr0\\\":\\\"0\\\",\\\"mrtr1\\\":\\\"0\\\",\\\"trtr1\\\":\\\"0\\\",\\\"xrtr1\\\":\\\"0\\\",\\\"c0d\\\":18,\\\"c1d\\\":6,\\\"rb0\\\":\\\"119576933511\\\",\\\"rb1\\\":\\\"53\\\",\\\"r0\\\":\\\"0\\\",\\\"r1\\\":\\\"0\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,17,187,181,67,234]},\\\"vsp\\\":{\\\"i\\\":false,\\\"sp0\\\":\\\"0\\\",\\\"sp1\\\":\\\"0\\\"},\\\"bt\\\":0}\"}","staticExtra":"{\"0x0\":[true,false],\"fee\":0,\"tS\":60,\"hooks\":\"0x005af73a245d8171a0550ffae2631f12cc211888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24145096}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x4200000000000000000000000000000000000006",
			Amount: big.NewInt(1e18),
		},
		TokenOut: "0x078d782b760474a361dda0af3839290b0ef57ad6",
	})
	assert.NoError(t, err)
	assert.Equal(t, "152912892", got.TokenAmountOut.Amount.String())
}
