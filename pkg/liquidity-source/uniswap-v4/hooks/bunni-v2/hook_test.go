package bunniv2

import (
	"context"
	"encoding/json"
	"math/big"
	"os"
	"testing"

	"github.com/KyberNetwork/ethrpc"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	uniswapv4 "github.com/KyberNetwork/kyberswap-dex-lib/pkg/liquidity-source/uniswap-v4"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/valueobject"
	"github.com/ethereum/go-ethereum/common"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

var (
	minPriceLimit, _ = new(big.Int).SetString("4295128740", 10)
	maxPriceLimit, _ = new(big.Int).SetString("1461446703485210103287273052203988822378723970341", 10)
)

func TestHookV121_Track(t *testing.T) {
	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://unichain.drpc.org").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0xe7b110a6045c9e17b97902a414604b96ef0ccd227abbb0f0761da09437522e4d",
		Tokens: []*entity.PoolToken{
			{
				Address: "0x4200000000000000000000000000000000000006",
			},
			{
				Address: "0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7",
			},
		},
		StaticExtra: "{\"tickSpacing\":1}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 130,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x000052423c1dB6B7ff8641b85A7eEfc7B2791888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)

	_, err = h.GetReserves(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func TestHookV120_Track(t *testing.T) {
	t.Parallel()
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://unichain.drpc.org").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	p := &entity.Pool{
		Address: "0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433",
		Tokens: []*entity.PoolToken{
			{
				Address: "0x078d782b760474a361dda0af3839290b0ef57ad6",
			},
			{
				Address: "0x9151434b16b9763660705744891fa906f660ecc5",
			},
		},
		StaticExtra: "{\"tickSpacing\":1}",
	}

	cfg := &uniswapv4.Config{
		ChainID: 130,
	}

	hookExtra := ""

	h := NewHook(&uniswapv4.HookParam{
		Cfg:         cfg,
		RpcClient:   rpcClient,
		HookAddress: common.HexToAddress("0x005af73a245d8171a0550ffae2631f12cc211888"),
		Pool:        p,
	})

	_, err := h.Track(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)

	_, err = h.GetReserves(context.Background(), &uniswapv4.HookParam{
		Cfg:       cfg,
		RpcClient: rpcClient,
		Pool:      p,
		HookExtra: hookExtra,
	})

	require.NoError(t, err)
}

func Test_Pool_V120(t *testing.T) {
	var p entity.Pool
	poolData := `{"address":"0xeec51c6b1a9e7c4bb4fc4fa9a02fc4fff3fe94efd044f895d98b5bfbd2ff9433","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755011341,"reserves":["14713438633073","8274469726354"],"tokens":[{"address":"0x078d782b760474a361dda0af3839290b0ef57ad6","symbol":"USDC","decimals":6,"swappable":true},{"address":"0x9151434b16b9763660705744891fa906f660ecc5","symbol":"USDâ‚®0","decimals":6,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":79208352997136529422885942753,\"tickSpacing\":1,\"tick\":-6,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"\\\",\\\"ha\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"la\\\":\\\"0x000000e22477c615223e430266ad8d5285636e30\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"112325768710412\\\",\\\"73690384196698\\\"],\\\"ls\\\":[1,255,255,251,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x6eae95ee783e4d862867c4e0e4c3f4b95aa682ba\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1013345124258967125\\\",\\\"md\\\":\\\"86240534425371\\\"},{\\\"a\\\":\\\"0xd49181c522ecdb265f0d9c175cf26fface64ead3\\\",\\\"d\\\":6,\\\"rr\\\":\\\"1009198309813133266\\\",\\\"md\\\":\\\"77087553305944\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":44,\\\"c\\\":97,\\\"cn\\\":97,\\\"io\\\":{\\\"bt\\\":1754968828,\\\"pt\\\":-2,\\\"tc\\\":-21375642,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1754863967,\\\"pt\\\":-2,\\\"tc\\\":-21248420,\\\"i\\\":true},{\\\"bt\\\":1754867052,\\\"pt\\\":-2,\\\"tc\\\":-21254590,\\\"i\\\":true},{\\\"bt\\\":1754869018,\\\"pt\\\":-3,\\\"tc\\\":-21258767,\\\"i\\\":true},{\\\"bt\\\":1754871282,\\\"pt\\\":-3,\\\"tc\\\":-21265559,\\\"i\\\":true},{\\\"bt\\\":1754874147,\\\"pt\\\":-3,\\\"tc\\\":-21274154,\\\"i\\\":true},{\\\"bt\\\":1754875986,\\\"pt\\\":-3,\\\"tc\\\":-21279671,\\\"i\\\":true},{\\\"bt\\\":1754878004,\\\"pt\\\":-3,\\\"tc\\\":-21285725,\\\"i\\\":true},{\\\"bt\\\":1754879813,\\\"pt\\\":-3,\\\"tc\\\":-21291152,\\\"i\\\":true},{\\\"bt\\\":1754883338,\\\"pt\\\":-3,\\\"tc\\\":-21301727,\\\"i\\\":true},{\\\"bt\\\":1754885472,\\\"pt\\\":-3,\\\"tc\\\":-21308129,\\\"i\\\":true},{\\\"bt\\\":1754887281,\\\"pt\\\":-2,\\\"tc\\\":-21311934,\\\"i\\\":true},{\\\"bt\\\":1754889520,\\\"pt\\\":-2,\\\"tc\\\":-21316412,\\\"i\\\":true},{\\\"bt\\\":1754891335,\\\"pt\\\":-1,\\\"tc\\\":-21319566,\\\"i\\\":true},{\\\"bt\\\":1754893358,\\\"pt\\\":-1,\\\"tc\\\":-21321589,\\\"i\\\":true},{\\\"bt\\\":1754897396,\\\"pt\\\":-1,\\\"tc\\\":-21325627,\\\"i\\\":true},{\\\"bt\\\":1754899522,\\\"pt\\\":-1,\\\"tc\\\":-21327753,\\\"i\\\":true},{\\\"bt\\\":1754901604,\\\"pt\\\":-1,\\\"tc\\\":-21329835,\\\"i\\\":true},{\\\"bt\\\":1754903453,\\\"pt\\\":-1,\\\"tc\\\":-21331684,\\\"i\\\":true},{\\\"bt\\\":1754905693,\\\"pt\\\":-1,\\\"tc\\\":-21333924,\\\"i\\\":true},{\\\"bt\\\":1754907589,\\\"pt\\\":-1,\\\"tc\\\":-21335820,\\\"i\\\":true},{\\\"bt\\\":1754909638,\\\"pt\\\":-1,\\\"tc\\\":-21337869,\\\"i\\\":true},{\\\"bt\\\":1754911877,\\\"pt\\\":-1,\\\"tc\\\":-21340108,\\\"i\\\":true},{\\\"bt\\\":1754914106,\\\"pt\\\":-1,\\\"tc\\\":-21342337,\\\"i\\\":true},{\\\"bt\\\":1754915966,\\\"pt\\\":0,\\\"tc\\\":-21344011,\\\"i\\\":true},{\\\"bt\\\":1754917879,\\\"pt\\\":1,\\\"tc\\\":-21342878,\\\"i\\\":true},{\\\"bt\\\":1754919728,\\\"pt\\\":1,\\\"tc\\\":-21341543,\\\"i\\\":true},{\\\"bt\\\":1754921828,\\\"pt\\\":1,\\\"tc\\\":-21339443,\\\"i\\\":true},{\\\"bt\\\":1754924027,\\\"pt\\\":1,\\\"tc\\\":-21337244,\\\"i\\\":true},{\\\"bt\\\":1754925846,\\\"pt\\\":1,\\\"tc\\\":-21335425,\\\"i\\\":true},{\\\"bt\\\":1754927832,\\\"pt\\\":1,\\\"tc\\\":-21333439,\\\"i\\\":true},{\\\"bt\\\":1754929921,\\\"pt\\\":0,\\\"tc\\\":-21332752,\\\"i\\\":true},{\\\"bt\\\":1754931765,\\\"pt\\\":0,\\\"tc\\\":-21332752,\\\"i\\\":true},{\\\"bt\\\":1754933568,\\\"pt\\\":0,\\\"tc\\\":-21332752,\\\"i\\\":true},{\\\"bt\\\":1754935803,\\\"pt\\\":0,\\\"tc\\\":-21332752,\\\"i\\\":true},{\\\"bt\\\":1754939523,\\\"pt\\\":-1,\\\"tc\\\":-21336171,\\\"i\\\":true},{\\\"bt\\\":1754941542,\\\"pt\\\":-1,\\\"tc\\\":-21338190,\\\"i\\\":true},{\\\"bt\\\":1754944128,\\\"pt\\\":-1,\\\"tc\\\":-21340776,\\\"i\\\":true},{\\\"bt\\\":1754946206,\\\"pt\\\":-1,\\\"tc\\\":-21342854,\\\"i\\\":true},{\\\"bt\\\":1754948072,\\\"pt\\\":-1,\\\"tc\\\":-21344720,\\\"i\\\":true},{\\\"bt\\\":1754952133,\\\"pt\\\":-1,\\\"tc\\\":-21348781,\\\"i\\\":true},{\\\"bt\\\":1754954141,\\\"pt\\\":-1,\\\"tc\\\":-21350789,\\\"i\\\":true},{\\\"bt\\\":1754957245,\\\"pt\\\":-1,\\\"tc\\\":-21353893,\\\"i\\\":true},{\\\"bt\\\":1754961276,\\\"pt\\\":-2,\\\"tc\\\":-21360538,\\\"i\\\":true},{\\\"bt\\\":1754966850,\\\"pt\\\":-2,\\\"tc\\\":-21371686,\\\"i\\\":true},{\\\"bt\\\":1754968828,\\\"pt\\\":-2,\\\"tc\\\":-21375642,\\\"i\\\":true},{\\\"bt\\\":1754739622,\\\"pt\\\":-3,\\\"tc\\\":-20946075,\\\"i\\\":true},{\\\"bt\\\":1754741442,\\\"pt\\\":-3,\\\"tc\\\":-20951535,\\\"i\\\":true},{\\\"bt\\\":1754744677,\\\"pt\\\":-3,\\\"tc\\\":-20961240,\\\"i\\\":true},{\\\"bt\\\":1754747119,\\\"pt\\\":-3,\\\"tc\\\":-20968566,\\\"i\\\":true},{\\\"bt\\\":1754750853,\\\"pt\\\":-2,\\\"tc\\\":-20976947,\\\"i\\\":true},{\\\"bt\\\":1754753012,\\\"pt\\\":-2,\\\"tc\\\":-20981265,\\\"i\\\":true},{\\\"bt\\\":1754755069,\\\"pt\\\":-2,\\\"tc\\\":-20985379,\\\"i\\\":true},{\\\"bt\\\":1754757583,\\\"pt\\\":-2,\\\"tc\\\":-20990407,\\\"i\\\":true},{\\\"bt\\\":1754760929,\\\"pt\\\":-2,\\\"tc\\\":-20997099,\\\"i\\\":true},{\\\"bt\\\":1754762841,\\\"pt\\\":-2,\\\"tc\\\":-21000923,\\\"i\\\":true},{\\\"bt\\\":1754764883,\\\"pt\\\":-2,\\\"tc\\\":-21005007,\\\"i\\\":true},{\\\"bt\\\":1754766786,\\\"pt\\\":-2,\\\"tc\\\":-21008813,\\\"i\\\":true},{\\\"bt\\\":1754769613,\\\"pt\\\":-2,\\\"tc\\\":-21014467,\\\"i\\\":true},{\\\"bt\\\":1754771498,\\\"pt\\\":-3,\\\"tc\\\":-21019059,\\\"i\\\":true},{\\\"bt\\\":1754773812,\\\"pt\\\":-3,\\\"tc\\\":-21026001,\\\"i\\\":true},{\\\"bt\\\":1754775831,\\\"pt\\\":-3,\\\"tc\\\":-21032058,\\\"i\\\":true},{\\\"bt\\\":1754778193,\\\"pt\\\":-3,\\\"tc\\\":-21039144,\\\"i\\\":true},{\\\"bt\\\":1754781757,\\\"pt\\\":-3,\\\"tc\\\":-21049836,\\\"i\\\":true},{\\\"bt\\\":1754784168,\\\"pt\\\":-3,\\\"tc\\\":-21057069,\\\"i\\\":true},{\\\"bt\\\":1754786161,\\\"pt\\\":-3,\\\"tc\\\":-21063048,\\\"i\\\":true},{\\\"bt\\\":1754788291,\\\"pt\\\":-3,\\\"tc\\\":-21069438,\\\"i\\\":true},{\\\"bt\\\":1754790253,\\\"pt\\\":-3,\\\"tc\\\":-21075324,\\\"i\\\":true},{\\\"bt\\\":1754792091,\\\"pt\\\":-3,\\\"tc\\\":-21080838,\\\"i\\\":true},{\\\"bt\\\":1754794753,\\\"pt\\\":-3,\\\"tc\\\":-21088824,\\\"i\\\":true},{\\\"bt\\\":1754800105,\\\"pt\\\":-3,\\\"tc\\\":-21104880,\\\"i\\\":true},{\\\"bt\\\":1754802322,\\\"pt\\\":-3,\\\"tc\\\":-21111531,\\\"i\\\":true},{\\\"bt\\\":1754804703,\\\"pt\\\":-3,\\\"tc\\\":-21118674,\\\"i\\\":true},{\\\"bt\\\":1754806554,\\\"pt\\\":-3,\\\"tc\\\":-21124227,\\\"i\\\":true},{\\\"bt\\\":1754811731,\\\"pt\\\":-3,\\\"tc\\\":-21139758,\\\"i\\\":true},{\\\"bt\\\":1754813654,\\\"pt\\\":-3,\\\"tc\\\":-21145527,\\\"i\\\":true},{\\\"bt\\\":1754815481,\\\"pt\\\":-3,\\\"tc\\\":-21151008,\\\"i\\\":true},{\\\"bt\\\":1754817767,\\\"pt\\\":-2,\\\"tc\\\":-21156020,\\\"i\\\":true},{\\\"bt\\\":1754820039,\\\"pt\\\":-2,\\\"tc\\\":-21160564,\\\"i\\\":true},{\\\"bt\\\":1754822451,\\\"pt\\\":-2,\\\"tc\\\":-21165388,\\\"i\\\":true},{\\\"bt\\\":1754824915,\\\"pt\\\":-2,\\\"tc\\\":-21170316,\\\"i\\\":true},{\\\"bt\\\":1754826772,\\\"pt\\\":-2,\\\"tc\\\":-21174030,\\\"i\\\":true},{\\\"bt\\\":1754828741,\\\"pt\\\":-2,\\\"tc\\\":-21177968,\\\"i\\\":true},{\\\"bt\\\":1754832558,\\\"pt\\\":-2,\\\"tc\\\":-21185602,\\\"i\\\":true},{\\\"bt\\\":1754834592,\\\"pt\\\":-2,\\\"tc\\\":-21189670,\\\"i\\\":true},{\\\"bt\\\":1754836564,\\\"pt\\\":-2,\\\"tc\\\":-21193614,\\\"i\\\":true},{\\\"bt\\\":1754838417,\\\"pt\\\":-2,\\\"tc\\\":-21197320,\\\"i\\\":true},{\\\"bt\\\":1754840484,\\\"pt\\\":-2,\\\"tc\\\":-21201454,\\\"i\\\":true},{\\\"bt\\\":1754842586,\\\"pt\\\":-2,\\\"tc\\\":-21205658,\\\"i\\\":true},{\\\"bt\\\":1754844474,\\\"pt\\\":-2,\\\"tc\\\":-21209434,\\\"i\\\":true},{\\\"bt\\\":1754846577,\\\"pt\\\":-2,\\\"tc\\\":-21213640,\\\"i\\\":true},{\\\"bt\\\":1754848460,\\\"pt\\\":-2,\\\"tc\\\":-21217406,\\\"i\\\":true},{\\\"bt\\\":1754850397,\\\"pt\\\":-2,\\\"tc\\\":-21221280,\\\"i\\\":true},{\\\"bt\\\":1754852541,\\\"pt\\\":-2,\\\"tc\\\":-21225568,\\\"i\\\":true},{\\\"bt\\\":1754854977,\\\"pt\\\":-2,\\\"tc\\\":-21230440,\\\"i\\\":true},{\\\"bt\\\":1754856830,\\\"pt\\\":-2,\\\"tc\\\":-21234146,\\\"i\\\":true},{\\\"bt\\\":1754859802,\\\"pt\\\":-2,\\\"tc\\\":-21240090,\\\"i\\\":true},{\\\"bt\\\":1754861607,\\\"pt\\\":-2,\\\"tc\\\":-21243700,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"3\\\",\\\"fmax\\\":\\\"500\\\",\\\"fqm\\\":\\\"30000\\\",\\\"ftsa\\\":43200,\\\"sfhl\\\":\\\"30\\\",\\\"sfat\\\":60,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"79224173246985989186919339134\\\",\\\"t\\\":-2,\\\"lst\\\":1754968828,\\\"lsgt\\\":1754928776},\\\"bs\\\":{\\\"tsa\\\":172800,\\\"lp\\\":[0,255,255,252,0,4,1,252,147,80,29,205,101,0,0,4,17,225,163,0,29,205,101,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AAADAAH0AHUwAKjAAAAAAB4APABkAGQACgAyBwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"50000\\\",\\\"trtr0\\\":\\\"100000\\\",\\\"xrtr0\\\":\\\"150000\\\",\\\"mrtr1\\\":\\\"50000\\\",\\\"trtr1\\\":\\\"100000\\\",\\\"xrtr1\\\":\\\"150000\\\",\\\"c0d\\\":6,\\\"c1d\\\":6,\\\"rb0\\\":\\\"2363992233218\\\",\\\"rb1\\\":\\\"827026445372\\\",\\\"r0\\\":\\\"16950594868796\\\",\\\"r1\\\":\\\"7152894616530\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,97,223,22,69,152]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1013344663603010588\\\",\\\"sp1\\\":\\\"1009198001379183896\\\"},\\\"bt\\\":1754969019}\"}","staticExtra":"{\"0x0\":[false,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x005af73a245d8171a0550ffae2631f12cc211888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24262983}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x9151434b16b9763660705744891fa906f660ecc5",
			Amount: big.NewInt(6439251628),
		},
		TokenOut: "0x078d782b760474a361dda0af3839290b0ef57ad6",
	})
	assert.NoError(t, err)
	assert.Equal(t, "6439873989", got.TokenAmountOut.Amount.String())
}

func Test_Pool_ETH_weETH(t *testing.T) {
	var p entity.Pool
	poolData := `{"address":"0x6923777072439713c7b8ab34903e0ea96078d7148449bf54f420320d59ede857","exchange":"uniswap-v4-bunni-v2","type":"uniswap-v4","timestamp":1755011346,"reserves":["510310446574865978291","2242415103319037855778"],"tokens":[{"address":"0x4200000000000000000000000000000000000006","symbol":"WETH","decimals":18,"swappable":true},{"address":"0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7","symbol":"weETH","decimals":18,"swappable":true}],"extra":"{\"liquidity\":0,\"sqrtPriceX96\":76540554206939071665077752050,\"tickSpacing\":1,\"tick\":-691,\"ticks\":null,\"hX\":\"{\\\"he\\\":\\\"{\\\\\\\"OverrideZeroToOne\\\\\\\":false,\\\\\\\"FeeZeroToOne\\\\\\\":\\\\\\\"0\\\\\\\",\\\\\\\"OverrideOneToZero\\\\\\\":false,\\\\\\\"FeeOneToZero\\\\\\\":\\\\\\\"0\\\\\\\"}\\\",\\\"ha\\\":\\\"0x00ece5a72612258f20eb24573c544f9dd8c5000c\\\",\\\"la\\\":\\\"0x000000000b757686c9596cada54fa28f8c429e0d\\\",\\\"hf\\\":\\\"0\\\",\\\"pmr\\\":[\\\"7512203649770257870\\\",\\\"5067072175697026613941\\\"],\\\"ls\\\":[1,255,253,45,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],\\\"v\\\":[{\\\"a\\\":\\\"0x1f3134c3f3f8add904b9635acbefc0ea0d0e1ffc\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1006377284619589049\\\",\\\"md\\\":\\\"8485582981085092884070\\\"},{\\\"a\\\":\\\"0xe36da4ea4d07e54b1029ef26a896a656a3729f86\\\",\\\"d\\\":18,\\\"rr\\\":\\\"1000523276644768340\\\",\\\"md\\\":\\\"16597303290790431274960\\\"}],\\\"aa\\\":{\\\"am\\\":\\\"0x0000000000000000000000000000000000000000\\\",\\\"sf01\\\":\\\"0\\\",\\\"sf10\\\":\\\"0\\\"},\\\"os\\\":{\\\"i\\\":23,\\\"c\\\":49,\\\"cn\\\":49,\\\"io\\\":{\\\"bt\\\":1754965697,\\\"pt\\\":-701,\\\"tc\\\":-1561614878,\\\"i\\\":true}},\\\"cf\\\":{\\\"fr\\\":\\\"0\\\"},\\\"o\\\":[{\\\"bt\\\":1754870161,\\\"pt\\\":-701,\\\"tc\\\":-1494644142,\\\"i\\\":true},{\\\"bt\\\":1754872173,\\\"pt\\\":-701,\\\"tc\\\":-1496054554,\\\"i\\\":true},{\\\"bt\\\":1754875456,\\\"pt\\\":-701,\\\"tc\\\":-1498355937,\\\"i\\\":true},{\\\"bt\\\":1754880944,\\\"pt\\\":-701,\\\"tc\\\":-1502203025,\\\"i\\\":true},{\\\"bt\\\":1754891448,\\\"pt\\\":-701,\\\"tc\\\":-1509566329,\\\"i\\\":true},{\\\"bt\\\":1754893965,\\\"pt\\\":-701,\\\"tc\\\":-1511330746,\\\"i\\\":true},{\\\"bt\\\":1754897031,\\\"pt\\\":-701,\\\"tc\\\":-1513480012,\\\"i\\\":true},{\\\"bt\\\":1754908532,\\\"pt\\\":-701,\\\"tc\\\":-1521542213,\\\"i\\\":true},{\\\"bt\\\":1754917902,\\\"pt\\\":-701,\\\"tc\\\":-1528110583,\\\"i\\\":true},{\\\"bt\\\":1754922040,\\\"pt\\\":-701,\\\"tc\\\":-1531011321,\\\"i\\\":true},{\\\"bt\\\":1754924055,\\\"pt\\\":-701,\\\"tc\\\":-1532423836,\\\"i\\\":true},{\\\"bt\\\":1754926436,\\\"pt\\\":-701,\\\"tc\\\":-1534092917,\\\"i\\\":true},{\\\"bt\\\":1754928293,\\\"pt\\\":-701,\\\"tc\\\":-1535394674,\\\"i\\\":true},{\\\"bt\\\":1754933891,\\\"pt\\\":-701,\\\"tc\\\":-1539318872,\\\"i\\\":true},{\\\"bt\\\":1754935970,\\\"pt\\\":-701,\\\"tc\\\":-1540776251,\\\"i\\\":true},{\\\"bt\\\":1754937970,\\\"pt\\\":-701,\\\"tc\\\":-1542178251,\\\"i\\\":true},{\\\"bt\\\":1754939952,\\\"pt\\\":-701,\\\"tc\\\":-1543567633,\\\"i\\\":true},{\\\"bt\\\":1754941856,\\\"pt\\\":-701,\\\"tc\\\":-1544902337,\\\"i\\\":true},{\\\"bt\\\":1754944028,\\\"pt\\\":-701,\\\"tc\\\":-1546424909,\\\"i\\\":true},{\\\"bt\\\":1754947872,\\\"pt\\\":-701,\\\"tc\\\":-1549119553,\\\"i\\\":true},{\\\"bt\\\":1754950358,\\\"pt\\\":-701,\\\"tc\\\":-1550862239,\\\"i\\\":true},{\\\"bt\\\":1754958769,\\\"pt\\\":-701,\\\"tc\\\":-1556758350,\\\"i\\\":true},{\\\"bt\\\":1754961672,\\\"pt\\\":-701,\\\"tc\\\":-1558793353,\\\"i\\\":true},{\\\"bt\\\":1754965697,\\\"pt\\\":-701,\\\"tc\\\":-1561614878,\\\"i\\\":true},{\\\"bt\\\":1754754661,\\\"pt\\\":-703,\\\"tc\\\":-1413817668,\\\"i\\\":true},{\\\"bt\\\":1754756514,\\\"pt\\\":-701,\\\"tc\\\":-1415116950,\\\"i\\\":true},{\\\"bt\\\":1754758587,\\\"pt\\\":-700,\\\"tc\\\":-1416568497,\\\"i\\\":true},{\\\"bt\\\":1754760519,\\\"pt\\\":-700,\\\"tc\\\":-1417920897,\\\"i\\\":true},{\\\"bt\\\":1754769542,\\\"pt\\\":-700,\\\"tc\\\":-1424236997,\\\"i\\\":true},{\\\"bt\\\":1754772300,\\\"pt\\\":-700,\\\"tc\\\":-1426167597,\\\"i\\\":true},{\\\"bt\\\":1754774133,\\\"pt\\\":-699,\\\"tc\\\":-1427450641,\\\"i\\\":true},{\\\"bt\\\":1754779489,\\\"pt\\\":-699,\\\"tc\\\":-1431194485,\\\"i\\\":true},{\\\"bt\\\":1754785142,\\\"pt\\\":-699,\\\"tc\\\":-1435145932,\\\"i\\\":true},{\\\"bt\\\":1754788789,\\\"pt\\\":-699,\\\"tc\\\":-1437695185,\\\"i\\\":true},{\\\"bt\\\":1754792542,\\\"pt\\\":-699,\\\"tc\\\":-1440318532,\\\"i\\\":true},{\\\"bt\\\":1754795167,\\\"pt\\\":-699,\\\"tc\\\":-1442153407,\\\"i\\\":true},{\\\"bt\\\":1754797380,\\\"pt\\\":-699,\\\"tc\\\":-1443700294,\\\"i\\\":true},{\\\"bt\\\":1754802899,\\\"pt\\\":-699,\\\"tc\\\":-1447558075,\\\"i\\\":true},{\\\"bt\\\":1754816958,\\\"pt\\\":-699,\\\"tc\\\":-1457385316,\\\"i\\\":true},{\\\"bt\\\":1754819525,\\\"pt\\\":-699,\\\"tc\\\":-1459179649,\\\"i\\\":true},{\\\"bt\\\":1754824018,\\\"pt\\\":-699,\\\"tc\\\":-1462320256,\\\"i\\\":true},{\\\"bt\\\":1754828592,\\\"pt\\\":-699,\\\"tc\\\":-1465517482,\\\"i\\\":true},{\\\"bt\\\":1754831875,\\\"pt\\\":-699,\\\"tc\\\":-1467812299,\\\"i\\\":true},{\\\"bt\\\":1754834529,\\\"pt\\\":-699,\\\"tc\\\":-1469667445,\\\"i\\\":true},{\\\"bt\\\":1754842014,\\\"pt\\\":-701,\\\"tc\\\":-1474913095,\\\"i\\\":true},{\\\"bt\\\":1754844450,\\\"pt\\\":-701,\\\"tc\\\":-1476620731,\\\"i\\\":true},{\\\"bt\\\":1754850130,\\\"pt\\\":-701,\\\"tc\\\":-1480602411,\\\"i\\\":true},{\\\"bt\\\":1754862160,\\\"pt\\\":-701,\\\"tc\\\":-1489035441,\\\"i\\\":true},{\\\"bt\\\":1754866077,\\\"pt\\\":-701,\\\"tc\\\":-1491781258,\\\"i\\\":true}],\\\"hp\\\":{\\\"fmin\\\":\\\"90\\\",\\\"fmax\\\":\\\"90\\\",\\\"fqm\\\":\\\"0\\\",\\\"ftsa\\\":0,\\\"sfhl\\\":\\\"60\\\",\\\"sfat\\\":120,\\\"vst0\\\":\\\"100\\\",\\\"vst1\\\":\\\"100\\\",\\\"aae\\\":false,\\\"omi\\\":1800},\\\"s0\\\":{\\\"spx96\\\":\\\"76502185164610086033724320536\\\",\\\"t\\\":-701,\\\"lst\\\":1754965697,\\\"lsgt\\\":1754730019},\\\"bs\\\":{\\\"tsa\\\":86400,\\\"lp\\\":[1,255,255,236,0,10,4,67,196,48,23,215,132,0,0,20,6,222,186,96,35,195,70,0,59,154,202,0,0,0,0,0],\\\"hp\\\":\\\"AABaAABaAAAAAAAAAAAAADwAeABkAGQAZAH0BwgBLAAAAAcIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==\\\",\\\"lt\\\":2,\\\"mrtr0\\\":\\\"150000\\\",\\\"trtr0\\\":\\\"200000\\\",\\\"xrtr0\\\":\\\"250000\\\",\\\"mrtr1\\\":\\\"150000\\\",\\\"trtr1\\\":\\\"200000\\\",\\\"xrtr1\\\":\\\"250000\\\",\\\"c0d\\\":18,\\\"c1d\\\":18,\\\"rb0\\\":\\\"76620612965091961282\\\",\\\"rb1\\\":\\\"440302840903099373971\\\",\\\"r0\\\":\\\"389903218547825043299\\\",\\\"r1\\\":\\\"1852348007645925944033\\\",\\\"ib\\\":[128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,12,1,6,63,54,252,103,19]},\\\"vsp\\\":{\\\"i\\\":true,\\\"sp0\\\":\\\"1006375959211843841\\\",\\\"sp1\\\":\\\"1000523272567918807\\\"},\\\"bt\\\":1754968829}\"}","staticExtra":"{\"0x0\":[true,false],\"fee\":0,\"tS\":1,\"hooks\":\"0x000052423c1db6b7ff8641b85a7eefc7b2791888\",\"uR\":\"0xef740bf23acae26f6492b10de645d6b98dc8eaf3\",\"pm2\":\"0x000000000022d473030f116ddee9f6b43ac78ba3\",\"mc3\":\"0xca11bde05977b3631167028862be2a173976ca11\"}","blockNumber":24262989}`

	assert.NoError(t, json.Unmarshal([]byte(poolData), &p))

	pSim, err := uniswapv4.NewPoolSimulator(p, valueobject.ChainIDUnichain)
	assert.NoError(t, err)

	got, err := pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7",
			Amount: big.NewInt(20951525654502637),
		},
		TokenOut: "0x4200000000000000000000000000000000000006",
	})
	assert.NoError(t, err)
	assert.Equal(t, "22469222712679239", got.TokenAmountOut.Amount.String())

	got, err = pSim.CalcAmountOut(pool.CalcAmountOutParams{
		TokenAmountIn: pool.TokenAmount{
			Token:  "0x4200000000000000000000000000000000000006",
			Amount: big.NewInt(1e12),
		},
		TokenOut: "0x7dcc39b4d1c53cb31e1abc0e358b43987fef80f7",
	})
	assert.NoError(t, err)
	assert.Equal(t, "932286574900", got.TokenAmountOut.Amount.String())
}

func Test_Quoter(t *testing.T) {
	if os.Getenv("CI") != "" {
		t.Skip("Skipping testing in CI environment")
	}

	rpcClient := ethrpc.New("https://unichain.drpc.org").
		SetMulticallContract(common.HexToAddress("0xca11bde05977b3631167028862be2a173976ca11"))

	sender := common.HexToAddress("0x7b42Ed932f26509465F7cE3FAF76FfCe1275312f")

	poolKey := uniswapv4.PoolKey{
		Currency0:   common.HexToAddress("0x078d782b760474a361dda0af3839290b0ef57ad6"),
		Currency1:   common.HexToAddress("0x9151434b16b9763660705744891fa906f660ecc5"),
		Fee:         big.NewInt(0),
		TickSpacing: big.NewInt(1),
		Hooks:       common.HexToAddress("0x005af73a245d8171a0550ffae2631f12cc211888"),
	}

	swapParams := SwapParams{
		ZeroForOne:        false,
		AmountSpecified:   big.NewInt(-6439251628),
		SqrtPriceLimitX96: maxPriceLimit,
	}

	var swapResult SwapResult
	_, err := rpcClient.R().SetBlockNumber(big.NewInt(24220659)).AddCall(&ethrpc.Call{
		ABI:    bunniQuoterABI,
		Target: "0x0000005E46dE497cF4b56e47526969d6F77781eE",
		Method: "quoteSwap",
		Params: []interface{}{sender, poolKey, swapParams},
	}, []interface{}{&swapResult}).Call()

	assert.NoError(t, err)
	assert.Greater(t, swapResult.OutputAmount.Int64(), int64(0))
}
