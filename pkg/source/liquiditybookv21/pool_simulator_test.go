package liquiditybookv21

import (
	"encoding/json"
	"math/big"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
)

func TestCalcAmountOut(t *testing.T) {
	entityPoolStr := `{"address":"0x88a805417c653318b592ad0bfd3619f850ae4d04","exchange":"traderjoe-v21","type":"liquiditybook-v21","timestamp":1698303275,"reserves":["133843891601373157574085326","915526084694204215"],"tokens":[{"address":"0xa7e5041b76ca8b13ff4bf2421f0265d5a4f51dc1","weight":50,"swappable":true},{"address":"0x82af49447d8a07e3bd95bd0d56f35241523fbab1","weight":50,"swappable":true}],"extra":"{\"rpcBlockTimestamp\":1698303274,\"subgraphBlockTimestamp\":1690237594,\"staticFeeParams\":{\"baseFactor\":8000,\"filterPeriod\":300,\"decayPeriod\":1200,\"reductionFactor\":5000,\"variableFeeControl\":7500,\"protocolShare\":2500,\"maxVolatilityAccumulator\":150000},\"variableFeeParams\":{\"volatilityAccumulator\":10000,\"volatilityReference\":0,\"idReference\":8386810,\"timeOfLastUpdate\":1684400956},\"activeBinId\":8386809,\"binStep\":100,\"bins\":[{\"id\":8386809,\"reserveX\":8911332940412451004874752,\"reserveY\":915526084694204215,\"totalSupply\":362234951980755228671724230742248737827450697042194595840},{\"id\":8386810,\"reserveX\":7675464937684507382775808,\"reserveY\":0,\"totalSupply\":44105749524820388235929978964542704203698978298129285120},{\"id\":8386811,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7523648389781648728312028589103947907568541731392411500},{\"id\":8386812,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7598884873679465215595148874994987386644227148706335615},{\"id\":8386813,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7674873722416259867751100363745104770644559814763665995},{\"id\":8386814,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7751622459640422466428611367382156371108651395089896675},{\"id\":8386815,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7829138684236826691092897481055784653896018222998179845},{\"id\":8386816,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7907430071079194958003826455866845030836649588938962715},{\"id\":8386817,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":7986504371789986907583864720425938699177199394122107095},{\"id\":8386818,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8066369415507886776659703367630056346824910284965409915},{\"id\":8386819,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8147033109662965644426300401306009004630463952938355580},{\"id\":8386820,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8228503440759595300870563405319017553097110009523041590},{\"id\":8386821,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8310788475167191253879269039372955081533130562316386420},{\"id\":8386822,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8393896359918863166418061729766736173928120450884247830},{\"id\":8386823,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8477835323518051798082242347063707724342010785639673440},{\"id\":8386824,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8562613676753232316063064770534705592643040974108952995},{\"id\":8386825,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8648239813520764639223695418239653201327117366028636545},{\"id\":8386826,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8734722211655972285615932372421779140047180979229260795},{\"id\":8386827,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8822069433772532008472091696146370607900177515370610610},{\"id\":8386828,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8910290128110257328556812613107602376870715667273177760},{\"id\":8386829,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":8999393029391359901842380739238833025378398572780002175},{\"id\":8386830,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9089386959685273500860804546631028074708462872465186400},{\"id\":8386831,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9180280829282126235869412592097080647557254586466350535},{\"id\":8386832,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9272083637574947498228106718018270505746376109845978610},{\"id\":8386833,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9364804473950696973210387785198221273695376247693299440},{\"id\":8386834,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9458452518690203942942491663050564277489940090783115255},{\"id\":8386835,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9553037043877105982371916579680825097761461222703633065},{\"id\":8386836,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9648567414315877042195635745477672004923819772139192555},{\"id\":8386837,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9745053088459035812617592102932977026164558445043734325},{\"id\":8386838,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9842503619343626170743768023962500077349923715536787465},{\"id\":8386839,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":9940928655537062432451205704201906026409873975177190770},{\"id\":8386840,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10040337942092433056775717761243590066406191925788428630},{\"id\":8386841,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10140741321513357387343474938856103279439741719463359235},{\"id\":8386842,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10242148734728490961216909688245398779744273943619932855},{\"id\":8386843,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10344570222075775870829078785127865652936631328792306570},{\"id\":8386844,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10448015924296533629537369572978293873401631023492720130},{\"id\":8386845,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10552496083539498965832743268708154124505135208144693650},{\"id\":8386846,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10658021044374893955491070701395622227597625932311372180},{\"id\":8386847,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10764601254818642895045981408409784616192236523413276085},{\"id\":8386848,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10872247267366829323996441222494230368016854323524117280},{\"id\":8386849,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":10980969740040497617236405634718348006422485539644197720},{\"id\":8386850,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":11090779437440902593408769691066356151761247722155800430},{\"id\":8386851,\"reserveX\":1288539491464573617438720,\"reserveY\":0,\"totalSupply\":11201687231815311619342857387976581609851762244347429295},{\"id\":8386852,\"reserveX\":64426974573228680869314560,\"reserveY\":0,\"totalSupply\":565685205206673236776814649302998539907821257493913826590}]}"}`
	var entityPool entity.Pool
	err := json.Unmarshal([]byte(entityPoolStr), &entityPool)
	assert.Nil(t, err)

	amountIn, _ := new(big.Int).SetString("999999999999999999999999999999", 10)

	var (
		tokenAmountIn = pool.TokenAmount{
			Token:  "0xa7e5041b76ca8b13ff4bf2421f0265d5a4f51dc1",
			Amount: amountIn,
		}
		tokenOut = "0x82af49447d8a07e3bd95bd0d56f35241523fbab1"
	)

	simulator, err := NewPoolSimulator(entityPool)
	assert.Nil(t, err)

	_, err = simulator.CalcAmountOut(tokenAmountIn, tokenOut)
	assert.Equal(t, ErrNotFoundBinID, err)
}
