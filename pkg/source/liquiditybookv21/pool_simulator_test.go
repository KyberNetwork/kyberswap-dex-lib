package liquiditybookv21

import (
	"encoding/json"
	"math/big"
	"testing"

	"github.com/stretchr/testify/assert"

	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
)

func TestCalcAmountOut(t *testing.T) {
	entityPoolStr := `{"address":"0xf9304d3ed9107b38b114fec5a550c0127e1be85f","reserveUsd":128508.32073720988,"exchange":"traderjoe-v21","type":"liquiditybook-v21","timestamp":1700040670,"reserves":["27885509070591568837","128499999978"],"tokens":[{"address":"0x6e84a6216ea6dacc71ee8e6b0a5b7322eebc0fdd","name":"","symbol":"","decimals":0,"weight":50,"swappable":true},{"address":"0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e","name":"","symbol":"","decimals":0,"weight":50,"swappable":true}],"extra":"{\"rpcBlockTimestamp\":1700040667,\"subgraphBlockTimestamp\":1700040658,\"staticFeeParams\":{\"baseFactor\":8000,\"filterPeriod\":300,\"decayPeriod\":1200,\"reductionFactor\":5000,\"variableFeeControl\":7500,\"protocolShare\":2500,\"maxVolatilityAccumulator\":150000},\"variableFeeParams\":{\"volatilityAccumulator\":150000,\"volatilityReference\":0,\"idReference\":8385766,\"timeOfLastUpdate\":1699214953},\"activeBinId\":8385650,\"binStep\":100,\"bins\":[{\"id\":8385571,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385572,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385573,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385574,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385575,\"reserveX\":0,\"reserveY\":3106568695,\"totalSupply\":1057110548537090970616720834505445474205349969920},{\"id\":8385576,\"reserveX\":0,\"reserveY\":3091451537,\"totalSupply\":1051966446231733170356267773351711459933392207872},{\"id\":8385577,\"reserveX\":0,\"reserveY\":3076334379,\"totalSupply\":1046822343926375370095814712197977445661434445824},{\"id\":8385578,\"reserveX\":0,\"reserveY\":31561217221,\"totalSupply\":10739725698867763778541537962849637457885476683776},{\"id\":8385579,\"reserveX\":0,\"reserveY\":3046100063,\"totalSupply\":1036534139315659769574908589890509417117518921728},{\"id\":8385580,\"reserveX\":0,\"reserveY\":3030982905,\"totalSupply\":1031390037010301969314455528736775402845561159680},{\"id\":8385581,\"reserveX\":0,\"reserveY\":3015865748,\"totalSupply\":1026245935045226535974940931046415996005371609088},{\"id\":8385582,\"reserveX\":0,\"reserveY\":3000748590,\"totalSupply\":1021101832739868735714487869892681981733413847040},{\"id\":8385583,\"reserveX\":0,\"reserveY\":2985631432,\"totalSupply\":1015957730434510935454034808738947967461456084992},{\"id\":8385584,\"reserveX\":0,\"reserveY\":2970514274,\"totalSupply\":1010813628129153135193581747585213953189498322944},{\"id\":8385585,\"reserveX\":0,\"reserveY\":2955397116,\"totalSupply\":1005669525823795334933128686431479938917540560896},{\"id\":8385586,\"reserveX\":0,\"reserveY\":2939989243,\"totalSupply\":1000426498330138114047269870328746398149989367808},{\"id\":8385587,\"reserveX\":0,\"reserveY\":2924872085,\"totalSupply\":995282396024780313786816809175012383878031605760},{\"id\":8385588,\"reserveX\":0,\"reserveY\":2909754927,\"totalSupply\":990138293719422513526363748021278369606073843712},{\"id\":8385589,\"reserveX\":0,\"reserveY\":2894637769,\"totalSupply\":984994191414064713265910686867544355334116081664},{\"id\":8385590,\"reserveX\":0,\"reserveY\":2879520611,\"totalSupply\":979850089108706913005457625713810341062158319616},{\"id\":8385591,\"reserveX\":0,\"reserveY\":2864403453,\"totalSupply\":974705986803349112745004564560076326790200557568},{\"id\":8385592,\"reserveX\":0,\"reserveY\":2849286295,\"totalSupply\":969561884497991312484551503406342312518242795520},{\"id\":8385593,\"reserveX\":0,\"reserveY\":2834169137,\"totalSupply\":964417782192633512224098442252608298246285033472},{\"id\":8385594,\"reserveX\":0,\"reserveY\":2819051979,\"totalSupply\":959273679887275711963645381098874283974327271424},{\"id\":8385595,\"reserveX\":0,\"reserveY\":2803934821,\"totalSupply\":954129577581917911703192319945140269702369509376},{\"id\":8385596,\"reserveX\":0,\"reserveY\":2788817663,\"totalSupply\":948985475276560111442739258791406255430411747328},{\"id\":8385597,\"reserveX\":0,\"reserveY\":2773700505,\"totalSupply\":943841372971202311182286197637672241158453985280},{\"id\":8385598,\"reserveX\":0,\"reserveY\":2758583347,\"totalSupply\":938697270665844510921833136483938226886496223232},{\"id\":8385599,\"reserveX\":0,\"reserveY\":2743466189,\"totalSupply\":933553168360486710661380075330204212614538461184},{\"id\":8385600,\"reserveX\":0,\"reserveY\":20125000000,\"totalSupply\":6848182634283886577200413974564335255552000000000},{\"id\":8385601,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385602,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385603,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385604,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385605,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385606,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385607,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385608,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385609,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385610,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385611,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385612,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385613,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385614,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385615,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385616,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385617,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385618,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385619,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385620,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385621,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385622,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385623,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385624,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385625,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385626,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385627,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385628,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385629,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385630,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385631,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385632,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385633,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385634,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385635,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385636,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385637,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385638,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385639,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385640,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385641,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385642,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385643,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385644,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385645,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385646,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385647,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385648,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385649,\"reserveX\":0,\"reserveY\":125000000,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385650,\"reserveX\":38668624048405,\"reserveY\":124999994,\"totalSupply\":42535295865117307932921825928971026432000000000},{\"id\":8385766,\"reserveX\":3118370549482678848,\"reserveY\":0,\"totalSupply\":551043056520760119578684938036782488585502720},{\"id\":8385767,\"reserveX\":3085908041667782368,\"reserveY\":0,\"totalSupply\":551043056520760119578684938036782488585502720},{\"id\":8385768,\"reserveX\":3054138125463011361,\"reserveY\":0,\"totalSupply\":551043056520760119578684938036782488585502720},{\"id\":8385769,\"reserveX\":3023039680556511460,\"reserveY\":0,\"totalSupply\":551043056520760119578684938036782488585502720},{\"id\":8385770,\"reserveX\":2992598336969699375,\"reserveY\":0,\"totalSupply\":551043056520760119578684938036782488585502720},{\"id\":8385771,\"reserveX\":2340355751892522421,\"reserveY\":0,\"totalSupply\":436242570533659853295200946404951891055977910},{\"id\":8385772,\"reserveX\":1717911204253633415,\"reserveY\":0,\"totalSupply\":324656505392025183070817411736272470947729805},{\"id\":8385773,\"reserveX\":1717911204253633415,\"reserveY\":0,\"totalSupply\":327903070445945434901525584702634688807272715},{\"id\":8385774,\"reserveX\":1717911204253633415,\"reserveY\":0,\"totalSupply\":331182101150404889250540841906810887055715840},{\"id\":8385775,\"reserveX\":1717911204253633415,\"reserveY\":0,\"totalSupply\":334493922161908938143046250394595444096418335},{\"id\":8385776,\"reserveX\":1844972330214288309,\"reserveY\":0,\"totalSupply\":359345554004552628930988433891656360710292366},{\"id\":8385777,\"reserveX\":125463912391650126,\"reserveY\":0,\"totalSupply\":24747715699059091632300845074690206714560512},{\"id\":8385778,\"reserveX\":124172241373076536,\"reserveY\":0,\"totalSupply\":24747715699059091632300845074690206714560512},{\"id\":8385779,\"reserveX\":122907870395528882,\"reserveY\":0,\"totalSupply\":24747715699059091632300845074690206714560512},{\"id\":8385780,\"reserveX\":121670215218093403,\"reserveY\":0,\"totalSupply\":24747715699059091632300845074690206714560512},{\"id\":8385781,\"reserveX\":151137620237234593,\"reserveY\":0,\"totalSupply\":31163527462009125488751250550923801858006674},{\"id\":8385782,\"reserveX\":181818181818181818,\"reserveY\":0,\"totalSupply\":37955476302399341086501770606691567966451844},{\"id\":8385783,\"reserveX\":181818181818181818,\"reserveY\":0,\"totalSupply\":38335031065423334497366788389122120009752726},{\"id\":8385784,\"reserveX\":181818181818181818,\"reserveY\":0,\"totalSupply\":38718381376077567842340456260286068482577526},{\"id\":8385785,\"reserveX\":181818181818181818,\"reserveY\":0,\"totalSupply\":39105565189838343520763860810161656440130574},{\"id\":8385786,\"reserveX\":181818181818181818,\"reserveY\":0,\"totalSupply\":39496620841736726955971499340081454822713698}]}"}`
	var entityPool entity.Pool
	err := json.Unmarshal([]byte(entityPoolStr), &entityPool)
	assert.Nil(t, err)

	simulator, err := NewPoolSimulator(entityPool)
	assert.Nil(t, err)

	// block 37790183

	t.Run("should return OK 1", func(t *testing.T) {
		amountIn, _ := new(big.Int).SetString("800000000000000000000", 10)

		var (
			tokenAmountIn = pool.TokenAmount{
				Token:  "0x6e84a6216ea6dacc71ee8e6b0a5b7322eebc0fdd",
				Amount: amountIn,
			}
			tokenOut = "0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e"
		)

		result, err := simulator.CalcAmountOut(tokenAmountIn, tokenOut)
		assert.Nil(t, err)

		assert.Equal(t, "130852590", result.TokenAmountOut.Amount.String())
		assert.Equal(t, "6402709418224206221", result.Fee.Amount.String())
	})

	t.Run("should return OK 2", func(t *testing.T) {
		amountIn, _ := new(big.Int).SetString("1000000000000000000000000", 10)

		var (
			tokenAmountIn = pool.TokenAmount{
				Token:  "0x6e84a6216ea6dacc71ee8e6b0a5b7322eebc0fdd",
				Amount: amountIn,
			}
			tokenOut = "0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e"
		)

		result, err := simulator.CalcAmountOut(tokenAmountIn, tokenOut)
		assert.Nil(t, err)

		assert.Equal(t, "90958757972", result.TokenAmountOut.Amount.String())
		assert.Equal(t, "24731834448460156681880", result.Fee.Amount.String())
	})

	t.Run("should return OK 3", func(t *testing.T) {
		amountIn, _ := new(big.Int).SetString("6996", 10)

		var (
			tokenAmountIn = pool.TokenAmount{
				Token:  "0xb97ef9ef8734c71904d8002f8b6bc66dd9c48a6e",
				Amount: amountIn,
			}
			tokenOut = "0x6e84a6216ea6dacc71ee8e6b0a5b7322eebc0fdd"
		)

		result, err := simulator.CalcAmountOut(tokenAmountIn, tokenOut)
		assert.Nil(t, err)

		assert.Equal(t, "13062729560279583", result.TokenAmountOut.Amount.String())
		assert.Equal(t, "175", result.Fee.Amount.String())
	})
}
