package gmxglp

import (
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	poolPkg "github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/util/bignumber"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestPoolSimulator_MintAndStakeGlp(t *testing.T) {
	t.Parallel()
	testCases := []struct {
		name              string
		entityPool        entity.Pool
		tokenAmountIn     poolPkg.TokenAmount
		tokenOut          string
		expectedAmountOut string
		expectedErr       error
	}{
		{
			name: "it should return correct stake amount",
			entityPool: entity.Pool{
				Address:  "0xec8d8d4b215727f3476ff0ab41c406fa99b4272c",
				Exchange: "gmx-glp",
				Type:     "gmx-glp",
				Reserves: []string{
					"100329003063864030447",
					"2122309542211585107",
					"4493451845739631563",
				},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0x4200000000000000000000000000000000000006",
						Swappable: true,
					},
					{
						Address:   "0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22",
						Swappable: true,
					},
					{
						Address:   "0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239",
						Swappable: true,
					},
				},
				Extra: "{\"vault\":{\"hasDynamicFees\":true,\"includeAmmPrice\":true,\"isSwapEnabled\":true,\"stableSwapFeeBasisPoints\":1,\"stableTaxBasisPoints\":5,\"swapFeeBasisPoints\":30,\"totalTokenWeights\":100000,\"taxBasisPoints\":50,\"mintBurnFeeBasicPoints\":20,\"whitelistedTokens\":[\"0x4200000000000000000000000000000000000006\",\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\",\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\",\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\",\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\",\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\",\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\"],\"poolAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":85479038,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1302073542211585107,\"0x4200000000000000000000000000000000000006\":100329003063864030447,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":184816794886889968435525,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25113671330,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4493480235153195474,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":53718430919},\"bufferAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":100000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":40000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":5000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":25000000000},\"reservedAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"tokenDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":18,\"0x4200000000000000000000000000000000000006\":18,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":18,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":6,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":18,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":6},\"stableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"usdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":22836799473207660000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":2130019139277039094232,\"0x4200000000000000000000000000000000000006\":156535271593477510818127,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":184816794886889968435525,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25113671329401471966509,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":22819266388883812470464,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":53718430918021348800855},\"maxUsdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":2000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":500000000000000000000000,\"0x4200000000000000000000000000000000000006\":2000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":185000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":3000000000000000000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":40000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":3000000000000000000000000},\"tokenWeights\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1000,\"0x4200000000000000000000000000000000000006\":39000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":20000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":20000},\"priceFeed\":{\"bnb\":\"0x0000000000000000000000000000000000000000\",\"btc\":\"0x0000000000000000000000000000000000000000\",\"eth\":\"0x0000000000000000000000000000000000000000\",\"favorPrimaryPrice\":false,\"isAmmEnabled\":false,\"isSecondaryPriceEnabled\":true,\"maxStrictPriceDeviation\":10000000000000000000000000000,\"priceSampleSpace\":1,\"spreadThresholdBasisPoints\":30,\"useV2Pricing\":false,\"priceDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":8,\"0x4200000000000000000000000000000000000006\":8,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":8,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":8,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":8},\"spreadBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"adjustmentBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"strictStableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"isAdjustmentAdditive\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":false,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":false,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":false},\"secondaryPriceFeed\":{\"disableFastPriceVoteCount\":0,\"isSpreadEnabled\":false,\"lastUpdatedAt\":1697086077,\"maxDeviationBasisPoints\":250,\"minAuthorizations\":1,\"priceDuration\":300,\"maxPriceUpdateDelay\":3600,\"spreadBasisPointsIfChainError\":500,\"spreadBasisPointsIfInactive\":50,\"prices\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":26831621000000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1638203000000000000000000000000000,\"0x4200000000000000000000000000000000000006\":1562527000000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":5100602000000000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"priceData\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"refPrice\":2684446315600,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":2559},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"refPrice\":163944077519,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":3352},\"0x4200000000000000000000000000000000000006\":{\"refPrice\":156231000000,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1145},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"refPrice\":510399000000,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1584},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0}},\"maxCumulativeDeltaDiffs\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":1000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":1000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0}},\"secondaryPriceFeedVersion\":2,\"priceFeeds\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"roundId\":18446744073709556406,\"answer\":2684446315600,\"answers\":{\"18446744073709556406\":2684446315600}},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"roundId\":18446744073709552387,\"answer\":163944077519,\"answers\":{\"18446744073709552387\":163944077519}},\"0x4200000000000000000000000000000000000006\":{\"roundId\":18446744073709554478,\"answer\":156231000000,\"answers\":{\"18446744073709554478\":156231000000}},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"roundId\":18446744073709551689,\"answer\":99990000,\"answers\":{\"18446744073709551689\":99990000}},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"roundId\":18446744073709551689,\"answer\":99993210,\"answers\":{\"18446744073709551689\":99993210}},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"roundId\":18446744073709551768,\"answer\":510399000000,\"answers\":{\"18446744073709551768\":510399000000}},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"roundId\":18446744073709551689,\"answer\":99993210,\"answers\":{\"18446744073709551689\":99993210}}}},\"usdg\":{\"address\":\"0xE974A88385935CB8846482F3Ab01b6c0f70fa5f3\",\"totalSupply\":479977269278424219971273},\"UseSwapPricing\":false},\"glpManager\":{\"maximiseAumInUsdg\":468420435459683528779944,\"notMaximiseAumInUsdg\":468403599874320724835902,\"glpSupply\":475605956112810570942827,\"glp\":\"0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633\"}}",
			},
			tokenAmountIn: poolPkg.TokenAmount{
				Token:  "0x4200000000000000000000000000000000000006",
				Amount: bignumber.NewBig10("10000000000000000000"),
			},
			tokenOut:          "0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633",
			expectedAmountOut: "15846000280747685669525",
			expectedErr:       nil,
		},
		{
			name: "it should return correct unStake amount",
			entityPool: entity.Pool{
				Address:  "0xec8d8d4b215727f3476ff0ab41c406fa99b4272c",
				Exchange: "gmx-glp",
				Type:     "gmx-glp",
				Reserves: []string{
					"100333920309541139945",
					"2122309542211585107",
					"4493451845739631563",
				},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0x4200000000000000000000000000000000000006",
						Swappable: true,
					},
					{
						Address:   "0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22",
						Swappable: true,
					},
					{
						Address:   "0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239",
						Swappable: true,
					},
				},
				Extra: "{\"vault\":{\"hasDynamicFees\":true,\"includeAmmPrice\":true,\"isSwapEnabled\":true,\"stableSwapFeeBasisPoints\":1,\"stableTaxBasisPoints\":5,\"swapFeeBasisPoints\":30,\"totalTokenWeights\":100000,\"taxBasisPoints\":50,\"mintBurnFeeBasicPoints\":20,\"whitelistedTokens\":[\"0x4200000000000000000000000000000000000006\",\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\",\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\",\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\",\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\",\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\",\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\"],\"poolAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":85479038,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1302073542211585107,\"0x4200000000000000000000000000000000000006\":100329003063864030447,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":184816794886889968435525,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25113671330,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4493480235153195474,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":53718430919},\"bufferAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":100000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":40000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":5000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":25000000000},\"reservedAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"tokenDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":18,\"0x4200000000000000000000000000000000000006\":18,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":18,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":6,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":18,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":6},\"stableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"usdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":22836799473207660000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":2130019139277039094232,\"0x4200000000000000000000000000000000000006\":156535271593477510818127,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":184816794886889968435525,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25113671329401471966509,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":22819266388883812470464,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":53718430918021348800855},\"maxUsdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":2000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":500000000000000000000000,\"0x4200000000000000000000000000000000000006\":2000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":185000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":3000000000000000000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":40000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":3000000000000000000000000},\"tokenWeights\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1000,\"0x4200000000000000000000000000000000000006\":39000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":20000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":20000},\"priceFeed\":{\"bnb\":\"0x0000000000000000000000000000000000000000\",\"btc\":\"0x0000000000000000000000000000000000000000\",\"eth\":\"0x0000000000000000000000000000000000000000\",\"favorPrimaryPrice\":false,\"isAmmEnabled\":false,\"isSecondaryPriceEnabled\":true,\"maxStrictPriceDeviation\":10000000000000000000000000000,\"priceSampleSpace\":1,\"spreadThresholdBasisPoints\":30,\"useV2Pricing\":false,\"priceDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":8,\"0x4200000000000000000000000000000000000006\":8,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":8,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":8,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":8},\"spreadBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"adjustmentBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"strictStableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"isAdjustmentAdditive\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":false,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":false,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":false},\"secondaryPriceFeed\":{\"disableFastPriceVoteCount\":0,\"isSpreadEnabled\":false,\"lastUpdatedAt\":1697086077,\"maxDeviationBasisPoints\":250,\"minAuthorizations\":1,\"priceDuration\":300,\"maxPriceUpdateDelay\":3600,\"spreadBasisPointsIfChainError\":500,\"spreadBasisPointsIfInactive\":50,\"prices\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":26831621000000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1638203000000000000000000000000000,\"0x4200000000000000000000000000000000000006\":1562527000000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":5100602000000000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"priceData\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"refPrice\":2684446315600,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":2559},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"refPrice\":163944077519,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":3352},\"0x4200000000000000000000000000000000000006\":{\"refPrice\":156231000000,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1145},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"refPrice\":510399000000,\"refTime\":1697086079,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1584},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0}},\"maxCumulativeDeltaDiffs\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":1000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":1000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0}},\"secondaryPriceFeedVersion\":2,\"priceFeeds\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"roundId\":18446744073709556406,\"answer\":2684446315600,\"answers\":{\"18446744073709556406\":2684446315600}},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"roundId\":18446744073709552387,\"answer\":163944077519,\"answers\":{\"18446744073709552387\":163944077519}},\"0x4200000000000000000000000000000000000006\":{\"roundId\":18446744073709554478,\"answer\":156231000000,\"answers\":{\"18446744073709554478\":156231000000}},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"roundId\":18446744073709551689,\"answer\":99990000,\"answers\":{\"18446744073709551689\":99990000}},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"roundId\":18446744073709551689,\"answer\":99993210,\"answers\":{\"18446744073709551689\":99993210}},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"roundId\":18446744073709551768,\"answer\":510399000000,\"answers\":{\"18446744073709551768\":510399000000}},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"roundId\":18446744073709551689,\"answer\":99993210,\"answers\":{\"18446744073709551689\":99993210}}}},\"usdg\":{\"address\":\"0xE974A88385935CB8846482F3Ab01b6c0f70fa5f3\",\"totalSupply\":479977269278424219971273},\"UseSwapPricing\":false},\"glpManager\":{\"maximiseAumInUsdg\":468420435459683528779944,\"notMaximiseAumInUsdg\":468403599874320724835902,\"glpSupply\":475605956112810570942827,\"glp\":\"0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633\"}}",
			},
			tokenAmountIn: poolPkg.TokenAmount{
				Token:  "0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633",
				Amount: bignumber.NewBig10("10000000000000000000"),
			},
			tokenOut:          "0x4200000000000000000000000000000000000006",
			expectedAmountOut: "6284362390396145",
			expectedErr:       nil,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			pool, _ := NewPoolSimulator(tc.entityPool)

			calcAmountOutResult, err := pool.CalcAmountOut(tc.tokenAmountIn, tc.tokenOut)

			assert.Equal(t, tc.expectedErr, err)
			assert.Equal(t, tc.expectedAmountOut, calcAmountOutResult.TokenAmountOut.Amount.String())
		})
	}
}
