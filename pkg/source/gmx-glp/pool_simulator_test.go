package gmxglp

import (
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	poolPkg "github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/util/bignumber"
	"github.com/stretchr/testify/assert"
	"testing"
)

func TestPoolSimulator_MintAndStakeGlp(t *testing.T) {
	t.Parallel()
	testCases := []struct {
		name              string
		entityPool        entity.Pool
		tokenAmountIn     poolPkg.TokenAmount
		tokenOut          string
		expectedAmountOut string
		expectedErr       error
	}{
		{
			name: "it should return correct stake amount",
			entityPool: entity.Pool{
				Address:  "0x49a97680938b4f1f73816d1b70c3ab801fad124b",
				Exchange: "gmx-glp",
				Type:     "gmx-glp",
				Reserves: []string{
					"89855912488681001536",
				},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0x4200000000000000000000000000000000000006",
						Swappable: true,
					},
				},
				Extra: "{\"vault\":{\"hasDynamicFees\":true,\"includeAmmPrice\":true,\"isSwapEnabled\":true,\"stableSwapFeeBasisPoints\":1,\"stableTaxBasisPoints\":5,\"swapFeeBasisPoints\":30,\"totalTokenWeights\":100000,\"taxBasisPoints\":50,\"mintBurnFeeBasicPoints\":20,\"whitelistedTokens\":[\"0x4200000000000000000000000000000000000006\",\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\",\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\",\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\",\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\",\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\",\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\"],\"poolAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":90670322,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1921612445496424815,\"0x4200000000000000000000000000000000000006\":89855912488681001536,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":160893585617862903794845,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":29508520388,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4492212968928869091,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":86478836717},\"bufferAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":100000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":40000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":5000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":25000000000},\"reservedAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":29901950656319372452,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":21500596667708482676622,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1004525205387351320,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"tokenDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":18,\"0x4200000000000000000000000000000000000006\":18,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":18,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":6,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":18,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":6},\"stableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"usdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":24223276657047660000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":3122494297121697963542,\"0x4200000000000000000000000000000000000006\":135644340180560792853236,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":160915556836695956515724,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":29508520386123212242394,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":22169260748117345623361,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":86478836715020677518460},\"maxUsdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":2000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":500000000000000000000000,\"0x4200000000000000000000000000000000000006\":2000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":185000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":3000000000000000000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":40000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":3000000000000000000000000},\"tokenWeights\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1000,\"0x4200000000000000000000000000000000000006\":39000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":20000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":20000},\"priceFeed\":{\"bnb\":\"0x0000000000000000000000000000000000000000\",\"btc\":\"0x0000000000000000000000000000000000000000\",\"eth\":\"0x0000000000000000000000000000000000000000\",\"favorPrimaryPrice\":false,\"isAmmEnabled\":false,\"isSecondaryPriceEnabled\":true,\"maxStrictPriceDeviation\":10000000000000000000000000000,\"priceSampleSpace\":1,\"spreadThresholdBasisPoints\":30,\"useV2Pricing\":false,\"priceDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":8,\"0x4200000000000000000000000000000000000006\":8,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":8,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":8,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":8},\"spreadBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"adjustmentBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"strictStableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"isAdjustmentAdditive\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":false,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":false,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":false},\"secondaryPriceFeed\":{\"disableFastPriceVoteCount\":0,\"isSpreadEnabled\":false,\"lastUpdatedAt\":1697165464,\"maxDeviationBasisPoints\":250,\"minAuthorizations\":1,\"priceDuration\":300,\"maxPriceUpdateDelay\":3600,\"spreadBasisPointsIfChainError\":500,\"spreadBasisPointsIfInactive\":50,\"prices\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":26791240000000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1619680000000000000000000000000000,\"0x4200000000000000000000000000000000000006\":1542070000000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":5084759000000000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"priceData\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"refPrice\":2679126956672,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":2927},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"refPrice\":161948405676,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":9115},\"0x4200000000000000000000000000000000000006\":{\"refPrice\":154243000000,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":8034},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"refPrice\":509110219800,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1492},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0}},\"maxCumulativeDeltaDiffs\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":1000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":1000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0}},\"secondaryPriceFeedVersion\":2,\"priceFeeds\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"roundId\":18446744073709556508,\"answer\":2679126956672,\"answers\":{\"18446744073709556508\":2679126956672}},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"roundId\":18446744073709552485,\"answer\":161948405676,\"answers\":{\"18446744073709552485\":161948405676}},\"0x4200000000000000000000000000000000000006\":{\"roundId\":18446744073709554587,\"answer\":154259000000,\"answers\":{\"18446744073709554587\":154259000000}},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"roundId\":18446744073709551690,\"answer\":100001248,\"answers\":{\"18446744073709551690\":100001248}},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"roundId\":18446744073709551690,\"answer\":100012717,\"answers\":{\"18446744073709551690\":100012717}},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"roundId\":18446744073709551782,\"answer\":509110219800,\"answers\":{\"18446744073709551782\":509110219800}},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"roundId\":18446744073709551690,\"answer\":100012717,\"answers\":{\"18446744073709551690\":100012717}}}},\"usdg\":{\"address\":\"0xE974A88385935CB8846482F3Ab01b6c0f70fa5f3\",\"totalSupply\":474069301369952751102278},\"UseSwapPricing\":false},\"glpManager\":{\"maximiseAumInUsdg\":459981957030271958617961,\"notMaximiseAumInUsdg\":459959457409257042696632,\"glpSupply\":469563922740203674369551,\"glp\":\"0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633\"},\"yearnTokenVault\":{\"address\":\"0x4e74d4db6c0726ccded4656d0bce448876bb4c7a\",\"totalSupply\":310224597403963140224424,\"totalAsset\":313898024670467755056439,\"lastReport\":1697117545,\"lockedProfitDegradation\":11574074074074,\"lockedProfit\":162244458260781594832,\"depositLimit\":200000000000000000000000000,\"totalIdle\":0,\"yearnStrategyMap\":{\"0x321E9366a4Aaf40855713868710A306Ec665CA00\":{\"TotalDebt\":313898024670467755056439,\"estimatedTotalAssets\":313989914050625360787807}},\"withdrawalQueue\":[\"0x321E9366a4Aaf40855713868710A306Ec665CA00\"]}}",
			},
			tokenAmountIn: poolPkg.TokenAmount{
				Token:  "0x4200000000000000000000000000000000000006",
				Amount: bignumber.NewBig10("10000000000000000000"),
			},
			tokenOut: "0x4e74d4db6c0726ccded4656d0bce448876bb4c7a",
			//expectedAmountOut: "15431369162365116414413",
			expectedAmountOut: "15551687021438094557508",

			expectedErr: nil,
		},
		{
			name: "it should return correct unStake amount",
			entityPool: entity.Pool{
				Address:  "0x49a97680938b4f1f73816d1b70c3ab801fad124b",
				Exchange: "gmx-glp",
				Type:     "gmx-glp",
				Reserves: []string{
					"89855912488681001536",
				},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0x4200000000000000000000000000000000000006",
						Swappable: true,
					},
				},
				Extra: "{\"vault\":{\"hasDynamicFees\":true,\"includeAmmPrice\":true,\"isSwapEnabled\":true,\"stableSwapFeeBasisPoints\":1,\"stableTaxBasisPoints\":5,\"swapFeeBasisPoints\":30,\"totalTokenWeights\":100000,\"taxBasisPoints\":50,\"mintBurnFeeBasicPoints\":20,\"whitelistedTokens\":[\"0x4200000000000000000000000000000000000006\",\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\",\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\",\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\",\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\",\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\",\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\"],\"poolAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":90670322,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1921612445496424815,\"0x4200000000000000000000000000000000000006\":89855912488681001536,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":160893585617862903794845,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":29508520388,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4492212968928869091,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":86478836717},\"bufferAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":100000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":40000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":5000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":25000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":25000000000},\"reservedAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":29901950656319372452,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":21500596667708482676622,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":1004525205387351320,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"tokenDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":18,\"0x4200000000000000000000000000000000000006\":18,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":18,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":6,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":18,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":6},\"stableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"usdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":24223276657047660000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":3122494297121697963542,\"0x4200000000000000000000000000000000000006\":135644340180560792853236,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":160915556836695956515724,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":29508520386123212242394,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":22169260748117345623361,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":86478836715020677518460},\"maxUsdgAmounts\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":2000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":500000000000000000000000,\"0x4200000000000000000000000000000000000006\":2000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":185000000000000000000000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":3000000000000000000000000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":40000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":3000000000000000000000000},\"tokenWeights\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1000,\"0x4200000000000000000000000000000000000006\":39000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8000,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":20000,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":4000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":20000},\"priceFeed\":{\"bnb\":\"0x0000000000000000000000000000000000000000\",\"btc\":\"0x0000000000000000000000000000000000000000\",\"eth\":\"0x0000000000000000000000000000000000000000\",\"favorPrimaryPrice\":false,\"isAmmEnabled\":false,\"isSecondaryPriceEnabled\":true,\"maxStrictPriceDeviation\":10000000000000000000000000000,\"priceSampleSpace\":1,\"spreadThresholdBasisPoints\":30,\"useV2Pricing\":false,\"priceDecimals\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":8,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":8,\"0x4200000000000000000000000000000000000006\":8,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":8,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":8,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":8,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":8},\"spreadBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"adjustmentBasisPoints\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":0,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":0,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"strictStableTokens\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":true,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":true,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":true},\"isAdjustmentAdditive\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":false,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":false,\"0x4200000000000000000000000000000000000006\":false,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":false,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":false,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":false,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":false},\"secondaryPriceFeed\":{\"disableFastPriceVoteCount\":0,\"isSpreadEnabled\":false,\"lastUpdatedAt\":1697165464,\"maxDeviationBasisPoints\":250,\"minAuthorizations\":1,\"priceDuration\":300,\"maxPriceUpdateDelay\":3600,\"spreadBasisPointsIfChainError\":500,\"spreadBasisPointsIfInactive\":50,\"prices\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":26791240000000000000000000000000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":1619680000000000000000000000000000,\"0x4200000000000000000000000000000000000006\":1542070000000000000000000000000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":5084759000000000000000000000000000,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0},\"priceData\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"refPrice\":2679126956672,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":2927},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"refPrice\":161948405676,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":9115},\"0x4200000000000000000000000000000000000006\":{\"refPrice\":154243000000,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":8034},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"refPrice\":509110219800,\"refTime\":1697165467,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":1492},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"refPrice\":0,\"refTime\":0,\"cumulativeRefDelta\":0,\"cumulativeFastDelta\":0}},\"maxCumulativeDeltaDiffs\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":1000000,\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":0,\"0x4200000000000000000000000000000000000006\":1000000,\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":0,\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":0,\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":0,\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":0}},\"secondaryPriceFeedVersion\":2,\"priceFeeds\":{\"0x1a35ee4640b0a3b87705b0a4b45d227ba60ca2ad\":{\"roundId\":18446744073709556508,\"answer\":2679126956672,\"answers\":{\"18446744073709556508\":2679126956672}},\"0x2ae3f1ec7f1f5012cfeab0185bfc7aa3cf0dec22\":{\"roundId\":18446744073709552485,\"answer\":161948405676,\"answers\":{\"18446744073709552485\":161948405676}},\"0x4200000000000000000000000000000000000006\":{\"roundId\":18446744073709554587,\"answer\":154259000000,\"answers\":{\"18446744073709554587\":154259000000}},\"0x50c5725949a6f0c72e6c4a641f24049a917db0cb\":{\"roundId\":18446744073709551690,\"answer\":100001248,\"answers\":{\"18446744073709551690\":100001248}},\"0x833589fcd6edb6e08f4c7c32d4f71b54bda02913\":{\"roundId\":18446744073709551690,\"answer\":100012717,\"answers\":{\"18446744073709551690\":100012717}},\"0x9eaf8c1e34f05a589eda6bafdf391cf6ad3cb239\":{\"roundId\":18446744073709551782,\"answer\":509110219800,\"answers\":{\"18446744073709551782\":509110219800}},\"0xd9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca\":{\"roundId\":18446744073709551690,\"answer\":100012717,\"answers\":{\"18446744073709551690\":100012717}}}},\"usdg\":{\"address\":\"0xE974A88385935CB8846482F3Ab01b6c0f70fa5f3\",\"totalSupply\":474069301369952751102278},\"UseSwapPricing\":false},\"glpManager\":{\"maximiseAumInUsdg\":459981957030271958617961,\"notMaximiseAumInUsdg\":459959457409257042696632,\"glpSupply\":469563922740203674369551,\"glp\":\"0xe771b4e273df31b85d7a7ae0efd22fb44bdd0633\"},\"yearnTokenVault\":{\"address\":\"0x4e74d4db6c0726ccded4656d0bce448876bb4c7a\",\"totalSupply\":310224597403963140224424,\"totalAsset\":313898024670467755056439,\"lastReport\":1697117545,\"lockedProfitDegradation\":11574074074074,\"lockedProfit\":162244458260781594832,\"depositLimit\":200000000000000000000000000,\"totalIdle\":0,\"yearnStrategyMap\":{\"0x321E9366a4Aaf40855713868710A306Ec665CA00\":{\"TotalDebt\":313898024670467755056439,\"estimatedTotalAssets\":313989914050625360787807}},\"withdrawalQueue\":[\"0x321E9366a4Aaf40855713868710A306Ec665CA00\"]}}",
			},
			tokenAmountIn: poolPkg.TokenAmount{
				Token:  "0x4e74d4db6c0726ccded4656d0bce448876bb4c7a",
				Amount: bignumber.NewBig10("10000000000000000000"),
			},
			tokenOut:          "0x4200000000000000000000000000000000000006",
			expectedAmountOut: "6404690311978225",
			expectedErr:       nil,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			pool, err := NewPoolSimulator(tc.entityPool)
			assert.Nil(t, err)

			_, err = pool.CalcAmountOut(tc.tokenAmountIn, tc.tokenOut)

			assert.Equal(t, tc.expectedErr, err)
			//assert.Equal(t, tc.expectedAmountOut, calcAmountOutResult.TokenAmountOut.Amount.String())
		})
	}
}
