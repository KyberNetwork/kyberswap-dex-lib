package limitorder

import (
	"fmt"
	"math/big"
	"testing"

	"github.com/goccy/go-json"
	"github.com/samber/lo"
	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"

	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/entity"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/source/pool"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/swaplimit"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/util/bignumber"
	"github.com/KyberNetwork/kyberswap-dex-lib/pkg/util/testutil"
)

func TestPool_CalcAmountOut(t *testing.T) {
	type args struct {
		tokenAmountIn pool.TokenAmount
		tokenOut      string
	}
	tests := []struct {
		name       string
		poolEntity entity.Pool
		args       args
		want       *pool.CalcAmountOutResult
		err        error
	}{
		{
			name: "Should return correct CalcAmountOutResult when swapSide is BUY(strings.ToLower(tokeIn) <= strings.ToLower(TokenOut))",
			poolEntity: entity.Pool{
				Address:      "pool_limit_order_",
				ReserveUsd:   1000000000,
				AmplifiedTvl: 0,
				SwapFee:      0,
				Exchange:     "kyberswap_limit-order",
				Type:         "limit-order",
				Timestamp:    0,
				Reserves:     []string{"10000000000000000000", "10000000000000000000"},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
						Name:      "USDT",
						Symbol:    "USDT",
						Decimals:  6,
						Swappable: true,
					},
					{
						Address:   "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
						Name:      "USDC",
						Symbol:    "USDC",
						Decimals:  6,
						Swappable: true,
					},
				},
				Extra: marshalPoolExtra(&Extra{
					BuyOrders: []*order{
						{
							ID:                   1383,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature1",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("200"),
							MakingAmount:         parseBigInt("400"),
							FeeConfig:            parseBigInt("100"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1382,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature2",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("300"),
							MakingAmount:         parseBigInt("300"),
							FeeConfig:            parseBigInt("100"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
					},
					SellOrders: []*order{},
				}),
				TotalSupply: "",
			},
			args: args{
				tokenAmountIn: pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    parseBigInt("300"),
					AmountUsd: 0,
				},
				tokenOut: "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
			},
			want: &pool.CalcAmountOutResult{
				TokenAmountOut: &pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    parseBigInt("500"),
					AmountUsd: 0,
				},
				Fee: &pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    big.NewInt(0),
					AmountUsd: 0,
				},
				Gas: 136616,
				SwapInfo: SwapInfo{
					AmountIn: "300",
					SwapSide: Buy,
					FilledOrders: []*FilledOrderInfo{
						{
							OrderID:              1383,
							FilledTakingAmount:   "200",
							FilledMakingAmount:   "400",
							TakingAmount:         "200",
							MakingAmount:         "400",
							Salt:                 "185786982651412687203851465093295409688",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							FeeConfig:            "100",
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							Signature:            "signature1",
							FeeAmount:            "0",
						},
						{
							OrderID:            1382,
							FilledTakingAmount: "100",
							FilledMakingAmount: "100",
							TakingAmount:       "300",
							MakingAmount:       "300",
							Salt:               "185786982651412687203851465093295409688",
							Signature:          "signature2",
							TakerAsset:         "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:         "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:              "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:           "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							FeeConfig:          "100",
							FeeRecipient:       "0x0000000000000000000000000000000000000000",
							AllowedSenders:     "0x0000000000000000000000000000000000000000",
							MakerAssetData:     "",
							TakerAssetData:     "",
							GetMakerAmount:     "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:     "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:          "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:             "",
							Interaction:        "",
							FeeAmount:          "0",
						},
					},
				},
			},
			err: nil,
		},
		{
			name: "Should return correct CalcAmountOutResult when swapSide is SELL(strings.ToLower(tokeIn) > strings.ToLower(TokenOut))",
			poolEntity: entity.Pool{
				Address:      "pool_limit_order_",
				ReserveUsd:   1000000000,
				AmplifiedTvl: 0,
				SwapFee:      0,
				Exchange:     "kyberswap_limit-order",
				Type:         "limit-order",
				Timestamp:    0,
				Reserves:     []string{"10000000000000000000", "10000000000000000000"},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
						Name:      "USDT",
						Symbol:    "USDT",
						Decimals:  6,
						Swappable: true,
					},
					{
						Address:   "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
						Name:      "USDC",
						Symbol:    "USDC",
						Decimals:  6,
						Swappable: true,
					},
				},
				Extra: marshalPoolExtra(&Extra{
					SellOrders: []*order{
						{
							ID:                   1383,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature1",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("992000"),
							MakingAmount:         parseBigInt("1000000"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1382,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature2",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("1010000"),
							MakingAmount:         parseBigInt("1000000"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
					},
					BuyOrders: []*order{},
				}),
				TotalSupply: "",
			},
			args: args{
				tokenAmountIn: pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    parseBigInt("1210000"),
					AmountUsd: 0,
				},
				tokenOut: "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
			},
			want: &pool.CalcAmountOutResult{
				TokenAmountOut: &pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    parseBigInt("1215841"),
					AmountUsd: 0,
				},
				Fee: &pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    big.NewInt(0),
					AmountUsd: 0,
				},
				Gas: 136616,
				SwapInfo: SwapInfo{
					AmountIn: "1210000",
					SwapSide: Sell,
					FilledOrders: []*FilledOrderInfo{
						{
							OrderID:              1383,
							FilledTakingAmount:   "992000",
							FilledMakingAmount:   "1000000",
							TakingAmount:         "992000",
							MakingAmount:         "1000000",
							Salt:                 "185786982651412687203851465093295409688",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							Signature:            "signature1",
							FeeAmount:            "0",
						},
						{
							OrderID:            1382,
							FilledTakingAmount: "218000",
							FilledMakingAmount: "215841",
							TakingAmount:       "1010000",
							MakingAmount:       "1000000",
							Salt:               "185786982651412687203851465093295409688",
							Signature:          "signature2",
							TakerAsset:         "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:         "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:              "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:           "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							FeeRecipient:       "0x0000000000000000000000000000000000000000",
							AllowedSenders:     "0x0000000000000000000000000000000000000000",
							MakerAssetData:     "",
							TakerAssetData:     "",
							GetMakerAmount:     "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:     "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:          "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:             "",
							Interaction:        "",
							FeeAmount:          "0",
						},
					},
				},
			},
			err: nil,
		},
		{
			name: "Should return correct CalcAmountOutResult when swapSide is BUY(strings.ToLower(tokeIn) <= strings.ToLower(TokenOut)) and orders has MakerTokenFeePercent",
			poolEntity: entity.Pool{
				Address:      "pool_limit_order_",
				ReserveUsd:   1000000000,
				AmplifiedTvl: 0,
				SwapFee:      0,
				Exchange:     "kyberswap_limit-order",
				Type:         "limit-order",
				Timestamp:    0,
				Reserves:     []string{"10000000000000000000", "10000000000000000000"},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
						Name:      "USDT",
						Symbol:    "USDT",
						Decimals:  6,
						Swappable: true,
					},
					{
						Address:   "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
						Name:      "USDC",
						Symbol:    "USDC",
						Decimals:  6,
						Swappable: true,
					},
				},
				Extra: marshalPoolExtra(&Extra{
					BuyOrders: []*order{
						{
							ID:                   1383,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature1",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("200"),
							MakingAmount:         parseBigInt("400"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 100,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1382,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature2",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("300"),
							MakingAmount:         parseBigInt("300"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
					},
					SellOrders: []*order{},
				}),
				TotalSupply: "",
			},
			args: args{
				tokenAmountIn: pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    parseBigInt("300"),
					AmountUsd: 0,
				},
				tokenOut: "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
			},
			want: &pool.CalcAmountOutResult{
				TokenAmountOut: &pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    parseBigInt("496"),
					AmountUsd: 0,
				},
				Fee: &pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    big.NewInt(4),
					AmountUsd: 0,
				},
				Gas: 136616,
				SwapInfo: SwapInfo{
					AmountIn: "300",
					SwapSide: Buy,
					FilledOrders: []*FilledOrderInfo{
						{
							OrderID:              1383,
							FilledTakingAmount:   "200",
							FilledMakingAmount:   "400",
							TakingAmount:         "200",
							MakingAmount:         "400",
							Salt:                 "185786982651412687203851465093295409688",
							TakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							MakerTokenFeePercent: 100,
							MakerAssetData:       "",
							TakerAssetData:       "",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							Signature:            "signature1",
							FeeAmount:            "4",
						},
						{
							OrderID:            1382,
							FilledTakingAmount: "100",
							FilledMakingAmount: "100",
							TakingAmount:       "300",
							MakingAmount:       "300",
							Salt:               "185786982651412687203851465093295409688",
							Signature:          "signature2",
							TakerAsset:         "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							MakerAsset:         "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							Maker:              "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:           "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							FeeRecipient:       "0x0000000000000000000000000000000000000000",
							AllowedSenders:     "0x0000000000000000000000000000000000000000",
							MakerAssetData:     "",
							TakerAssetData:     "",
							GetMakerAmount:     "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:     "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:          "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:             "",
							Interaction:        "",
							FeeAmount:          "0",
						},
					},
				},
			},
			err: nil,
		},
		{
			name: "Should return correct CalcAmountOutResult and list orders(include fallback orders) when swapSide is SELL(strings.ToLower(tokeIn) > strings.ToLower(TokenOut))",
			poolEntity: entity.Pool{
				Address:      "pool_limit_order_",
				ReserveUsd:   1000000000,
				AmplifiedTvl: 0,
				SwapFee:      0,
				Exchange:     "kyberswap_limit-order",
				Type:         "limit-order",
				Timestamp:    0,
				Reserves:     []string{"10000000000000000000", "10000000000000000000"},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
						Name:      "USDT",
						Symbol:    "USDT",
						Decimals:  6,
						Swappable: true,
					},
					{
						Address:   "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
						Name:      "USDC",
						Symbol:    "USDC",
						Decimals:  6,
						Swappable: true,
					},
				},
				Extra: marshalPoolExtra(&Extra{
					SellOrders: []*order{
						{
							ID:                   1383,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature1",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("700"),
							MakingAmount:         parseBigInt("1400"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1382,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature2",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("240"),
							MakingAmount:         parseBigInt("250"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1385,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature4",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("200"),
							MakingAmount:         parseBigInt("300"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1389,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature5",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("100"),
							MakingAmount:         parseBigInt("100"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
					},
					BuyOrders: []*order{},
				}),
				TotalSupply: "",
			},
			args: args{
				tokenAmountIn: pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    parseBigInt("700"),
					AmountUsd: 0,
				},
				tokenOut: "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
			},
			want: &pool.CalcAmountOutResult{
				TokenAmountOut: &pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    parseBigInt("1400"),
					AmountUsd: 0,
				},
				Fee: &pool.TokenAmount{
					Token:     "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
					Amount:    big.NewInt(0),
					AmountUsd: 0,
				},
				Gas: 159924,
				SwapInfo: SwapInfo{
					AmountIn: "700",
					SwapSide: Sell,
					FilledOrders: []*FilledOrderInfo{
						{
							OrderID:              1383,
							FilledTakingAmount:   "700",
							FilledMakingAmount:   "1400",
							TakingAmount:         "700",
							MakingAmount:         "1400",
							Salt:                 "185786982651412687203851465093295409688",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							Signature:            "signature1",
							FeeAmount:            "0",
						},
						{
							OrderID:            1382,
							FilledTakingAmount: "0",
							FilledMakingAmount: "0",
							TakingAmount:       "240",
							MakingAmount:       "250",
							Salt:               "185786982651412687203851465093295409688",
							Signature:          "signature2",
							TakerAsset:         "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:         "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:              "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:           "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							FeeRecipient:       "0x0000000000000000000000000000000000000000",
							AllowedSenders:     "0x0000000000000000000000000000000000000000",
							MakerAssetData:     "",
							TakerAssetData:     "",
							GetMakerAmount:     "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:     "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:          "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:             "",
							Interaction:        "",
							FeeAmount:          "0",
							IsFallBack:         true,
						},
						{
							OrderID:              1385,
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature4",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         "200",
							MakingAmount:         "300",
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   "0",
							FilledTakingAmount:   "0",
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							IsFallBack:           true,
							FeeAmount:            "0",
						},
					},
				},
			},
			err: nil,
		},
		{
			name: "Should return correct error(ErrCannotFulfillAmountIn) when cannot fulfill amountIn buy the orders",
			poolEntity: entity.Pool{
				Address:      "pool_limit_order_",
				ReserveUsd:   1000000000,
				AmplifiedTvl: 0,
				SwapFee:      0,
				Exchange:     "kyberswap_limit-order",
				Type:         "limit-order",
				Timestamp:    0,
				Reserves:     []string{"10000000000000000000", "10000000000000000000"},
				Tokens: []*entity.PoolToken{
					{
						Address:   "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
						Name:      "USDT",
						Symbol:    "USDT",
						Decimals:  6,
						Swappable: true,
					},
					{
						Address:   "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
						Name:      "USDC",
						Symbol:    "USDC",
						Decimals:  6,
						Swappable: true,
					},
				},
				Extra: marshalPoolExtra(&Extra{
					SellOrders: []*order{
						{
							ID:                   1383,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature1",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("992000"),
							MakingAmount:         parseBigInt("1000000"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
						{
							ID:                   1382,
							ChainID:              "5",
							Salt:                 "185786982651412687203851465093295409688",
							Signature:            "signature2",
							TakerAsset:           "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
							MakerAsset:           "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
							Maker:                "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							Receiver:             "0xa246ec8bf7f2e54cc2f7bfdd869302ae4a08a590",
							AllowedSenders:       "0x0000000000000000000000000000000000000000",
							TakingAmount:         parseBigInt("1010000"),
							MakingAmount:         parseBigInt("1000000"),
							FeeRecipient:         "0x0000000000000000000000000000000000000000",
							FilledMakingAmount:   parseBigInt("0"),
							FilledTakingAmount:   parseBigInt("0"),
							MakerTokenFeePercent: 0,
							MakerAssetData:       "",
							TakerAssetData:       "",
							GetMakerAmount:       "f4a215c3000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							GetTakerAmount:       "296637bf000000000000000000000000000000000000000000000001d7d843dc3b4800000000000000000000000000000000000000000000000000000de0b6b3a7640000",
							Predicate:            "961d5b1e000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000020000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000002892e28b58ab329741f27fd1ea56dca0192a38840000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044cf6fc6e3000000000000000000000000a246ec8bf7f2e54cc2f7bfdd869302ae4a08a590000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002463592c2b0000000000000000000000000000000000000000000000000000000063c1169800000000000000000000000000000000000000000000000000000000",
							Permit:               "",
							Interaction:          "",
							ExpiredAt:            0,
						},
					},
					BuyOrders: []*order{},
				}),
				TotalSupply: "",
			},
			args: args{
				tokenAmountIn: pool.TokenAmount{
					Token:     "0xc2132d05d31c914a87c6611c10748aeb04b58e8f",
					Amount:    parseBigInt("121000000"),
					AmountUsd: 0,
				},
				tokenOut: "0x2791bca1f2de4661ed88a30c99a7a9449aa84174",
			},
			want: nil,
			err:  ErrCannotFulfillAmountIn,
		},
	}
	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			p, err := NewPoolSimulator(tt.poolEntity)
			assert.Equal(t, nil, err)
			got, err := testutil.MustConcurrentSafe[*pool.CalcAmountOutResult](t, func() (any, error) {
				limit := swaplimit.NewInventory("", p.CalculateLimit())
				return p.CalcAmountOut(
					pool.CalcAmountOutParams{
						TokenAmountIn: tt.args.tokenAmountIn,
						TokenOut:      tt.args.tokenOut,
						Limit:         limit,
					})
			})
			assert.Equal(t, tt.err, err)
			assert.Equal(t, tt.want, got)
		})
	}
}

func parseBigInt(value string) *big.Int {
	bigIntValue, _ := new(big.Int).SetString(value, 10)
	return bigIntValue
}

func marshalPoolExtra(extra *Extra) string {
	bytesData, _ := json.Marshal(extra)
	return string(bytesData)
}

func TestPool_CalcAmountOut_v2(t *testing.T) {
	type testorder struct {
		id               int64
		makingAmount     string
		takingAmount     string
		avaiMakingAmount string
	}

	pools := map[string][]testorder{
		"pool1": {
			{1001, "100", "1000", "100"},
			{1002, "100", "2000", "50"},
		},
		"pool2": {
			{1001, "100", "1000", "100"},
			{1002, "100", "2000", "50"},
			{1003, "100", "2000", "100"},
		},
		"pool3": {
			{1001, "39", "777000000000000000000", "39"},
		},
		"pool4": {
			{1001, "39", "777000000000000000000", "39"},
			{1002, "390000", "777000000000000000", "390000"},
		},
	}

	testcases := []struct {
		name         string
		pool         string
		amountIn     string
		expAmountOut string
		expOrderIds  []int64
	}{
		{"fully fill 1st order", "pool1", "100", "10", []int64{1001}},
		{"f-fill 1st order, p-fill 2nd one", "pool1", "1100", "105", []int64{1001, 1002}},
		{"f-fill both orders", "pool1", "2000", "150", []int64{1001, 1002}}, // reach 1002's avaiFillAmount (50)
		{"cannot be filled", "pool1", "2001", "", nil},                      // cannot exceed 1002's avaiFillAmount (50)

		{"f-fill 1st order, p-fill 2nd one", "pool2", "1100", "105", []int64{1001, 1002}},
		{"f-fill 1st/2nd order", "pool2", "2000", "150", []int64{1001, 1002, 1003}}, // include 1003 with fill=0 as fallback
		{"f-fill 1st/2nd order, p-fill 3rd one", "pool2", "2100", "155", []int64{1001, 1002, 1003}},
		{"f-fill all order", "pool2", "4000", "250", []int64{1001, 1002, 1003}},
		{"cannot be filled", "pool1", "4001", "", nil},

		{"cannot be filled (too small, round to 0)", "pool3", "5874584652643", "", nil},

		{"skip 1st order (too small, round to 0) and use 2nd one", "pool4", "5874584652643", "2", []int64{1002}},
	}

	sims := lo.MapValues(pools, func(orders []testorder, _ string) *PoolSimulator {
		extra := Extra{
			BuyOrders: lo.Map(orders, func(o testorder, _ int) *order {
				return &order{
					ID:                    o.id,
					MakingAmount:          bignumber.NewBig10(o.makingAmount),
					TakingAmount:          bignumber.NewBig10(o.takingAmount),
					AvailableMakingAmount: bignumber.NewBig10(o.avaiMakingAmount),
					MakerBalanceAllowance: bignumber.NewBig10("100000000000000000000"),
				}
			}),
		}
		sExtra, _ := json.Marshal(extra)
		poolEnt := entity.Pool{
			Tokens:      []*entity.PoolToken{{Address: "A"}, {Address: "B"}},
			Reserves:    entity.PoolReserves{"0", "0"},
			StaticExtra: `{"ContractAddress":""}`,
			Extra:       string(sExtra),
		}
		p, err := NewPoolSimulator(poolEnt)
		require.Nil(t, err)
		return p
	})

	for _, tc := range testcases {
		t.Run(tc.name, func(t *testing.T) {
			limit := swaplimit.NewInventory("", sims[tc.pool].CalculateLimit())
			res, err := sims[tc.pool].CalcAmountOut(pool.CalcAmountOutParams{
				TokenAmountIn: pool.TokenAmount{
					Token:  "A",
					Amount: bignumber.NewBig10(tc.amountIn),
				},
				TokenOut: "B",
				Limit:    limit,
			})

			if tc.expOrderIds == nil {
				require.NotNil(t, err)
				return
			}

			require.Nil(t, err)

			assert.Equal(t, tc.expAmountOut, res.TokenAmountOut.Amount.String())

			si := res.SwapInfo.(SwapInfo)
			oid := make([]int64, 0, len(si.FilledOrders))
			oinfo := ""
			for _, o := range si.FilledOrders {
				if o.FilledTakingAmount == "" {
					break
				}
				oid = append(oid, o.OrderID)
				oinfo += fmt.Sprintf("order %v %v %v\n", o.OrderID, o.FilledMakingAmount, o.FilledTakingAmount)
			}
			assert.Equal(t, tc.expOrderIds, oid, oinfo)
			fmt.Println(oinfo)
		})
	}
}

func TestPool_UpdateBalance(t *testing.T) {
	type testorder struct {
		id               int64
		makingAmount     string
		takingAmount     string
		avaiMakingAmount string
	}

	type testswap struct {
		amountIn     string
		expAmountOut string
		expOrderIds  []int64
	}

	pools := map[string][]testorder{
		"pool1": {
			{1001, "100", "1000", "100"},
			{1002, "100", "2000", "50"},
		},
	}

	testcases := []struct {
		name string
		pool string

		swaps []testswap
	}{
		{"case 1", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"600", "", nil},                     // only 25 makingAmount left (500 takingAmount), so this swap will fail
		}},
		{"case 2", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"300", "15", []int64{1002}},         // still use 1002
			{"200", "10", []int64{1002}},         // still use 1002
		}},
	}

	var sims map[string]*PoolSimulator
	resetSim := func() {
		sims = lo.MapValues(pools, func(orders []testorder, _ string) *PoolSimulator {
			extra := Extra{
				BuyOrders: lo.Map(orders, func(o testorder, _ int) *order {
					return &order{
						ID:                    o.id,
						MakingAmount:          bignumber.NewBig10(o.makingAmount),
						TakingAmount:          bignumber.NewBig10(o.takingAmount),
						AvailableMakingAmount: bignumber.NewBig10(o.avaiMakingAmount),
						MakerBalanceAllowance: bignumber.NewBig10("100000000000000000000"),
						FilledMakingAmount:    big.NewInt(0),
						FilledTakingAmount:    big.NewInt(0),
					}
				}),
			}
			sExtra, _ := json.Marshal(extra)
			poolEnt := entity.Pool{
				Tokens:      []*entity.PoolToken{{Address: "A"}, {Address: "B"}},
				Reserves:    entity.PoolReserves{"0", "0"},
				StaticExtra: `{"ContractAddress":""}`,
				Extra:       string(sExtra),
			}
			p, err := NewPoolSimulator(poolEnt)
			require.Nil(t, err)
			return p
		})
	}

	for _, tc := range testcases {
		resetSim()
		limit := swaplimit.NewInventory("", sims[tc.pool].CalculateLimit())
		for i, swap := range tc.swaps {
			t.Run(fmt.Sprintf("%v swap %d", tc.name, i), func(t *testing.T) {
				cloned := sims[tc.pool].CloneState()
				calcAmountOutParams := pool.CalcAmountOutParams{
					TokenAmountIn: pool.TokenAmount{
						Token:  "A",
						Amount: bignumber.NewBig10(swap.amountIn),
					},
					TokenOut: "B",
					Limit:    limit,
				}
				res, err := sims[tc.pool].CalcAmountOut(calcAmountOutParams)

				if swap.expOrderIds == nil {
					require.NotNil(t, err)
					return
				}

				require.Nil(t, err)

				assert.Equal(t, swap.expAmountOut, res.TokenAmountOut.Amount.String())

				clonedRes, err := cloned.CalcAmountOut(calcAmountOutParams)
				require.Nil(t, err)
				assert.Equal(t, res.TokenAmountOut, clonedRes.TokenAmountOut)

				si := res.SwapInfo.(SwapInfo)
				oid := make([]int64, 0, len(si.FilledOrders))
				oinfo := ""
				for _, o := range si.FilledOrders {
					if o.FilledTakingAmount == "" {
						break
					}
					oid = append(oid, o.OrderID)
					oinfo += fmt.Sprintf("order %v %v %v\n", o.OrderID, o.FilledMakingAmount, o.FilledTakingAmount)
				}
				assert.Equal(t, swap.expOrderIds, oid, oinfo)
				fmt.Println(oinfo)

				sims[tc.pool].UpdateBalance(pool.UpdateBalanceParams{
					TokenAmountIn: pool.TokenAmount{
						Token:  "A",
						Amount: bignumber.NewBig10(swap.amountIn),
					},
					TokenAmountOut: *res.TokenAmountOut,
					Fee:            *res.Fee,
					SwapInfo:       res.SwapInfo,
					SwapLimit:      limit,
				})

				clonedRes, err = cloned.CalcAmountOut(calcAmountOutParams)
				require.Nil(t, err)
				assert.Equal(t, res.TokenAmountOut, clonedRes.TokenAmountOut)
			})
		}
	}
}

func TestPool_Inventory(t *testing.T) {
	type testorder struct {
		id               int64
		maker            string
		makingAmount     string
		takingAmount     string
		avaiMakingAmount string
	}

	type testswap struct {
		amountIn     string
		expAmountOut string
		expOrderIds  []int64
	}

	pools := map[string][]testorder{
		"pool1": {
			{1001, "maker1", "100", "1000", "100"},
			{1002, "maker1", "100", "2000", "100"},
			{1003, "maker1", "100", "4000", "50"},
			{1004, "maker2", "100", "5000", "100"},
		},
	}

	makerBalances := map[string]*big.Int{
		"maker1": bignumber.NewBig10("250"),
		"maker2": bignumber.NewBig10("100"),
	}
	makerAssetBalance := map[makerAndAsset]*big.Int{
		NewMakerAndAsset("maker1", "B"): bignumber.NewBig10("150"), // maker1 original balance is 250, but 100 has been spent in previous paths (order with same makerAsset but different takerAsset)
		NewMakerAndAsset("maker2", "B"): bignumber.NewBig10("50"),  // same, maker2 has spent 50 already
	}

	testcases := []struct {
		name string
		pool string

		swaps []testswap
	}{
		{"case 1", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"500", "25", []int64{1002, 1004}},   // maker1 has 25 makingAmount left, so will fully filled the rest of 1002 (1004 included as backup instead of 1003 because 1003 is from maker1 who has no balance left)
			{"500", "10", []int64{1004}},         // only 1004 is available now
		}},

		{"case 2", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"600", "27", []int64{1002, 1004}},   // 500-25 from 1002 and 100-2 from 1004
		}},

		{"case 3", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"3000", "75", []int64{1002, 1004}},  // 500-25 from 1002 and 2500-50 from 1004 (fully filled)
		}},

		{"case 4", "pool1", []testswap{
			{"1000", "100", []int64{1001, 1002}}, // 1st swap full fill 1001 (1002 included as backup)
			{"500", "25", []int64{1002}},         // after update balance, 1001 has been fully used , can only use 1002
			{"3001", "", nil},                    // a bit larger than case 3 above, so no balance left and swap fail
		}},
	}

	var sims map[string]*PoolSimulator
	resetSim := func() {
		sims = lo.MapValues(pools, func(orders []testorder, _ string) *PoolSimulator {
			extra := Extra{
				BuyOrders: lo.Map(orders, func(o testorder, _ int) *order {
					return &order{
						ID:                    o.id,
						Maker:                 o.maker,
						MakerAsset:            "B",
						TakerAsset:            "A",
						MakingAmount:          bignumber.NewBig10(o.makingAmount),
						TakingAmount:          bignumber.NewBig10(o.takingAmount),
						AvailableMakingAmount: bignumber.NewBig10(o.avaiMakingAmount),
						MakerBalanceAllowance: makerBalances[o.maker],
						FilledMakingAmount:    big.NewInt(0),
						FilledTakingAmount:    big.NewInt(0),
					}
				}),
			}
			sExtra, _ := json.Marshal(extra)
			poolEnt := entity.Pool{
				Tokens:      []*entity.PoolToken{{Address: "A"}, {Address: "B"}},
				Reserves:    entity.PoolReserves{"0", "0"},
				StaticExtra: `{"ContractAddress":""}`,
				Extra:       string(sExtra),
			}
			p, err := NewPoolSimulator(poolEnt)
			require.Nil(t, err)
			// fake spent balance
			p.allMakersBalanceAllowance = makerAssetBalance
			return p
		})
	}

	for _, tc := range testcases {
		resetSim()
		limit := swaplimit.NewInventory("", sims[tc.pool].CalculateLimit())
		for i, swap := range tc.swaps {
			t.Run(fmt.Sprintf("%v swap %d", tc.name, i), func(t *testing.T) {
				res, err := sims[tc.pool].CalcAmountOut(pool.CalcAmountOutParams{
					TokenAmountIn: pool.TokenAmount{
						Token:  "A",
						Amount: bignumber.NewBig10(swap.amountIn),
					},
					TokenOut: "B",
					Limit:    limit,
				})

				if swap.expOrderIds == nil {
					require.NotNil(t, err)
					return
				}

				require.Nil(t, err)

				assert.Equal(t, swap.expAmountOut, res.TokenAmountOut.Amount.String())

				si := res.SwapInfo.(SwapInfo)
				oid := make([]int64, 0, len(si.FilledOrders))
				oinfo := ""
				for _, o := range si.FilledOrders {
					if o.FilledTakingAmount == "" {
						break
					}
					oid = append(oid, o.OrderID)
					oinfo += fmt.Sprintf("order %v %v %v\n", o.OrderID, o.FilledMakingAmount, o.FilledTakingAmount)
				}
				assert.Equal(t, swap.expOrderIds, oid, oinfo)
				fmt.Println(oinfo)

				sims[tc.pool].UpdateBalance(pool.UpdateBalanceParams{
					TokenAmountIn: pool.TokenAmount{
						Token:  "A",
						Amount: bignumber.NewBig10(swap.amountIn),
					},
					TokenAmountOut: *res.TokenAmountOut,
					Fee:            *res.Fee,
					SwapInfo:       res.SwapInfo,
					SwapLimit:      limit,
				})
			})
		}
	}
}

func TestPool_CalcAmountOut_TakerAssetFee(t *testing.T) {
	type testorder struct {
		id              int64
		makingAmount    string
		takingAmount    string
		feePct          uint32
		IsTakerAssetFee bool
	}

	pools := map[string][]testorder{
		"pool1": {
			{1001, "10000000", "12000000", 100, true},
			{1002, "10000000", "10000000", 100, true},
		},
		"pool2": { // mixed takerAssetFee and makerAssetFee
			{1001, "10000000", "12000000", 100, true},
			{1002, "10000000", "10000000", 100, false},
		},
		"pool3": { // test order on prerelease
			{1001, "10000000000000", "99522200853987088", 100, true},
		},
	}

	testcases := []struct {
		name         string
		pool         string
		amountIn     string
		expAmountOut string
		expOrderIds  []int64
	}{
		{"p-fill 1st order", "pool1", "10000000", "8250825", []int64{1001, 1002}},  // 1002 as backup
		{"p-fill 1st order", "pool1", "12000000", "9900990", []int64{1001, 1002}},  // 1002 as backup
		{"f-fill 1st order", "pool1", "12120000", "10000000", []int64{1001, 1002}}, // 1002 as backup
		{"f-fill 1st order, p-fill 2nd one", "pool1", "15000000", "12851485", []int64{1001, 1002}},
		{"f-fill both orders", "pool1", "22220000", "20000000", []int64{1001, 1002}},
		{"cannot be filled", "pool1", "22220003", "", nil}, // we expect 22220001 to not be filled, but due to fee rounding down it need 22220003

		{"p-fill 1st order", "pool2", "10000000", "8250825", []int64{1001, 1002}},  // 1002 as backup
		{"p-fill 1st order", "pool2", "12000000", "9900990", []int64{1001, 1002}},  // 1002 as backup
		{"f-fill 1st order", "pool2", "12120000", "10000000", []int64{1001, 1002}}, // 1002 as backup
		{"f-fill 1st order, p-fill 2nd one", "pool2", "15000000", "12851200", []int64{1001, 1002}},
		{"f-fill both orders", "pool2", "22120000", "19900000", []int64{1001, 1002}},
		{"cannot be filled", "pool2", "22120001", "", nil},

		// 49522200853987088 + 495222008539871
		{"p-fill 1st order", "pool3", "50017422862526959", "4975995348680", []int64{1001}},
	}

	sims := lo.MapValues(pools, func(orders []testorder, _ string) *PoolSimulator {
		extra := Extra{
			BuyOrders: lo.Map(orders, func(o testorder, _ int) *order {
				return &order{
					ID:                    o.id,
					MakingAmount:          bignumber.NewBig10(o.makingAmount),
					TakingAmount:          bignumber.NewBig10(o.takingAmount),
					AvailableMakingAmount: bignumber.NewBig10(o.makingAmount),
					MakerBalanceAllowance: bignumber.NewBig10("100000000000000000000"),
					MakerTokenFeePercent:  o.feePct,
					IsTakerAssetFee:       o.IsTakerAssetFee,
				}
			}),
		}
		sExtra, _ := json.Marshal(extra)
		poolEnt := entity.Pool{
			Tokens:      []*entity.PoolToken{{Address: "A"}, {Address: "B"}},
			Reserves:    entity.PoolReserves{"0", "0"},
			StaticExtra: `{"ContractAddress":""}`,
			Extra:       string(sExtra),
		}
		p, err := NewPoolSimulator(poolEnt)
		require.Nil(t, err)
		return p
	})

	for _, tc := range testcases {
		t.Run(tc.name, func(t *testing.T) {
			limit := swaplimit.NewInventory("", sims[tc.pool].CalculateLimit())
			res, err := sims[tc.pool].CalcAmountOut(pool.CalcAmountOutParams{
				TokenAmountIn: pool.TokenAmount{
					Token:  "A",
					Amount: bignumber.NewBig10(tc.amountIn),
				},
				TokenOut: "B",
				Limit:    limit,
			})

			if tc.expOrderIds == nil {
				require.NotNil(t, err)
				return
			}

			require.Nil(t, err)

			assert.Equal(t, tc.expAmountOut, res.TokenAmountOut.Amount.String())

			si := res.SwapInfo.(SwapInfo)
			oid := make([]int64, 0, len(si.FilledOrders))
			oinfo := ""
			for _, o := range si.FilledOrders {
				if o.FilledTakingAmount == "" {
					break
				}
				oid = append(oid, o.OrderID)
				oinfo += fmt.Sprintf("order %v %v %v\n", o.OrderID, o.FilledMakingAmount, o.FilledTakingAmount)
			}
			assert.Equal(t, tc.expOrderIds, oid, oinfo)
			fmt.Println(oinfo)
		})
	}
}
